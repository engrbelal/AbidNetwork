<!DOCTYPE html>
<html lang="bn">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Abid Network</title>
<!-- Favicon using logo.png -->
<link rel="icon" href="logo.png" type="image/png">
<link rel="apple-touch-icon" href="Logo.png">
  <style>
    :root {
      --primary-color: #4A5568;
      --secondary-color: #5A67D8;
      --accent-color: #805AD5;
      --background-color: #F7FAFC;
      --text-color: #2D3748;
      --header-gradient-start: #5A67D8;
      --header-gradient-end: #805AD5;
      --menu-bg: #2D3748;
      --menu-text-color: #E2E8F0;
      --menu-active-bg: #5A67D8;
      --card-bg: #FFFFFF;
      --button-bg: #5A67D8;
      --button-hover-bg: #434190;
      --delete-btn-bg: #E53E3E;
      --reset-btn-bg: #c53030;
      --shadow-color: rgba(0, 0, 0, 0.07);
      --paid-color: #38A169;
      --unpaid-color: #DD6B20;
      --advance-color: #3182CE;
      --free-color: #319795;
      --pending-color: #9F7AEA;
      --border-color: #E2E8F0;
    }

    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600&display=swap');

    body {
      font-family: 'Noto Sans Bengali', sans-serif;
      font-size: 14px;
      margin: 0;
      background-color: var(--background-color);
      color: var(--text-color);
      display: flex;
    }

    .sidebar {
      width: fit-content;
      background-color: var(--menu-bg);
      color: var(--menu-text-color);
      position: fixed;
      height: 100%;
      left: -220px;
      transition: left 0.3s ease-in-out;
      z-index: 1002;
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 5px var(--shadow-color);
    }

    .sidebar.active {
      left: 0;
    }

    .sidebar-header {
      padding: 12px 18px;
      text-align: center;
      background: linear-gradient(90deg, #1a202c, #2d3748);
      display: flex;
      align-items: center;
      gap: 10px;
      height: 40px;
    }

    .sidebar-title {
      color: white;
      font-weight: 500;
      font-size: 18px;
      margin: 0;
    }

    .sidebar-logo {
      color: #90cdf4;
    }

    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 18px 0;
      flex-grow: 1;
    }

    .sidebar-menu li a {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 18px;
      color: var(--menu-text-color);
      text-decoration: none;
      transition: all 0.2s;
      border-left: 4px solid transparent;
      font-size: 14px;
    }

    .sidebar-menu li a:hover {
      background-color: var(--primary-color);
      padding-left: 22px;
    }

    .sidebar-menu li a.active {
      background-color: var(--menu-active-bg);
      border-left: 4px solid white;
      font-weight: 600;
    }

    .main-content {
      margin-left: 0;
      width: 100%;
      transition: margin-left 0.3s ease-in-out;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .page-container {
      flex-grow: 1;
    }

    .page {
      display: none;
      padding: 12px;
    }

    .page.active {
      display: block;
    }

    .header {
      background: linear-gradient(90deg, var(--header-gradient-start), var(--header-gradient-end));
      padding: 4px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 999;
    }

    .header-right-placeholder {
    width: 40px;
    }

    .menu-toggle {
      font-size: 22px;
      cursor: pointer;
      background: none;
      border: none;
      color: white;
    }

    .header-title {
      font-size: 24px;
      font-weight: 600;
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .no-focus-outline,
    .no-focus-outline:hover,
    .no-focus-outline:focus,
    .no-focus-outline:active {
        outline: none !important;
        -webkit-tap-highlight-color: transparent !important; /* মোবাইল ব্রাউজারের জন্য */
        box-shadow: none !important;
    }

    .header-logo {
      font-size: 24px;
    }

    #page-title {
      font-size: 15px;
      color: white;
      font-weight: 500;
      text-align: right;
    }

    .card {
      background-color: var(--card-bg);
      border-radius: 8px;
      padding: 18px;
      margin-bottom: 18px;
      box-shadow: 0 4px 12px var(--shadow-color);
    }

    .card h2 {
      margin-top: 0;
      border-bottom: 2px solid var(--secondary-color);
      padding-bottom: 8px;
      color: var(--primary-color);
      font-size: 17px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .unpaid-count {
      font-size: 12px;
      color: var(--unpaid-color);
      font-weight: 500;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px 18px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group.hidden {
      display: none;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      font-size: 13px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #CBD5E0;
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 13px;
    }

    .form-group-checkbox {
      flex-direction: row;
      align-items: center;
    }

    .form-group-checkbox input {
      width: auto;
      margin-right: 8px;
      transform: scale(1.0);
    }

    .btn {
      padding: 8px 18px;
      border: none;
      border-radius: 5px;
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn:disabled {
        background-color: #A0AEC0 !important;
        color: #E2E8F0 !important;
        cursor: not-allowed;
        opacity: 0.7;
        transform: none !important;
        box-shadow: none !important;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-submit {
      background-color: var(--button-bg);
    }

    .btn-delete {
      background-color: var(--delete-btn-bg);
      padding: 5px 10px;
    }

    .table-container {
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
    }

    .data-table th,
    .data-table td {
      border: 1px solid #E2E8F0;
      padding: 7px 9px;
      text-align: left;
      white-space: nowrap;
    }

    .data-table th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
    }

    .data-table tr:nth-child(even) {
      background-color: #F7FAFC;
    }

    .data-table .customer-name-link {
      cursor: pointer;
      color: var(--secondary-color);
      font-weight: 600;
      text-decoration: underline;
    }

    .status-paid {
      color: var(--paid-color);
      font-weight: 600;
    }

    .status-unpaid {
      color: var(--unpaid-color);
      font-weight: 600;
    }

    .status-advance {
      color: var(--advance-color);
      font-weight: 600;
    }

    .status-free {
      color: var(--free-color);
      font-weight: 600;
    }

    .status-pending {
      color: var(--pending-color);
      font-weight: 600;
    }

    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1001;
      display: none;
    }

    .action-btn {
      padding: 4px 8px !important;
      font-size: 12px !important;
      margin-right: 4px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    .summary-item {
      background-color: #EDF2F7;
      padding: 12px;
      border-radius: 8px;
      border-left: 4px solid var(--secondary-color);
    }

    .summary-item h3 {
      margin: 0 0 6px 0;
      font-size: 13px;
      color: var(--primary-color);
    }

    .summary-item p {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .total-customer-summary {
      background: linear-gradient(90deg, #805AD5, #5A67D8);
      color: white;
      text-align: center;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 18px;
    }

    /* About Page Styles */
    .about-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .about-info-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px var(--shadow-color);
      border-left: 4px solid var(--secondary-color);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .about-info-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
    }

    .info-item {
      margin-bottom: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .info-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .info-item strong {
      color: var(--primary-color);
      display: inline-block;
      min-width: 120px;
    }

    .user-guide-section {
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow: hidden;
      transition: box-shadow 0.2s ease;
    }

    .user-guide-section:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .guide-header {
      background: var(--primary-color);
      color: white;
      padding: 15px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    .guide-header:hover {
      background: var(--secondary-color);
    }

    .guide-header:active {
      background: var(--accent-color);
    }

    .guide-content {
      padding: 0 20px;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease, padding 0.4s ease;
      background: var(--card-bg);
    }

    .guide-content.expanded {
      max-height: none;
      padding: 20px;
    }

    .guide-content h4 {
      color: var(--secondary-color);
      margin: 15px 0 8px 0;
      font-size: 16px;
      font-weight: 600;
    }

    .guide-content h4:first-child {
      margin-top: 0;
    }

    .guide-content p {
      margin: 8px 0;
      line-height: 1.6;
      color: var(--text-color);
    }

    .guide-content ul,
    .guide-content ol {
      margin: 10px 0;
      padding-left: 20px;
    }

    .guide-content li {
      margin: 6px 0;
      line-height: 1.5;
      color: var(--text-color);
    }

    .guide-content li strong {
      color: var(--primary-color);
    }

    .expand-icon {
      transition: transform 0.3s ease;
      font-size: 14px;
      font-weight: bold;
    }

    .expanded .expand-icon {
      transform: rotate(180deg);
    }

    #user-guide-btn {
      transition: all 0.3s ease;
    }

    #user-guide-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(90, 103, 216, 0.3);
    }

    /* Mobile Responsive for About Page */
    @media (max-width: 768px) {
      .about-info-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .about-info-card {
        padding: 15px;
      }

      .guide-header {
        padding: 12px 15px;
        font-size: 14px;
      }

      .guide-content.expanded {
        padding: 15px;
        max-height: none;
      }

      .info-item strong {
        min-width: 100px;
        font-size: 13px;
      }
    }

    @media (max-width: 480px) {
      .about-info-card h3 {
        font-size: 16px !important;
      }

      .guide-header span {
        font-size: 13px;
      }

      .guide-content h4 {
        font-size: 14px;
      }

      .info-item {
        padding: 6px 0;
      }
    }

    .total-customer-summary h2 {
      margin: 0;
      font-size: 17px;
    }

    .total-customer-summary p {
      margin: 4px 0 0;
      font-size: 22px;
      font-weight: bold;
    }

    .footer {
      text-align: center;
      padding: 10px;
      background-color: #2D3748;
      color: #A0AEC0;
      font-size: 11px;
      margin-top: auto;
      page-break-before: avoid;
      border-top: 1px solid #4A5568;
    }

    .dashboard-summary-grid {
      display: grid !important;
      grid-template-columns: repeat(2, 1fr) !important;
      gap: 12px !important;
      max-width: 500px !important;
      margin: 0 auto !important;
    }

    .dashboard-summary-grid .summary-item {
      background-color: #EDF2F7;
      padding: 12px;
      border-radius: 8px;
      border-left: 4px solid var(--secondary-color);
      text-align: center;
    }

    .dashboard-summary-card {
      background: #f8f9fa !important;
      border: 1px solid #dee2e6 !important;
      border-radius: 8px !important;
      padding: 15px !important;
      text-align: center !important;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
      border-left: 4px solid var(--secondary-color) !important;
      transition: transform 0.2s ease, box-shadow 0.2s ease !important;
    }

    .dashboard-summary-card:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
    }

    /* Thematic colors for dashboard cards */
    .dashboard-summary-card.total-customers {
      border-left: 4px solid #3182CE !important;
      background: linear-gradient(135deg, #EBF8FF 0%, #BEE3F8 100%) !important;
    }

    .dashboard-summary-card.total-bill {
      border-left: 4px solid #805AD5 !important;
      background: linear-gradient(135deg, #FAF5FF 0%, #E9D8FD 100%) !important;
    }

    .dashboard-summary-card.total-paid {
      border-left: 4px solid #38A169 !important;
      background: linear-gradient(135deg, #F0FFF4 0%, #C6F6D5 100%) !important;
    }

    .dashboard-summary-card.total-unpaid {
      border-left: 4px solid #DD6B20 !important;
      background: linear-gradient(135deg, #FFFAF0 0%, #FEEBC8 100%) !important;
    }

    .dashboard-summary-card h3 {
      font-size: 15px !important;
      margin: 0 0 8px 0 !important;
      color: #495057 !important;
    }

    .dashboard-summary-card p {
      font-size: 22px !important;
      font-weight: bold !important;
      margin: 0 !important;
      color: var(--primary-color) !important;
    }

    /* Activity Grid Styles */
    .activity-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      max-height: 400px;
      overflow-y: auto;
      padding: 5px;
    }

    .activity-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border-left: 4px solid var(--activity-color, #4A5568);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .activity-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .activity-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--activity-color, #4A5568), transparent);
      opacity: 0.3;
    }

    .activity-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .activity-icon {
      font-size: 18px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: rgba(74, 85, 104, 0.1);
    }

    .activity-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--primary-color);
      margin: 0;
      flex: 1;
    }

    .activity-time {
      font-size: 11px;
      color: #718096;
      background: #F7FAFC;
      padding: 2px 6px;
      border-radius: 10px;
    }

    .activity-description {
      font-size: 13px;
      color: #4A5568;
      margin: 8px 0 0 0;
      line-height: 1.4;
    }

    .activity-metadata {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .activity-tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 8px;
      background: #EDF2F7;
      color: #4A5568;
    }

    /* Activity type specific colors */
    .activity-card.customer-added {
      --activity-color: #38A169;
    }

    .activity-card.bill-created {
      --activity-color: #3182CE;
    }

    .activity-card.bill-paid {
      --activity-color: #38A169;
    }

    .activity-card.isp-payment {
      --activity-color: #805AD5;
    }

    .activity-card.router-added {
      --activity-color: #DD6B20;
    }

    .activity-card.advance-deposit {
      --activity-color: #319795;
    }

    .activity-card.due-adjustment {
      --activity-color: #E53E3E;
    }

    .activity-card.data-import {
      --activity-color: #3182CE;
    }

    .activity-card.data-backup {
      --activity-color: #4A5568;
    }

    .activity-card.location-added {
      --activity-color: #D69E2E;
    }

    .activity-card.report-generated {
      --activity-color: #805AD5;
    }

    .no-activities {
      text-align: center;
      padding: 40px 20px;
      color: #718096;
    }

    .no-activities p {
      margin: 0;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .dashboard-summary-grid {
        gap: 10px !important;
        max-width: 100% !important;
        margin: 0 !important;
      }

      .dashboard-summary-card {
        padding: 12px !important;
      }

      .dashboard-summary-card h3 {
        font-size: 13px !important;
      }

      .dashboard-summary-card p {
        font-size: 18px !important;
      }

      .profile-info-grid {
        grid-template-columns: repeat(1, 1fr);
        gap: 10px;
      }

      .profile-info-item {
        padding: 12px;
      }
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1003;
      padding: 15px;
      box-sizing: border-box;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal.active {
      display: flex;
      opacity: 1;
    }

    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      transform: scale(0.95);
      transition: transform 0.3s ease;
      max-height: 90vh;
      overflow-y: auto;
      /* Added for mobile responsiveness */
    }

    .modal.active .modal-content {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #E2E8F0;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }

    .modal-header h2 {
      font-size: 18px;
      margin: 0;
    }

    .modal-close {
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      background: none;
      border: none;
    }

    .modal-body p {
      margin: 0 0 10px 0;
      font-size: 14px;
    }

    .modal-body .form-group {
      margin-bottom: 15px;
    }

    .note-tags {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .note-tag {
      background-color: #E2E8F0;
      color: var(--primary-color);
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .note-tag:hover {
      background-color: #CBD5E0;
    }

    .adjustment-list {
      list-style: none;
      padding: 0;
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #E2E8F0;
      border-radius: 5px;
      margin-top: 15px;
    }

    .adjustment-list li {
      padding: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #E2E8F0;
    }

    .adjustment-list li:last-child {
      border-bottom: none;
    }

    .adjustment-info {
      font-size: 13px;
    }

    .location-list {
      list-style: none;
      padding: 0;
      margin-top: 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      max-height: 250px;
      overflow-y: auto;
    }

    .location-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .location-list li:last-child {
      border-bottom: none;
    }

    .location-list .location-name {
      font-weight: 500;
    }

    .location-list .actions button {
      font-size: 11px;
      padding: 4px 8px;
    }

    .router-form-container {
      display: none;
      padding-top: 20px;
    }

    .router-form-container.active {
      display: block;
    }

    .router-form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .router-form-grid .form-group.full-width {
      grid-column: 1 / -1;
    }

    .router-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 15px;
    }

    .router-item {
      background-color: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 4px 12px var(--shadow-color);
      padding: 15px 20px;
      display: flex;
      align-items: center;
      transition: transform 0.2s, box-shadow 0.2s, border-left-color 0.2s;
      border-left: 5px solid transparent;
    }

    .router-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      border-left: 5px solid var(--secondary-color);
    }

    .router-item-content {
      flex-grow: 1;
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .router-item-content img {
      width: 40px;
      height: 40px;
      margin-right: 20px;
    }

    .router-info {
      flex-grow: 1;
    }

    .router-info .name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-color);
    }

    .router-info .model {
      font-size: 13px;
      color: #718096;
      margin-top: 2px;
    }

    .router-info .customer-count {
      font-size: 12px;
      color: var(--paid-color);
      font-weight: 500;
      margin-top: 5px;
    }

    .router-delete-btn {
      background: none;
      border: none;
      color: #A0AEC0;
      font-size: 22px;
      font-weight: bold;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 50%;
      transition: color 0.2s, background-color 0.2s;
    }

    .router-delete-btn:hover {
      color: var(--delete-btn-bg);
      background-color: #FED7D7;
    }

    .access-btn {
      display: block;
      margin-top: 25px;
      padding: 12px;
      background-color: var(--secondary-color);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      transition: background-color 0.2s;
    }

    .access-btn:hover {
      background-color: #434190;
    }

    .page-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 18px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-box {
      flex-grow: 1;
      position: relative;
      max-width: 100%;
      /* Ensure it doesn't overflow on small screens */
    }

    .search-box input {
      width: 100%;
      padding: 8px 12px 8px 35px;
      border: 1px solid #CBD5E0;
      border-radius: 5px;
      font-size: 14px;
      box-sizing: border-box;
      /* Include padding and border in the element's total width and height */
    }

    .search-box::before {
      content: '🔍';
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #A0AEC0;
    }

    .filter-buttons {
      display: flex;
      gap: 10px;
    }

    .filter-btn {
      background-color: #EDF2F7;
      color: var(--text-color);
      border: 1px solid #E2E8F0;
    }

    .filter-btn.active {
      background-color: var(--secondary-color);
      color: white;
      border-color: var(--secondary-color);
    }

    .profile-modal-body {
      max-height: 80vh;
      overflow-y: auto;
      padding: 5px 15px 5px 5px;
    }

    .profile-header {
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .profile-header h3 {
      margin: 0 0 5px 0;
      font-size: 24px;
      color: var(--primary-color);
    }

    .profile-header p {
      margin: 0;
      color: #718096;
      font-size: 13px;
    }

    .profile-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .profile-info-item {
      background: var(--card-bg);
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 12px var(--shadow-color);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      font-size: 12px;
    }

    .profile-info-item strong {
      color: var(--primary-color);
      margin-bottom: 3px;
      font-size: 11px;
    }

    .profile-info-item span {
      font-weight: 600;
      color: var(--text-color);
      font-size: 13px;
    }

    .router-item {
      position: relative;
      padding: 15px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
    }

    @media (max-width: 768px) {
      .summary-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }

      .summary-item {
        padding: 15px;
      }

      .summary-item h3 {
        font-size: 14px;
      }

      .summary-item p {
        font-size: 18px;
      }
    }

    #profile-financial-status-item span {
      padding: 4px 10px;
      border-radius: 15px;
      color: white;
    }

    .profile-section-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-color);
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 8px;
      margin-top: 25px;
      margin-bottom: 15px;
    }

    .profile-billing-history {
      list-style: none;
      padding: 0;
    }

    .profile-billing-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 10px;
      border-radius: 6px;
      margin-bottom: 8px;
      background-color: #EDF2F7;
      transition: background-color 0.2s;
    }

    .profile-billing-item:hover {
      background-color: #E2E8F0;
    }

    .profile-billing-item .month {
      font-weight: 600;
    }

    .profile-billing-item .amount {
      font-size: 15px;
    }

    @media (max-width: 768px) {
      .sidebar {
        left: -220px;
      }

      .sidebar.active {
        left: 0;
      }

      .main-content {
        margin-left: 0;
      }
    }

    @media (max-width: 600px) {
      .router-form-grid {
        grid-template-columns: 1fr;
      }

      .page-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }

      .filter-buttons {
        justify-content: center;
      }

      .profile-header h3 {
        font-size: 20px;
      }

      .profile-info-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .page {
        padding: 8px;
      }

      .card {
        padding: 15px;
      }

      .router-form-container {
        padding: 10px;
      }

      .router-form-grid {
        gap: 10px;
      }

      .form-group {
        margin-bottom: 10px;
      }
    }

    /* Status styles for partially paid bills */
    .status-partially-paid {
      color: var(--pending-color);
      font-weight: 600;
    }

    /* নতুন সিম্পল প্রোফাইল বাটনের জন্য স্টাইল */
    .simple-status-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 14px;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 80px;
      /* একটি নির্দিষ্ট প্রস্থ */
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .simple-status-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    .simple-status-btn svg {
      width: 16px;
      height: 16px;
    }

    /* সক্রিয় বাটনের রঙ (সবুজ) */
    .btn-is-active {
      background-color: #28a745;
      color: white;
    }

    /* নিষ্ক্রিয় বাটনের রঙ (লাল) */
    .btn-is-inactive {
      background-color: #E53E3E;
      color: white;
    }

    .profile-window {
      background-color: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 380px;
      padding: 25px;
    }

    .profile-header {
      text-align: center;
      margin-bottom: 25px;
    }

    .profile-header h2 {
      font-size: 22px;
      font-weight: 600;
      color: #333;
      margin: 0;
    }

    .profile-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .profile-info-item {
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      -webkit-tap-highlight-color: transparent;
    }

    .profile-info-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      background-color: #ffffff;
    }

    .profile-info-item:active {
      transform: translateY(0);
      background-color: #e9ecef;
    }

    .profile-info-item strong {
      color: #6c757d;
      font-size: 11px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .profile-info-item span {
      color: #212529;
      font-size: 13px;
      font-weight: 600;
    }

    .full-width-item {
      grid-column: 1 / -1;
    }

    .icon {
      font-size: 14px;
    }

    .billing-history-section {
      margin-top: 25px;
      border-top: 1px solid #e9ecef;
      padding-top: 20px;
    }

    .billing-history-section h3 {
      font-size: 16px;
      font-weight: 600;
      color: #343a40;
      margin: 0 0 15px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .billing-history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .billing-history-item {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 8px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 4px solid;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      -webkit-tap-highlight-color: transparent;
    }

    .billing-history-item:hover {
      transform: scale(1.03);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      background-color: #ffffff;
    }

    .billing-history-item:active {
      transform: scale(0.98);
      background-color: #e9ecef;
    }

    .item-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .item-info .month {
      font-weight: 600;
      font-size: 14px;
      color: #495057;
    }

    .item-info .details {
      font-size: 11px;
      color: #6c757d;
    }

    .item-status {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .item-status .status {
      font-weight: 600;
      font-size: 12px;
    }

    .item-status .due {
      font-size: 11px;
      font-weight: 600;
      color: #dc3545;
    }

    .status-paid {
      color: #28a745;
      border-color: #28a745;
    }

    .status-unpaid {
      color: #dc3545;
      border-color: #dc3545;
    }

    .status-partially-paid {
      color: #ffc107;
      border-color: #ffc107;
    }

    .status-partially-paid .status {
      color: #b58900;
    }
/* --- Final and Updated Router Profile Window Styles --- */
    .router-profile-window {
        background-color: white;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 380px;
        padding: 25px;
        box-sizing: border-box;
        position: relative;
    }
    .router-profile-header {
        text-align: center;
        margin-bottom: 25px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
    }
    .router-profile-header h2 {
        font-size: 22px;
        font-weight: 700;
        color: var(--primary-color);
        margin: 0;
    }
    .router-profile-window .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 24px;
        font-weight: bold;
        color: #A0AEC0;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .router-profile-window .close-btn:hover {
        color: #E53E3E;
        transform: scale(1.1);
    }
    .router-info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 25px;
    }
    .router-info-item {
        background-color: var(--bg-light, #F7FAFC);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        cursor: pointer; /* Makes it look clickable */
        transition: all 0.2s ease-in-out; /* Smooth transition for all changes */
        -webkit-tap-highlight-color: transparent; /* Removes the default blue tap highlight on mobile */
    }
    .router-info-item:hover {
        transform: translateY(-3px); /* Lifts the box up slightly on hover */
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); /* Adds a subtle shadow */
        background-color: #ffffff; /* Changes background to white */
    }
    .router-info-item:active {
        transform: translateY(0); /* Returns the box to its original position on click */
        background-color: #e9ecef; /* Gives a pressed-down look */
    }
    .router-info-item strong {
        color: #6c757d;
        font-size: 11px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .router-info-item span {
        color: var(--text-color);
        font-size: 13px;
        font-weight: 600;
        word-break: break-all;
    }
    .router-info-item.full-width-item {
        grid-column: 1 / -1;
    }
    .router-info-item .icon {
        font-size: 14px;
        color: var(--secondary-color);
    }
    .router-action-buttons {
        display: flex;
        gap: 12px;
    }
    .router-action-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .router-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }
    .router-action-btn.btn-access {
        background-color: var(--secondary-color);
        color: white;
    }
    .router-action-btn.btn-edit {
        background-color: var(--bg-light, #F7FAFC);
        color: var(--primary-color);
        border: 1px solid var(--border-color);
    }

/* FINAL, COMPLETE & FULLY UPDATED CSS FOR PAYMENT MODAL */
/* --- Main Modal Overlay --- */
  .payment-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1004;
      padding: 15px;
      box-sizing: border-box;
      opacity: 0;
      transition: opacity 0.3s ease;
  }
  .payment-modal.active {
      display: flex;
      opacity: 1;
  }
  
  /* --- Hide the Original, Unused Modal Content Wrapper --- */
  .payment-modal .payment-modal-content {
      display: none !important;
  }
  
  /* --- The Main Window Design (action-window) --- */
  .payment-modal .action-window {
      background-color: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      width: calc(100% - 20px); /* Responsive width with padding */
      max-width: 400px; /* Compact and clean max-width */
      box-sizing: border-box;
      max-height: 90vh; /* Vertical fit for all screens */
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transform: scale(0.95);
      transition: transform 0.3s ease;
  }
  .payment-modal.active .action-window {
      transform: scale(1);
  }
  
  /* --- Window Header --- */
  .payment-modal .window-header {
      text-align: center;
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color, #E2E8F0);
      flex-shrink: 0;
  }
  .payment-modal .window-header h2 {
      font-size: 18px;
      font-weight: 600;
      color: var(--primary-color, #4A5568);
      margin: 0;
  }
  .payment-modal .payment-modal-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: none;
      border: none;
      font-size: 24px;
      font-weight: bold;
      color: #A0AEC0;
      cursor: pointer;
      padding: 5px;
      z-index: 10;
  }
  
  /* --- Scrollable Window Body --- */
  .payment-modal .window-body {
      padding: 20px;
      overflow-y: auto;
      flex-grow: 1;
  }
  
  /* --- Bill Info Box --- */
  .payment-modal .bill-info-box {
      background-color: var(--bg-light, #F7FAFC);
      border: 1px solid var(--border-color, #E2E8F0);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 13px;
  }
  .payment-modal .bill-info-box .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center; /* Vertically align items */
      padding: 4px 0;
  }
  .payment-modal .bill-info-box .info-row:not(:last-child) {
      border-bottom: 1px dashed #ddd;
  }
  .payment-modal .bill-info-box .info-row span:first-child { color: #718096; }
  .payment-modal .bill-info-box .info-row span:last-child { font-weight: 600; }
  
  /* --- ★★★ NEW & FINAL STYLE FOR DISCOUNT TEXT ★★★ --- */
  .payment-modal .discount-text {
      font-size: 11px;
      font-weight: 500;
      color: #DD6B20;
      margin-left: 5px;
  }
  
  /* --- Form Elements --- */
  .payment-modal .form-group { margin-bottom: 15px; }
  .payment-modal .form-group:last-child { margin-bottom: 0; }
  .payment-modal .form-group > label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 13px;
      color: var(--primary-color, #4A5568);
      display: flex;
      align-items: center;
      gap: 6px;
  }
  
  /* --- Inline Form Groups (The Key to the Layout) --- */
  .payment-modal .form-group-inline {
      display: flex;
      gap: 8px;
      align-items: center;
      background-color: var(--bg-light, #F7FAFC); /* The crucial background color */
      border-radius: 8px;
      padding: 8px;
      flex-wrap: nowrap;
  }
  .payment-modal .form-group-inline label {
      margin-bottom: 0;
      font-size: 12px;
      color: #718096;
      flex-shrink: 0;
      white-space: nowrap;
  }
  .payment-modal .form-group-inline input {
      width: 100%;
      flex-grow: 1;
      padding: 8px;
      font-size: 13px;
      border: 1px solid var(--border-color, #E2E8F0);
      border-radius: 6px;
      box-sizing: border-box;
  }
  .payment-modal .form-group-inline .btn {
      padding: 8px 14px;
      font-size: 12px;
      background-color: var(--unpaid-color, #DD6B20);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      flex-shrink: 0;
  }
  
  /* --- Payment History Section --- */
  .payment-modal .history-section {
      border: 1px solid var(--border-color, #E2E8F0);
      border-radius: 8px;
      padding: 10px;
      background-color: var(--bg-light, #F7FAFC);
      max-height: 150px;
      overflow-y: auto;
  }
  
  /* --- Sticky Footer with Buttons --- */
  .payment-modal .window-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      padding: 15px 20px;
      border-top: 1px solid var(--border-color, #E2E8F0);
      background-color: white;
      flex-shrink: 0;
  }
  .payment-modal .action-btn-modal {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
  }
  .payment-modal .btn-submit-modal {
      background-color: var(--secondary-color, #5A67D8);
      color: white;
  }
  .payment-modal .payment-btn-cancel {
      background-color: #E2E8F0;
      color: var(--primary-color, #4A5568);
  }
  .data-table .customer-name-link {
      color: inherit;
      text-decoration: none;
  }
  
  .data-table .customer-name-link:hover {
      text-decoration: underline;
      color: var(--secondary-color);
  }
  /* Selective Backup Modal Styles (নতুন CSS কোড) */
  .backup-options-container {
      display: flex;
      flex-direction: column;
      gap: 0;
      margin-top: 15px;
      background-color: #fdfdff;
      padding: 10px;
      border: 1px solid #f0f0f0;
      border-radius: 8px;
  }
  
  .backup-option {
      display: grid;
      grid-template-columns: auto 1fr;
      align-items: start;
      gap: 0 12px;
      padding: 10px 5px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
  }
  
  .backup-options-container > .backup-option:last-child {
      border-bottom: none;
  }
  
  .backup-option input[type="checkbox"],
  .backup-option input[type="radio"] {
      grid-row: 1 / 3;
      grid-column: 1 / 2;
      width: 17px;
      height: 17px;
      margin-top: 2px;
      cursor: pointer;
  }
  
  .backup-option .option-label {
      grid-column: 2 / 3;
      text-align: left;
      color: #333;
      font-weight: 500;
      font-size: 14px;
      line-height: 1.2;
  }
  
  .backup-option .option-count {
      grid-column: 2 / 3;
      margin-top: 4px;
      font-size: 10px;
      font-weight: 500;
      color: #a0a0a0;
  }
  
  .import-method-container .backup-option {
      border-bottom: none;
      padding: 4px 0;
  }
  
  .import-method-container .backup-option .option-label {
      font-size: 13px;
  }
  /* মডালের জন্য অতিরিক্ত স্টাইল */
  .modal-content {
      transition: transform 0.3s ease, opacity 0.3s ease;
  }
  .modal.active .modal-content {
      transform: scale(1);
      opacity: 1;
  }
  .modal .modal-content {
      transform: scale(0.9);
      opacity: 0;
  }
  </style>
</head>

<body>
  <div id="overlay"></div>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img id="sidebar-company-logo" src="logo.png" alt="" style="height: 28px; margin-right: 8px; display: none;">
      <h2 class="sidebar-title" id="sidebar-company-name">মেনু</h2>
    </div>
    <ul class="sidebar-menu">
      <li><a href="#" class="menu-item active" data-page="dashboard"><svg xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
          </svg><span>ড্যাশবোর্ড</span></a></li>
      <li><a href="#" class="menu-item" data-page="add_customer"><svg xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path
              d="M8 12a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm0 3c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4zm10-9V7h-2v3h-3v2h3v3h2v-3h3v-2h-3z" />
          </svg><span>গ্রাহক যোগ</span></a></li>
      <li><a href="#" class="menu-item" data-page="customers"><svg xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path
              d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
          </svg><span>গ্রাহক তালিকা</span></a></li>
      <li><a href="#" class="menu-item" data-page="billing"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
            width="20" height="20" fill="currentColor">
            <path
              d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z" />
          </svg><span>বিল ব্যবস্থাপনা</span></a></li>
      <li><a href="#" class="menu-item" data-page="isp_bill"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
            width="20" height="20" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z" />
          </svg><span>আইএসপি বিল</span></a></li>
      <li><a href="#" class="menu-item" data-page="reports"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
            width="20" height="20" fill="currentColor">
            <path
              d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
          </svg><span>রিপোর্ট</span></a></li>
      <li><a href="#" class="menu-item" data-page="advance"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
            width="20" height="20" fill="currentColor">
            <path d="M12.01 21.49L23.64 7c-.45-.34-4.93-4-11.64-4C5.28 3 .81 6.66.36 7l11.63 14.49.01.01.01-.01z" />
          </svg><span>রাউটার</span></a></li>
      <li><a href="#" class="menu-item" data-page="settings"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
            width="20" height="20" fill="currentColor">
            <path
              d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23-.09.49 0 .61.22l2-3.46c.12-.22.07.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z" />
          </svg><span>সেটিংস</span></a></li>
      <li><a href="#" class="menu-item" data-page="about"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
            width="20" height="20" fill="currentColor">
            <path
              d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
          </svg><span>About</span></a></li>
    </ul>
  </div>

  <div class="main-content" id="main-content">
    <header class="header">
        <button class="menu-toggle" id="menu-toggle">☰</button>
    
        <div class="header-center">
            <a href="#" id="home-link" class="no-focus-outline" style="text-decoration: none; color: inherit;">
                <h1 class="header-title">
                    <img id="header-company-logo" src="logo.png" alt="" style="height: 36px; margin-right: 8px;">
                    <span id="header-company-name">Abid Network</span>
                </h1>
            </a>
        </div>
    
        <div class="header-right-placeholder"></div>
    </header>

    <div class="page-container">
      <main class="page active" id="dashboard">
        <div class="card">
          <h2>চলতি মাসের সারাংশ</h2>
            <div id="dashboard-summary" class="dashboard-summary-grid">
  <div class="dashboard-summary-card total-customers">
    <h3>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor" style="vertical-align: middle; margin-right: 5px;">
        <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"></path>
      </svg>
      মোট গ্রাহক
    </h3>
    <p id="db-total-customers">0</p>
  </div>
  <div class="dashboard-summary-card total-bill">
    <h3>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor" style="vertical-align: middle; margin-right: 5px;">
        <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"></path>
      </svg>
      মোট বিল
    </h3>
    <p id="db-total-bill">৳0</p>
  </div>
  <div class="dashboard-summary-card total-paid">
    <h3>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor" style="vertical-align: middle; margin-right: 5px;">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path>
      </svg>
      মোট আয়
    </h3>
    <p id="db-total-paid">৳0</p>
  </div>
  <div class="dashboard-summary-card total-unpaid">
    <h3>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor" style="vertical-align: middle; margin-right: 5px;">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"></path>
      </svg>
      মোট বকেয়া
    </h3>
    <p id="db-total-unpaid">৳0</p>
  </div>
</div>
        </div>
        <!-- ★★★ নতুন বিল রিমাইন্ডার বক্সের কোড (এখানে যোগ করুন) ★★★ -->
        <div id="bill-reminder-notification"
          style="display: none; background: linear-gradient(135deg, #FFF3CD 0%, #FCE4EC 100%); border: 1px solid #F0AD4E; border-radius: 6px; padding: 10px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <div style="display: flex; align-items: center; gap: 8px;">
            <!-- আইকন -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="#E53E3E"
              style="flex-shrink: 0;">
              <path
                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" />
            </svg>
            <!-- লেখা -->
            <div id="bill-reminder-content-wrapper" style="flex-grow: 1;">
              <!-- রিমাইন্ডারের লেখা এখানে স্বয়ংক্রিয়ভাবে আসবে -->
            </div>
            <!-- বাটন -->
            <button id="view-due-bills-btn" class="btn btn-delete"
              style="font-size: 11px; padding: 4px 8px; flex-shrink: 0;">তালিকা দেখুন</button>
          </div>
        </div>

        <!-- Dashboard Backup Notification -->
        <div id="dashboard-backup-reminder-notification"
          style="display: none; background: linear-gradient(135deg, #FFF3CD 0%, #FCE4EC 100%); border: 1px solid #F0AD4E; border-radius: 6px; padding: 10px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <div style="display: flex; align-items: center; gap: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="#F57C00"
              style="flex-shrink: 0;">
              <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
            </svg>
            <div style="flex-grow: 1;">
              <h4 style="margin: 0 0 3px 0; color: #E65100; font-size: 13px; font-weight: 600;">ডেটা ব্যাকআপ সুপারিশ
              </h4>
              <p style="margin: 0; color: #BF360C; font-size: 11px; line-height: 1.3;">আপনি সম্প্রতি নতুন ডেটা যোগ
                করেছেন। নিরাপত্তার জন্য ডেটা ব্যাকআপ নেওয়ার সুপারিশ করা হচ্ছে।</p>
            </div>
            <button onclick="hideDashboardBackupReminder()"
              style="background: none; border: none; color: #E65100; font-size: 16px; cursor: pointer; padding: 3px; line-height: 1;">×</button>
          </div>
        </div>

        <div class="card">
          <h2 style="display: flex; justify-content: space-between; align-items: center;">
            <span>সাম্প্রতিক কার্যক্রম</span>
            <button id="clear-activity-log-btn" class="btn btn-delete" style="font-size: 12px; padding: 5px 10px;">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="currentColor"
                style="vertical-align: middle; margin-right: 4px;">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
              </svg>
              লগ মুছুন
            </button>
          </h2>
          <div id="recent-activities" class="activity-grid">
            <!-- Activities will be dynamically loaded here -->
          </div>
          <div id="no-activities" class="no-activities" style="display: none;">
            <p>কোনো সাম্প্রতিক কার্যক্রম পাওয়া যায়নি।</p>
          </div><!-- নতুন কোড শুরু -->
          <div id="activity-loader" style="text-align: center; margin-top: 20px; display: none;">
            <button class="btn btn-submit" id="load-more-activities-btn">আরো দেখুন</button>
          </div>
          <!-- নতুন কোড শেষ -->
        </div>
      </main>

      <main class="page" id="add_customer">
        <div class="card" id="customer-form-card">
          <h2 id="customer-form-title">নতুন গ্রাহক যোগ করুন</h2>
          <form id="customerForm">
            <input type="hidden" id="customerId">
            <div class="form-grid">
              <div class="form-group"><label for="customerName">গ্রাহকের নাম</label><input type="text" id="customerName"
                  required></div>
              <div class="form-group"><label for="customerPhone">ফোন নম্বর (ঐচ্ছিক)</label><input type="tel"
                  id="customerPhone"inputmode="tel"></div>
              <div class="form-group"><label for="customerHouse">বাড়ি</label><select id="customerHouse"
                  required></select></div>
              <div class="form-group"><label for="customerBill">মাসিক বিল</label><select id="customerBill"
                  required></select></div>
              <div class="form-group hidden" id="customBillGroup"><label for="customBillAmount">নিজের বিল
                  বসান</label><input type="number" id="customBillAmount" placeholder="টাকার পরিমাণ"></div>
              <div class="form-group"><label for="connectionDate">সংযোগের তারিখ</label><input type="date"
                  id="connectionDate" required></div>
              <div class="form-group form-group-checkbox" style="align-self: center;"><input type="checkbox"
                  id="isFreeUser"><label for="isFreeUser">ফ্রি ইউজার?</label></div>
            </div>
            <div class="form-group" style="margin-top: 15px;">
              <label for="macAddress">MAC অ্যাড্রেস (ঐচ্ছিক)</label>
              <!-- নতুন কোড (এখানে বসান) -->
              <div class="mac-input-container" id="customerMacContainer"></div>

            </div>
            <div style="text-align: right; margin-top: 18px;">
              <button type="button" class="btn btn-delete" id="customer-cancel-btn"
                style="display: none; margin-right: 10px;">বাতিল করুন</button>
              <button type="submit" class="btn btn-submit" id="customer-submit-btn">গ্রাহক যোগ করুন</button>
            </div>
          </form>
        </div>
      </main>
      <main class="page" id="customers">
        <div class="total-customer-summary">
          <h2>সর্বমোট গ্রাহক</h2>
          <p id="total-customer-count">0</p>
        </div>
        <div class="page-controls">
          <div class="search-box">
            <input type="text" id="customer-search-input" placeholder="গ্রাহকের নাম বা ফোন দিয়ে খুঁজুন...">
          </div>
        </div>

        <div id="customer-list-by-house"></div>
      </main>

      <main class="page" id="billing">
        <div class="card">
          <h2>বিল প্রস্তুত করুন</h2>
          <div class="form-grid" style="align-items: flex-end;">
            <div class="form-group"><label for="generateMonth">মাস</label><select id="generateMonth"></select></div>
            <div class="form-group"><label for="generateYear">বছর</label><select id="generateYear"></select></div>
            <div class="form-group"><label for="generateForCustomer">নির্দিষ্ট গ্রাহক (ঐচ্ছিক)</label><select
                id="generateForCustomer"></select></div>
            <div style="display: flex; gap: 10px;">
              <button id="generateBillsBtn" class="btn btn-submit">বিল তৈরি করুন</button>
              <button id="delete-month-bills-btn" class="btn btn-delete">সব মুছুন</button>
            </div>
          </div>
        </div>
        <div class="page-controls">
          <div class="search-box">
            <input type="text" id="billing-search-input" placeholder="গ্রাহকের নাম দিয়ে খুঁজুন...">
          </div>
           <div class="filter-buttons">
                        <button class="btn filter-btn active" data-filter="all">সকল বিল</button>
                        <button class="btn filter-btn" data-filter="unpaid">শুধু বকেয়া</button>
                    </div>
        </div>
        <div id="billing-list-by-house"></div>
      </main>

      <main class="page" id="isp_bill">
        <div class="card">
          <h2>আইএসপি বিল পরিশোধ করুন</h2>
          <form id="ispBillForm">
            <div class="form-grid">
              <div class="form-group"><label for="ispMonth">মাস</label><select id="ispMonth"></select></div>
              <div class="form-group"><label for="ispYear">বছর</label><select id="ispYear"></select></div>
              <div class="form-group"><label for="ispAmount">টাকার পরিমাণ</label><input type="number" id="ispAmount"
                  value="900" required></div>
              <div class="form-group"><label for="ispPayDate">পরিশোধের তারিখ</label><input type="date" id="ispPayDate"
                  required></div>
            </div>
            <div style="text-align: right; margin-top: 18px;"><button type="submit" class="btn btn-submit">বিল পরিশোধ
                করুন</button></div>
          </form>
        </div>
        <div class="card">
          <h2>পরিশোধ করা বিলের ইতিহাস <button id="delete-all-isp-history-btn" class="btn btn-delete"
              style="font-size: 11px; padding: 4px 8px; float: right;">সব মুছুন</button></h2>
          <div class="table-container">
            <table class="data-table" id="ispHistoryTable">
              <thead>
                <tr>
                  <th>মাস/বছর</th>
                  <th>পরিমাণ</th>
                  <th>পরিশোধের তারিখ</th>
                  <th>একশন</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </main>

      <main class="page" id="reports">
        <div class="card">
          <h2>নেটওয়ার্ক রিপোর্ট</h2>
          <div class="form-grid" style="margin-bottom: 18px;">
            <div class="form-group"><label for="reportMonth">মাস</label><select id="reportMonth"></select></div>
            <div class="form-group"><label for="reportYear">বছর</label><select id="reportYear"></select></div>
            <div class="form-group" style="display: flex; align-items: end;">
              <button class="btn btn-submit" id="printReportPdfBtn"
                style="background-color: #E53E3E; color: white; font-size: 14px; padding: 10px 20px;">
                📄 পিডিএফ প্রিন্ট করুন
              </button>
            </div>
            <div class="form-group">
              <label for="customerBillingHistorySelect">গ্রাহকের বিলিং ইতিহাস ডাউনলোড করুন</label>
              <select id="customerBillingHistorySelect"></select>
            </div>
            <div class="form-group" style="display: flex; align-items: end;">
              <button class="btn btn-submit" id="downloadCustomerBillingHistoryBtn"
                style="background-color: #3182CE; color: white; font-size: 14px; padding: 10px 20px;">
                ডাউনলোড করুন
              </button>
            </div>
          </div>
          <hr>
          <div id="report-summary-total" style="margin-bottom: 25px;">
            <h3>মাসিক সারাংশ</h3>
            <div class="summary-grid" id="report-summary-grid">
              <!-- পুরনো কার্ডগুলো -->
              <div class="summary-item">
                <h3>মোট আয়</h3>
                <p id="total-revenue">৳0</p>
              </div>
              <div class="summary-item">
                <h3>মোট বকেয়া</h3>
                <p id="total-dues">৳0</p>
              </div>
          
              <!-- ★★★ নতুন শর্তযুক্ত কার্ড দুটি এখানে যোগ করা হয়েছে ★★★ -->
              <div class="summary-item" id="total-discount-card" style="display: none; border-color: #F59E0B;">
                <h3>মোট ছাড়</h3>
                <p id="total-discount">৳0</p>
              </div>
              <div class="summary-item" id="total-advance-card" style="display: none; border-color: #10B981;">
                <h3>নতুন অগ্রিম</h3>
                <p id="total-advance">৳0</p>
              </div>
          
              <!-- পুরনো কার্ডগুলো -->
              <div class="summary-item" style="border-color: var(--delete-btn-bg);">
                <h3>আইএসপি বিল</h3>
                <p id="isp-paid-amount">৳0</p>
              </div>
              <div class="summary-item" style="border-color: var(--paid-color);">
                <h3>নিট আয়</h3>
                <p id="net-income">৳0</p>
              </div>
            </div>
          </div>
          <div id="report-summary-by-house">
            <h3>বাড়ি ভিত্তিক রিপোর্ট</h3>
            <div id="house-reports-container" class="summary-grid"></div>
          </div>
        </div>
      </main>

      <main class="page" id="advance">
        <div class="card">
          <h2>রাউটার ম্যানেজমেন্ট</h2>
          <button class="btn btn-submit" id="toggleRouterFormBtn" style="margin-bottom: 15px;">নতুন রাউটার যোগ
            করুন</button>
          <div class="router-form-container" id="routerFormContainer">
            <form id="routerForm">
              <input type="hidden" id="routerId">
              <div class="router-form-grid">
                <div class="form-group"><label for="routerName">রাউটারের নাম</label><input type="text" id="routerName"
                    required></div>
                <div class="form-group"><label for="routerModel">মডেল</label><input type="text" id="routerModel"
                    required></div>
                <div class="form-group"><label for="routerIp">আইপি অ্যাড্রেস</label><input type="text" id="routerIp"
                    required></div>
                <div class="form-group">
                  <label for="routerMacAddress">ম্যাক অ্যাড্রেস</label>
                  <!-- নতুন কোড (রাউটার ফর্মের জন্য) -->
                  <div class="mac-input-container" id="routerMacContainer"></div>

                </div>
                <div class="form-group">
                  <label for="routerDistanceFeet">মেইন রাউটার থেকে দূরত্ব (ফিট)</label>
                  <input type="number" id="routerDistanceFeet" placeholder="ফিটে দূরত্ব লিখুন">
                  <small style="color: #666; font-size: 12px;">স্বয়ংক্রিয়ভাবে মিটারে রূপান্তরিত হবে</small>
                </div>
                <div class="form-group">
                  <label for="routerDistanceMeters">দূরত্ব (মিটার)</label>
                  <input type="number" id="routerDistanceMeters" step="0.01" readonly>
                </div>
                <div class="form-group"><label for="routerPowerSpec">পাওয়ার স্পেসিফিকেশন</label><input type="text"
                    id="routerPowerSpec" placeholder="যেমন: 12V 1.5A"></div>
                <div class="form-group"><label for="routerPassword">রাউটার পাসওয়ার্ড</label><input type="text"
                    id="routerPassword" placeholder="রাউটারের পাসওয়ার্ড"></div>
                <div class="form-group"><label for="routerImage">রাউটারের ছবি</label><input type="file" id="routerImage"
                    accept="image/*"><small style="color: #666; font-size: 12px;">ঐচ্ছিক: রাউটারের ছবি আপলোড
                    করুন</small></div>
                <div class="form-group full-width"><label for="routerLocationSelect">লোকেশন</label><select
                    id="routerLocationSelect" required></select></div>
              </div>
              <div style="text-align: right; margin-top: 15px;"><button type="submit" class="btn btn-submit">রাউটার যোগ
                  করুন</button></div>
            </form>
          </div>
          <div class="router-list" id="router-list"></div>
        </div>
      </main>
      <main class="page" id="settings">
        <div class="card">
          <h2>ওয়েবসাইট কাস্টমাইজেশন</h2>
          <div class="form-grid" style="margin-bottom: 20px;">
            <div class="form-group">
              <label for="websiteName">ওয়েবসাইটের নাম</label>
              <input type="text" id="websiteName" placeholder="Abid Network" class="form-control">
              <button class="btn btn-submit" id="updateWebsiteNameBtn"
                style="margin-top: 8px; font-size: 12px; padding: 6px 12px;">নাম আপডেট করুন</button>
            </div>
            <div class="form-group">
              <label for="websiteLogo">ওয়েবসাইটের লোগো</label>
              <input type="file" id="websiteLogo" accept="image/*" class="form-control">
              <button class="btn btn-submit" id="updateWebsiteLogoBtn"
                style="margin-top: 8px; font-size: 12px; padding: 6px 12px;">লোগো আপডেট করুন</button>
              <small style="color: #666; font-size: 12px; display: block; margin-top: 4px;">সুপারিশ: 40x40 পিক্সেল বা
                তার কাছাকাছি সাইজের ছবি ব্যবহার করুন</small>
            </div>
          </div>
          <hr style="margin: 20px 0;">
        </div>
        <div class="card">
          <h2>লোকেশন ম্যানেজমেন্ট</h2>
          <form id="locationForm" style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="newLocationName" placeholder="নতুন বাড়ির নাম লিখুন" class="form-control"
              style="flex-grow: 1; padding: 8px; border: 1px solid #CBD5E0; border-radius: 5px;" required>
            <button type="submit" class="btn btn-submit">যোগ করুন</button>
          </form>
          <ul class="location-list" id="locationList"></ul>
        </div>
        <div class="card">
          <h2>ডেটা ম্যানেজমেন্ট</h2>
          <div id="backup-reminder-notification"
            style="display: none; background: linear-gradient(135deg, #FFF3CD 0%, #FCE4EC 100%); border: 1px solid #F0AD4E; border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <div style="display: flex; align-items: center; gap: 12px;">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="#F57C00"
                style="flex-shrink: 0;">
                <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
              </svg>
              <div style="flex-grow: 1;">
                <h4 style="margin: 0 0 5px 0; color: #E65100; font-size: 16px;">ডেটা ব্যাকআপ সুপারিশ</h4>
                <p style="margin: 0; color: #BF360C; font-size: 14px;">আপনি সম্প্রতি নতুন ডেটা যোগ করেছেন। নিরাপত্তার
                  জন্য ডেটা ব্যাকআপ নেওয়ার সুপারিশ করা হচ্ছে।</p>
              </div>
              <button onclick="hideBackupReminder()"
                style="background: none; border: none; color: #E65100; font-size: 18px; cursor: pointer; padding: 5px;">×</button>
            </div>
          </div>
          <p>এখান থেকে আপনি আপনার সকল ডেটার ব্যাকআপ নিতে (এক্সপোর্ট) এবং পুনরুদ্ধার (ইমপোর্ট) করতে পারবেন।</p>
          <div
            style="background: #F8F9FA; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #17A2B8;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="#17A2B8">
                <path
                  d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
              </svg>
              <strong style="color: #17A2B8; font-size: 14px;">শেষ ব্যাকআপ তথ্য</strong>
            </div>
            <div style="color: #495057; font-size: 14px;">
              <strong>শেষ এক্সপোর্ট:</strong> <span id="last-export-date">কখনো নেওয়া হয়নি</span>
            </div>
          </div>
          <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
            <button id="export-data-btn" class="btn btn-submit">ডেটা এক্সপোর্ট করুন (JSON)</button>
            <input type="file" id="import-file-input" accept=".json" style="display: none;">
            <button id="import-data-btn" class="btn btn-submit" style="background-color: #2B6CB0;">ডেটা ইমপোর্ট
              করুন</button>
          </div>
          <div class="settings-section" style="margin-top: 30px;">
            <h2>অ্যাপ রিসেট</h2>
            <p>সতর্কতা: এই কাজটি আপনার সকল সংরক্ষিত ডেটা স্থায়ীভাবে মুছে ফেলবে। এই কাজটি ফেরানো যাবে না।</p>
            <button id="reset-app-btn" class="btn" style="background-color: var(--reset-btn-bg);">সম্পূর্ণ অ্যাপ রিসেট
              করুন</button>
          </div>
        </div>
      </main>

      <main class="page" id="about">
        <div class="card">
          <h2>সিস্টেম তথ্য</h2>
          <div class="about-info-grid">
            <div class="about-info-card">
              <h3 style="margin: 0 0 15px 0; color: var(--secondary-color); font-size: 18px;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor"
                  style="vertical-align: middle; margin-right: 8px;">
                  <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
                </svg>
                সংস্করণ তথ্য
              </h3>
              <div class="info-item">
                <strong>সংস্করণ:</strong> <span id="system-version">v4.2.0</span>
              </div>
              <div class="info-item">
                <strong>শেষ আপডেট:</strong> <span id="last-update-date">২৪ জুলাই ২০২৫</span>
              </div>
              <div class="info-item">
                <strong>বিল্ড:</strong> <span>Stable Release</span>
              </div>
              <div class="info-item" style="margin-top: 15px;">
                <button class="changelog-btn" onclick="showChangeLog()"
                  style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; width: 100%; justify-content: center;">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"
                    fill="currentColor">
                    <path
                      d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z" />
                  </svg>
                  Change Log
                </button>
              </div>
            </div>

            <div class="about-info-card">
              <h3 style="margin: 0 0 15px 0; color: var(--secondary-color); font-size: 18px;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor"
                  style="vertical-align: middle; margin-right: 8px;">
                  <path
                    d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" />
                </svg>
                যোগাযোগ
              </h3>
              <div class="info-item">
                <strong>ইমেইল:</strong> <span>engr.mdbelal@gmail.com</span>
              </div>
              <div class="info-item">
                <strong>ফোন:</strong> <span>০১৬৩৩৩৬৫৪৩৭</span>
              </div>
              <div class="info-item">
                <strong>ওয়েবসাইট:</strong> <span>www.abidnetwork.com</span>
              </div>
            </div>

            <div class="about-info-card">
              <h3 style="margin: 0 0 15px 0; color: var(--secondary-color); font-size: 18px;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor"
                  style="vertical-align: middle; margin-right: 8px;">
                  <path
                    d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                </svg>
                ডেভলপমেন্ট টিম
              </h3>
              <div class="info-item">
                <strong>প্রধান ডেভলপার:</strong> <span>Abid Network Team</span>
              </div>
              <div class="info-item">
                <strong>প্রযুক্তি:</strong> <span>HTML5, CSS3, JavaScript</span>
              </div>
              <div class="info-item">
                <strong>লাইসেন্স:</strong> <span>Proprietary Software</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2 style="display: flex; align-items: center; justify-content: space-between;">
            <span>ইউজার গাইড</span>
            <button class="btn btn-submit" id="user-guide-btn" style="font-size: 14px; padding: 8px 16px;">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor"
                style="vertical-align: middle; margin-right: 5px;">
                <path
                  d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
              </svg>
              সম্পূর্ণ গাইড দেখুন
            </button>
          </h2>

          <div id="user-guide-container" style="display: none;">
            <div class="user-guide-section">
              <div class="guide-header" onclick="toggleGuideSection('dashboard-guide')">
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"
                    style="vertical-align: middle; margin-right: 8px;">
                    <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                  </svg>
                  ড্যাশবোর্ড
                </span>
                <span class="expand-icon">▼</span>
              </div>
              <div class="guide-content" id="dashboard-guide">
                <h4>উদ্দেশ্য:</h4>
                <p>সিস্টেমের সামগ্রিক অবস্থা এক নজরে দেখার জন্য ড্যাশবোর্ড ব্যবহার করা হয়।</p>

                <h4>ফিচার সমূহ:</h4>
                <ul>
                  <li><strong>মোট গ্রাহক:</strong> সিস্টেমে নিবন্ধিত সকল গ্রাহকের সংখ্যা</li>
                  <li><strong>মোট বিল:</strong> চলতি মাসের সকল বিলের মোট পরিমাণ</li>
                  <li><strong>মোট আয়:</strong> চলতি মাসে পরিশোধিত বিলের পরিমাণ</li>
                  <li><strong>মোট বকেয়া:</strong> চলতি মাসের অপরিশোধিত বিলের পরিমাণ</li>
                </ul>

                <h4>ব্যবহার:</h4>
                <p>লগইনের পর স্বয়ংক্রিয়ভাবে ড্যাশবোর্ড দেখা যায়। এখানে চলতি মাসের সকল গুরুত্বপূর্ণ তথ্য একসাথে
                  প্রদর্শিত হয়।</p>
              </div>
            </div>

            <div class="user-guide-section">
              <div class="guide-header" onclick="toggleGuideSection('add-customer-guide')">
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"
                    style="vertical-align: middle; margin-right: 8px;">
                    <path
                      d="M8 12a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zm0 3c-2.67 0-8 1.34-8 4v3h16v-3c0-2.66-5.33-4-8-4zm10-9V7h-2v3h-3v2h3v3h2v-3h3v-2h-3z" />
                  </svg>
                  গ্রাহক যোগ
                </span>
                <span class="expand-icon">▼</span>
              </div>
              <div class="guide-content" id="add-customer-guide">
                <h4>উদ্দেশ্য:</h4>
                <p>নতুন গ্রাহক সিস্টেমে যোগ করা এবং বিদ্যমান গ্রাহকের তথ্য আপডেট করা।</p>

                <h4>প্রয়োজনীয় তথ্য:</h4>
                <ul>
                  <li><strong>গ্রাহকের নাম:</strong> পূর্ণ নাম (আবশ্যক)</li>
                  <li><strong>বাড়ি:</strong> গ্রাহকের লোকেশন নির্বাচন (আবশ্যক)</li>
                  <li><strong>মাসিক বিল:</strong> নির্ধারিত বিল বা কাস্টম পরিমাণ (আবশ্যক)</li>
                  <li><strong>সংযোগের তারিখ:</strong> ইন্টারনেট সংযোগের তারিখ (আবশ্যক)</li>
                </ul>

                <h4>ঐচ্ছিক তথ্য:</h4>
                <ul>
                  <li><strong>ফোন নম্বর:</strong> যোগাযোগের জন্য</li>
                  <li><strong>MAC অ্যাড্রেস:</strong> ডিভাইস শনাক্তকরণের জন্য</li>
                  <li><strong>ফ্রি ইউজার:</strong> বিনামূল্যে সেবা প্রদানের জন্য</li>
                </ul>

                <h4>বিশেষ ফিচার:</h4>
                <p><strong>MAC অ্যাড্রেস ইনপুট:</strong> ৬টি আলাদা ফিল্ডে MAC অ্যাড্রেস লিখুন। স্বয়ংক্রিয়ভাবে পরবর্তী
                  ফিল্ডে চলে যাবে।</p>
              </div>
            </div>

            <div class="user-guide-section">
              <div class="guide-header" onclick="toggleGuideSection('customer-list-guide')">
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"
                    style="vertical-align: middle; margin-right: 8px;">
                    <path
                      d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                  </svg>
                  গ্রাহক তালিকা
                </span>
                <span class="expand-icon">▼</span>
              </div>
              <div class="guide-content" id="customer-list-guide">
                <h4>উদ্দেশ্য:</h4>
                <p>সকল গ্রাহকের তালিকা দেখা, খোঁজা এবং ম্যানেজ করা।</p>

                <h4>ফিচার সমূহ:</h4>
                <ul>
                  <li><strong>বাড়ি অনুযায়ী গ্রুপিং:</strong> প্রতিটি লোকেশনের গ্রাহকরা আলাদা টেবিলে</li>
                  <li><strong>সার্চ ফাংশন:</strong> নাম বা ফোন নম্বর দিয়ে খোঁজা</li>
                  <li><strong>স্ট্যাটাস দেখা:</strong> Paid, Unpaid, Advance, Free</li>
                  <li><strong>গ্রাহক প্রোফাইল:</strong> নামে ক্লিক করে বিস্তারিত দেখা</li>
                </ul>

                <h4>একশন বাটন:</h4>
                <ul>
                  <li><strong>Edit:</strong> গ্রাহকের তথ্য সম্পাদনা</li>
                  <li><strong>Del:</strong> গ্রাহক মুছে ফেলা (সতর্কতার সাথে)</li>
                </ul>

                <h4>স্ট্যাটাস বর্ণনা:</h4>
                <ul>
                  <li><strong>Paid (সবুজ):</strong> চলতি মাসের বিল পরিশোধিত</li>
                  <li><strong>Unpaid (কমলা):</strong> বিল বকেয়া রয়েছে</li>
                  <li><strong>Advance (নীল):</strong> অগ্রিম পেমেন্ট রয়েছে</li>
                  <li><strong>Free (টিল):</strong> বিনামূল্যে সেবা</li>
                </ul>
              </div>
            </div>

            <div class="user-guide-section">
              <div class="guide-header" onclick="toggleGuideSection('billing-guide')">
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"
                    style="vertical-align: middle; margin-right: 8px;">
                    <path
                      d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z" />
                  </svg>
                  বিল ব্যবস্থাপনা
                </span>
                <span class="expand-icon">▼</span>
              </div>
              <div class="guide-content" id="billing-guide">
                <h4>উদ্দেশ্য:</h4>
                <p>মাসিক বিল তৈরি, পেমেন্ট স্ট্যাটাস আপডেট এবং অ্যাডজাস্টমেন্ট করা।</p>

                <h4>বিল তৈরির প্রক্রিয়া:</h4>
                <ol>
                  <li>মাস এবং বছর নির্বাচন করুন</li>
                  <li>নির্দিষ্ট গ্রাহক বা সকল গ্রাহক নির্বাচন করুন</li>
                  <li>"বিল তৈরি করুন" বাটনে ক্লিক করুন</li>
                  <li>স্বয়ংক্রিয়ভাবে পূর্বের বকেয়া যোগ হবে</li>
                </ol>

                <h4>পেমেন্ট ম্যানেজমেন্ট:</h4>
                <ul>
                  <li><strong>Paid/Unpaid বাটন:</strong> পেমেন্ট স্ট্যাটাস টগল করুন</li>
                  <li><strong>Adjust বাটন:</strong> বকেয়া বা অ্যাডভান্স যোগ করুন</li>
                  <li><strong>Del বাটন:</strong> বিল মুছে ফেলুন</li>
                </ul>

                <h4>অ্যাডজাস্টমেন্ট সিস্টেম:</h4>
                <ul>
                  <li><strong>বকেয়া যোগ:</strong> অতিরিক্ত চার্জ বা পূর্বের বকেয়া</li>
                  <li><strong>অ্যাডভান্স জমা:</strong> অগ্রিম পেমেন্ট রেকর্ড</li>
                  <li><strong>নোট সিস্টেম:</strong> কারণ উল্লেখ করুন</li>
                </ul>

                <h4>ফিল্টার অপশন:</h4>
                <ul>
                  <li><strong>সকল বিল:</strong> সব বিল দেখুন</li>
                  <li><strong>শুধু বকেয়া:</strong> অপরিশোধিত বিল দেখুন</li>
                </ul>
              </div>
            </div>

            <div class="user-guide-section">
              <div class="guide-header" onclick="toggleGuideSection('isp-bill-guide')">
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"
                    style="vertical-align: middle; margin-right: 8px;">
                    <path
                      d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z" />
                  </svg>
                  আইএসপি বিল
                </span>
                <span class="expand-icon">▼</span>
              </div>
              <div class="guide-content" id="isp-bill-guide">
                <h4>উদ্দেশ্য:</h4>
                <p>ইন্টারনেট সেবা প্রদানকারী (ISP) কে পেমেন্টের রেকর্ড রাখা।</p>

                <h4>পেমেন্ট প্রক্রিয়া:</h4>
                <ol>
                  <li>মাস এবং বছর নির্বাচন করুন</li>
                  <li>পেমেন্টের পরিমাণ লিখুন (ডিফল্ট ৯০০ টাকা)</li>
                  <li>পেমেন্টের তারিখ নির্বাচন করুন</li>
                  <li>"বিল পরিশোধ করুন" বাটনে ক্লিক করুন</li>
                </ol>

                <h4>বিশেষ বৈশিষ্ট্য:</h4>
                <ul>
                  <li><strong>ডুপ্লিকেট প্রতিরোধ:</strong> একই মাসে দুইবার পেমেন্ট করা যাবে না</li>
                  <li><strong>এডিট সুবিধা:</strong> পূর্বের পেমেন্ট সংশোধন করা যাবে</li>
                  <li><strong>হিস্টরি ট্র্যাকিং:</strong> সকল পেমেন্টের রেকর্ড</li>
                </ul>

                <h4>পেমেন্ট হিস্টরি:</h4>
                <ul>
                  <li>তারিখ অনুযায়ী সাজানো তালিকা</li>
                  <li>Edit এবং Delete অপশন</li>
                  <li>সম্পূর্ণ হিস্টরি মুছে ফেলার সুবিধা</li>
                </ul>
              </div>
            </div>

            <div class="user-guide-section">
              <div class="guide-header" onclick="toggleGuideSection('reports-guide')">
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"
                    style="vertical-align: middle; margin-right: 8px;">
                    <path
                      d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
                  </svg>
                  রিপোর্ট
                </span>
                <span class="expand-icon">▼</span>
              </div>
              <div class="guide-content" id="reports-guide">
                <h4>উদ্দেশ্য:</h4>
                <p>মাসিক আর্থিক রিপোর্ট তৈরি এবং বিশ্লেষণ করা।</p>

                <h4>মাসিক রিপোর্ট:</h4>
                <ul>
                  <li><strong>মোট আয়:</strong> পরিশোধিত বিলের মোট পরিমাণ</li>
                  <li><strong>মোট বকেয়া:</strong> অপরিশোধিত বিলের পরিমাণ</li>
                  <li><strong>আইএসপি বিল:</strong> ISP কে পেমেন্ট</li>
                  <li><strong>নিট আয়:</strong> মোট আয় - আইএসপি বিল</li>
                </ul>

                <h4>বাড়ি-ভিত্তিক রিপোর্ট:</h4>
                <p>প্রতিটি লোকেশনের আলাদা আয়ের হিসাব দেখা যায়।</p>

                <h4>PDF এক্সপোর্ট:</h4>
                <ul>
                  <li>প্রোফেশনাল লেআউট</li>
                  <li>কোম্পানি ব্র্যান্ডিং</li>
                  <li>প্রিন্ট-অপ্টিমাইজড ডিজাইন</li>
                </ul>

                <h4>গ্রাহক বিলিং হিস্টরি:</h4>
                <ul>
                  <li>নির্দিষ্ট গ্রাহকের সম্পূর্ণ বিলিং ইতিহাস</li>
                  <li>PDF ডাউনলোড সুবিধা</li>
                  <li>মাস অনুযায়ী সাজানো তথ্য</li>
                </ul>
              </div>
            </div>

            <div class="user-guide-section">
              <div class="guide-header" onclick="toggleGuideSection('router-guide')">
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"
                    style="vertical-align: middle; margin-right: 8px;">
                    <path
                      d="M12.01 21.49L23.64 7c-.45-.34-4.93-4-11.64-4C5.28 3 .81 6.66.36 7l11.63 14.49.01.01.01-.01z" />
                  </svg>
                  রাউটার ম্যানেজমেন্ট
                </span>
                <span class="expand-icon">▼</span>
              </div>
              <div class="guide-content" id="router-guide">
                <h4>উদ্দেশ্য:</h4>
                <p>নেটওয়ার্কের সকল রাউটারের তথ্য সংরক্ষণ এবং ম্যানেজ করা।</p>

                <h4>রাউটার তথ্য:</h4>
                <ul>
                  <li><strong>নাম:</strong> রাউটারের পরিচিতিমূলক নাম</li>
                  <li><strong>মডেল:</strong> রাউটারের মডেল নম্বর</li>
                  <li><strong>IP অ্যাড্রেস:</strong> নেটওয়ার্ক IP</li>
                  <li><strong>MAC অ্যাড্রেস:</strong> হার্ডওয়্যার ঠিকানা</li>
                  <li><strong>দূরত্ব:</strong> মেইন রাউটার থেকে দূরত্ব</li>
                  <li><strong>পাওয়ার স্পেক:</strong> বিদ্যুৎ সরবরাহের তথ্য</li>
                  <li><strong>পাসওয়ার্ড:</strong> অ্যাডমিন পাসওয়ার্ড</li>
                  <li><strong>লোকেশন:</strong> রাউটারের অবস্থান</li>
                </ul>

                <h4>বিশেষ ফিচার:</h4>
                <ul>
                  <li><strong>দূরত্ব কনভার্টার:</strong> ফিট থেকে মিটারে স্বয়ংক্রিয় রূপান্তর</li>
                  <li><strong>ছবি আপলোড:</strong> রাউটারের ছবি সংরক্ষণ</li>
                  <li><strong>ডাইরেক্ট অ্যাক্সেস:</strong> IP ক্লিক করে রাউটার অ্যাক্সেস</li>
                  <li><strong>গ্রাহক কাউন্ট:</strong> প্রতিটি রাউটারের গ্রাহক সংখ্যা</li>
                </ul>

                <h4>রাউটার ম্যানেজমেন্ট:</h4>
                <ul>
                  <li>রাউটার কার্ডে ক্লিক করে বিস্তারিত দেখুন</li>
                  <li>Edit বাটন দিয়ে তথ্য সংশোধন করুন</li>
                  <li>Delete বাটন দিয়ে রাউটার মুছুন</li>
                </ul>
              </div>
            </div>

            <div class="user-guide-section">
              <div class="guide-header" onclick="toggleGuideSection('settings-guide')">
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor"
                    style="vertical-align: middle; margin-right: 8px;">
                    <path
                      d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23-.09.49 0 .61.22l2-3.46c.12-.22.07.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z" />
                  </svg>
                  সেটিংস
                </span>
                <span class="expand-icon">▼</span>
              </div>
              <div class="guide-content" id="settings-guide">
                <h4>ওয়েবসাইট কাস্টমাইজেশন:</h4>
                <ul>
                  <li><strong>নাম পরিবর্তন:</strong> কোম্পানির নাম আপডেট করুন</li>
                  <li><strong>লোগো আপলোড:</strong> কোম্পানির লোগো যোগ করুন (৪০x৪০ পিক্সেল সুপারিশ)</li>
                  <li><strong>রিয়েল-টাইম আপডেট:</strong> পরিবর্তন সাথে সাথে দেখা যাবে</li>
                </ul>

                <h4>লোকেশন ম্যানেজমেন্ট:</h4>
                <ul>
                  <li><strong>নতুন লোকেশন:</strong> বাড়ির নাম যোগ করুন</li>
                  <li><strong>লোকেশন এডিট:</strong> বিদ্যমান নাম পরিবর্তন করুন</li>
                  <li><strong>লোকেশন ডিলিট:</strong> অব্যবহৃত লোকেশন মুছুন</li>
                  <li><strong>ডিফল্ট সুরক্ষা:</strong> মূল লোকেশনগুলো মুছা যাবে না</li>
                </ul>

                <h4>ডেটা ম্যানেজমেন্ট:</h4>
                <ul>
                  <li><strong>এক্সপোর্ট:</strong> সকল ডেটা JSON ফরম্যাটে ডাউনলোড</li>
                  <li><strong>ইমপোর্ট:</strong> ব্যাকআপ ফাইল থেকে ডেটা পুনরুদ্ধার</li>
                  <li><strong>রিসেট:</strong> সম্পূর্ণ সিস্টেম রিসেট (সতর্কতার সাথে)</li>
                </ul>

                <h4>নিরাপত্তা টিপস:</h4>
                <ul>
                  <li>নিয়মিত ডেটা ব্যাকআপ নিন</li>
                  <li>গুরুত্বপূর্ণ পরিবর্তনের আগে ব্যাকআপ নিশ্চিত করুন</li>
                  <li>রিসেট করার আগে দুইবার চিন্তা করুন</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
    <footer class="footer">
      Copyright &copy; <span id="footer-year"></span> Abid Network. All Rights Reserved.
    </footer>
  </div>
  <div class="modal" id="adjustmentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="adjustment-form-title">নতুন অ্যাডজাস্টমেন্ট যোগ করুন</h2>
        <button class="modal-close" id="adjustment-modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <p><strong>গ্রাহক:</strong> <span id="modal-customer-name-adj"></span></p>
        <form id="adjustmentForm">
          <input type="hidden" id="adjustmentBillId">
          <input type="hidden" id="adjustmentId">
          <div class="form-group">
            <label for="adjustmentAmount">টাকার পরিমাণ</label>
            <input type="number" id="adjustmentAmount" placeholder="টাকার পরিমাণ লিখুন" required>
          </div>
          <div class="form-group">
            <label for="adjustmentType">লেনদেনের ধরন</label>
            <select id="adjustmentType">
              <option value="due">বকেয়া হিসেবে যোগ</option>
              <option value="advance">অ্যাডভান্স হিসেবে জমা</option>
            </select>
          </div>
          <div class="form-group">
            <label for="adjustmentNotes">নোট</label>
            <input type="text" id="adjustmentNotes" placeholder="নোট লিখুন বা ট্যাগ নির্বাচন করুন">
            <div class="note-tags">
              <span class="note-tag" data-note="পূর্বের বকেয়া">পূর্বের বকেয়া</span>
              <span class="note-tag" data-note="অ্যাডভান্স পেমেন্ট">অ্যাডভান্স পেমেন্ট</span>
            </div>
          </div>
          <div style="text-align: right; margin-top: 20px;">
            <button type="button" class="btn btn-delete" id="adjustment-cancel-btn"
              style="display: none; margin-right: 10px;">বাতিল</button>
            <button type="submit" class="btn btn-submit" id="adjustment-submit-btn">সংরক্ষণ করুন</button>
          </div>
        </form>
        <hr style="margin: 20px 0;">
        <h3>অ্যাডজাস্টমেন্ট ইতিহাস</h3>
        <ul class="adjustment-list" id="adjustment-list"></ul>
      </div>
    </div>
  </div>
  <div class="modal" id="ispEditModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>আইএসপি বিল এডিট করুন</h2>
        <button class="modal-close" id="isp-edit-modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="ispEditForm">
          <input type="hidden" id="ispEditId">
          <div class="form-group">
            <label for="ispEditMonth">মাস</label>
            <select id="ispEditMonth"></select>
          </div>
          <div class="form-group">
            <label for="ispEditYear">বছর</label>
            <select id="ispEditYear"></select>
          </div>
          <div class="form-group">
            <label for="ispEditAmount">টাকার পরিমাণ</label>
            <input type="number" id="ispEditAmount" required>
          </div>
      </div>
      <div class="form-group">
        <label for="ispEditPayDate">পরিশোধের তারিখ</label>
        <input type="date" id="ispEditPayDate" required>
      </div>
      <div style="text-align: right; margin-top: 20px;">
        <button type="submit" class="btn btn-submit">আপডেট করুন</button>
      </div>
      </form>
    </div>
  </div>
  </div>
  <!-- New, Modern Router Profile Window -->
<div class="modal" id="routerProfileModal">
    <div class="router-profile-window">
        
        <!-- Header with Name -->
        <div class="router-profile-header">
            <h2 id="router-profile-name"></h2>
        </div>
        <button class="close-btn" id="router-profile-close-btn">&times;</button>

        <!-- Grid for Router Information -->
        <div class="router-info-grid">
            <div class="router-info-item">
                <strong><span class="icon">🏷️</span> মডেল</strong>
                <span id="router-profile-model"></span>
            </div>
            <div class="router-info-item">
                <strong><span class="icon">📍</span> লোকেশন</strong>
                <span id="router-profile-location"></span>
            </div>
            <div class="router-info-item full-width-item">
                <strong><span class="icon">🌐</span> আইপি অ্যাড্রেস</strong>
                <span id="router-profile-ip"></span>
            </div>
            <div class="router-info-item full-width-item">
                <strong><span class="icon">💻</span> ম্যাক অ্যাড্রেস</strong>
                <span id="router-profile-mac"></span>
            </div>
            <div class="router-info-item">
                <strong><span class="icon">📏</span> দূরত্ব</strong>
                <span id="router-profile-distance"></span>
            </div>
            <div class="router-info-item">
                <strong><span class="icon">⚡</span> পাওয়ার</strong>
                <span id="router-profile-power"></span>
            </div>
            <div class="router-info-item full-width-item">
                <strong><span class="icon">🔑</span> পাসওয়ার্ড</strong>
                <span id="router-profile-password"></span>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="router-action-buttons">
            <a href="#" id="router-profile-access-btn" class="router-action-btn btn-access" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h6zM5 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H5z"/><path d="M8 14a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                <span>অ্যাক্সেস</span>
            </a>
            <button id="router-profile-edit-btn" class="router-action-btn btn-edit">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg>
                <span>এডিট</span>
            </button>
        </div>
    </div>
</div>

  <div class="modal" id="locationEditModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>লোকেশন এডিট করুন</h2>
        <button class="modal-close" id="location-edit-modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="locationEditForm">
          <input type="hidden" id="locationEditOldName">
          <div class="form-group">
            <label for="locationEditNewName">নতুন নাম</label>
            <input type="text" id="locationEditNewName" required>
          </div>
          <div style="text-align: right; margin-top: 20px;">
            <button type="submit" class="btn btn-submit">আপডেট করুন</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- Customer Profile Modal (UPDATED for v4.1) -->
    <div class="modal" id="customerProfileModal">
      <div class="modal-content profile-window">
        <div class="profile-header">
          <h2 id="profile-customer-name"></h2>
          <div id="profile-action-buttons" style="margin-top: 10px;"></div>
        </div>

      <div class="profile-info-grid">
        <div class="profile-info-item">
    <strong>
        <a id="profile-icon-phone-link" href="#" style="text-decoration: none; color: inherit;">
            <span class="icon">📞</span>
        </a>
        ফোন নম্বর
    </strong>
    <span id="profile-phone"></span>
</div>
        <div class="profile-info-item"><strong><span class="icon">🏠</span> বাড়ি</strong><span
            id="profile-house"></span></div>
        <div class="profile-info-item"><strong><span class="icon">💰</span> মাসিক বিল</strong><span
            id="profile-bill"></span></div>
        <div class="profile-info-item"><strong><span class="icon">📅</span> সংযোগের তারিখ</strong><span
            id="profile-connection-date"></span></div>
        <div class="profile-info-item full-width-item"><strong><span class="icon">💻</span> MAC Address</strong><span
            id="profile-mac"></span></div>
        <div class="profile-info-item full-width-item" id="profile-status-container">
          <strong><span id="profile-status-icon" class="icon"></span> স্ট্যাটাস</strong>
          <span id="profile-status-text"></span>
        </div>
      </div>

      <div class="billing-history-section">
        <h3><span class="icon">📜</span> বিলিং ইতিহাস</h3>
        <ul class="billing-history-list" id="profile-billing-history">
        </ul>
      </div>

      <button class="modal-close" id="customer-profile-modal-close"
        style="position: absolute; top: 15px; right: 15px; font-size: 24px; background: none; border: none; cursor: pointer;">&times;</button>
    </div>
  </div>

  <script>
    let notificationInterval = null;
    const isLiveServer = window.location.protocol.startsWith('http');
    function toBengaliNumber(engNumber) {
      if (engNumber === null || engNumber === undefined) return '';
      const engStr = String(engNumber);
      const bengaliDigits = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
      let bengaliStr = '';
      for (let i = 0; i < engStr.length; i++) {
        const char = engStr[i];
        if (char >= '0' && char <= '9') {
          bengaliStr += bengaliDigits[parseInt(char)];
        } else {
          bengaliStr += char;
        }
      }
      return bengaliStr;
    }

    function saveDb() {
      const DATABASE_KEY = 'abidNetworkDb_v41';
      localStorage.setItem(DATABASE_KEY, JSON.stringify(db));
    }

    // Global variable to track which bill the payment modal is opened for
    let currentPaymentBillId = null;

    // Global database variable
    let db = {
      customers: [],
      bills: [],
      ispPayments: [],
      routers: [],
      locations: []
    };
    // Global database variable
    // নতুন ভেরিয়েবল শুরু
    let displayedActivitiesCount = 0;
    const ACTIVITIES_PER_PAGE = 10; // প্রতিবার ১০টি করে লোড হবে
    // নতুন ভেরিয়েবল শেষ

    /**
     * পেমেন্টের হিসাব রাখে এবং ডেটাবেস আপডেট করে।
     * @param {string} billId - বিলের আইডি।
     * @param {number} receivedAmount - প্রাপ্ত টাকার পরিমাণ।
     */
    // এই নতুন ফাংশনটি logPayment ফাংশনের ঠিক উপরে বসবে

    document.addEventListener('DOMContentLoaded', () => {
      setupMacInput('customerMacContainer');
      setupMacInput('routerMacContainer');
      updateLastExportDate();
// ★★★ ব্যাক বাটন নিয়ন্ত্রণের জন্য নতুন কোড ★★★
// ★★★ মূল পরিবর্তন: popstate ইভেন্টটিকে isLiveServer শর্তের ভেতরে রাখা হয়েছে ★★★
      if (isLiveServer) {
    window.addEventListener('popstate', function(event) {
        // যদি কোনো মডাল বা সাইডবার খোলা থাকে, প্রথমে সেগুলো বন্ধ হবে
        const activeModal = document.querySelector('.modal.active');
        if (sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
            overlay.style.display = 'none';
            // ব্যবহারকারীকে একই পেজে রাখার জন্য URL আবার পুশ করা হচ্ছে
            const currentPage = localStorage.getItem(LAST_PAGE_KEY) || 'dashboard';
            const path = window.location.pathname.split('/').pop();
            history.pushState({ page: currentPage }, '', `${path}#${currentPage}`);
            return;
        }
        if (activeModal) {
            activeModal.classList.remove('active');
            overlay.style.display = 'none';
            const currentPage = localStorage.getItem(LAST_PAGE_KEY) || 'dashboard';
            const path = window.location.pathname.split('/').pop();
            history.pushState({ page: currentPage }, '', `${path}#${currentPage}`);
            return;
        }

        // URL থেকে পেজের নাম বের করে সেই পেজটি দেখানো হচ্ছে
        let pageId = location.hash.substring(1) || 'dashboard';
        switchPage(pageId, true); // true দিয়ে কল করা হচ্ছে যাতে এটি আবার history তে পুশ না করে
    });
}

// ★★★ নতুন কোডের শেষ ★★★

      document.querySelectorAll('#billing .filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelector('#billing .filter-btn.active').classList.remove('active');
                btn.classList.add('active');
                renderBillingPage();
            });
        });

      // হেডার শিরোনামে ক্লিক করে ড্যাশবোর্ডে ফিরে যাওয়া
      const homeLink = document.getElementById('home-link');
      if (homeLink) {
          homeLink.addEventListener('click', function(event) {
              event.preventDefault(); 
              switchPage('dashboard'); 
          });
      }
      
      let customerToEditId = null;
      const DATABASE_KEY = 'abidNetworkDb_v41'; // Version updated to 4.1
      const LAST_PAGE_KEY = 'abidNetworkLastPage';

      const defaultLocations = [
        'বাড়ি১ঃ মেইন রাউটার', 'বাড়ি২ঃ বোরহানের বাসা', 'বাড়ি৩ঃ টিনশেড',
        'বাড়ি৪ঃ পিছনের বাসা', 'বাড়ি৫ঃ গোলাপের বাসা'
      ];
      const defaultBillAmounts = [150, 170, 'other'];
      const months = ['জানুয়ারি', 'ফেব্রুয়ারি', 'মার্চ', 'এপ্রিল', 'মে', 'জুন', 'জুলাই', 'আগস্ট', 'সেপ্টেম্বর',
        'অক্টোবর', 'নভেম্বর', 'ডিসেম্বর'
      ];
      const years = Array.from({
        length: 10
      }, (_, i) => new Date().getFullYear() - 5 + i);

      // Load data from localStorage and update global db
      const localDb = JSON.parse(localStorage.getItem(DATABASE_KEY)) || {
        customers: [],
        bills: [],
        ispPayments: [],
        routers: [],
        locations: defaultLocations.slice()
      };

      // Update global db with loaded data
      db.customers = localDb.customers;
      db.bills = localDb.bills;
      db.ispPayments = localDb.ispPayments;
      db.routers = localDb.routers;
      db.locations = localDb.locations;

      function toBengaliNumber(engNumber) {
        if (engNumber === null || engNumber === undefined) return '';
        const engStr = String(engNumber);
        const bengaliDigits = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
        let bengaliStr = '';
        for (let i = 0; i < engStr.length; i++) {
          const char = engStr[i];
          if (char >= '0' && char <= '9') {
            bengaliStr += bengaliDigits[parseInt(char)];
          } else {
            bengaliStr += char;
          }
        }
        return bengaliStr;
      }

      function migrateDb(data) {
        // This function can be expanded for future migrations
        if (!data.routers) data.routers = [];
        if (!data.locations || data.locations.length === 0) {
          data.locations = [...defaultLocations];
        }

        if (data.customers) {
          data.customers.forEach(c => {
            if (c.macAddress && Array.isArray(c.macAddress)) {
              c.macAddress = c.macAddress.join(':');
            }
            if (c.advanceBalance === undefined) {
              c.advanceBalance = 0;
            }
          });
        }

        if (data.bills) {
          data.bills.forEach(b => {
            // যদি পুরনো ব্যাকআপ হয় এবং এই তথ্যগুলো না থাকে
            if (b.status === undefined) {
              b.status = b.isPaid ? 'paid' : 'unpaid';
            }
            if (b.paidAmount === undefined) {
              b.paidAmount = b.isPaid ? b.totalAmount : 0;
            }
            if (b.remainingDue === undefined) {
              b.remainingDue = b.isPaid ? 0 : b.totalAmount;
            }
            if (b.paymentHistory === undefined) {
              b.paymentHistory = [];
            }
            if (b.adjustments === undefined) {
              b.adjustments = [];
            }
            if (b.advanceUsed === undefined) {
              b.advanceUsed = 0;
            }
          });
        }

        return data;
      }

      // Activity Management System
      const ACTIVITY_STORAGE_KEY = 'abidNetworkActivities_v1';
      const MAX_ACTIVITIES = 50;

      // Activity types and their configurations
      const ACTIVITY_TYPES = {
        'customer_added': {
          title: 'নতুন গ্রাহক যোগ',
          icon: '👤',
          className: 'customer-added'
        },
        'customer_deleted': {
          title: 'গ্রাহক মুছে ফেলা',
          icon: '🗑️',
          className: 'customer-deleted'
        },
        'bill_created': {
          title: 'বিল তৈরি',
          icon: '📄',
          className: 'bill-created'
        },
        'bill_deleted': {
          title: 'বিল মুছে ফেলা',
          icon: '🗑️',
          className: 'bill-deleted'
        },
        'bill_paid': {
          title: 'বিল পরিশোধ',
          icon: '💰',
          className: 'bill-paid'
        },
        'bill_status_paid': {
          title: 'বিল পরিশোধিত',
          icon: '✅',
          className: 'bill-paid'
        },
        'payment_history': {
          title: 'আংশিক পেমেন্ট',
          icon: '💳',
          className: 'payment-history'
        },
        'isp_payment': {
          title: 'আইএসপি বিল পরিশোধ',
          icon: '🌐',
          className: 'isp-payment'
        },
        'isp_payment_deleted': {
          title: 'আইএসপি বিল মুছে ফেলা',
          icon: '🗑️',
          className: 'isp-payment-deleted'
        },
        'router_added': {
          title: 'রাউটার যোগ',
          icon: '📡',
          className: 'router-added'
        },
        'router_deleted': {
          title: 'রাউটার মুছে ফেলা',
          icon: '🗑️',
          className: 'router-deleted'
        },
        'advance_deposit': {
          title: 'অ্যাডভান্স জমা',
          icon: '💳',
          className: 'advance-deposit'
        },
        'due_adjustment': {
          title: 'বকেয়া সমন্বয়',
          icon: '⚠️',
          className: 'due-adjustment'
        },
        'adjustment_updated': {
          title: 'সমন্বয় আপডেট',
          icon: '✏️',
          className: 'due-adjustment'
        },
        'adjustment_deleted': {
          title: 'অ্যাডজাস্টমেন্ট মুছে ফেলা',
          icon: '🗑️',
          className: 'adjustment-deleted'
        },
        'data_import': {
          title: 'ডাটা ইমপোর্ট',
          icon: '📥',
          className: 'data-import'
        },
        'data_backup': {
          title: 'ডাটা ব্যাকআপ',
          icon: '💾',
          className: 'data-backup'
        },
        'location_added': {
          title: 'বাড়ি যোগ',
          icon: '🏠',
          className: 'location-added'
        },
        'location_deleted': {
          title: 'বাড়ি মুছে ফেলা',
          icon: '🗑️',
          className: 'location-deleted'
        },
        'month_bills_deleted': {
          title: 'মাসিক সব বিল মুছে ফেলা',
          icon: '🗑️',
          className: 'month-bills-deleted'
        },
        'all_isp_history_deleted': {
          title: 'সব আইএসপি বিল ইতিহাস মুছে ফেলা',
          icon: '🗑️',
          className: 'all-isp-history-deleted'
        },
        'discount_applied': { 
          title: 'বিশেষ ছাড়',    
          icon: '🏷️',
          className: 'due-adjustment'
        },
        'report_generated': {
          title: 'রিপোর্ট তৈরি',
          icon: '🖨️',
          className: 'report-generated'
        },
        'customer_status_change': { title: 'স্ট্যাটাস পরিবর্তন', icon: '🔄', className: 'customer-added' },
        'customer_deactivation_pending': { title: 'নিষ্ক্রিয় করার অনুরোধ', icon: '⏳', className: 'due-adjustment' },
        'customer_deactivated_auto': { title: 'স্বয়ংক্রিয় নিষ্ক্রিয়', icon: '🤖', className: 'customer-deleted' }
      };

      // Load activities from localStorage
      function loadActivities() {
        try {
          const stored = localStorage.getItem(ACTIVITY_STORAGE_KEY);
          return stored ? JSON.parse(stored) : [];
        } catch (error) {
          console.error('Error loading activities:', error);
          return [];
        }
      }

      // Save activities to localStorage
      function saveActivities(activities) {
        try {
          // Keep only the latest MAX_ACTIVITIES
          const trimmedActivities = activities.slice(0, MAX_ACTIVITIES);
          localStorage.setItem(ACTIVITY_STORAGE_KEY, JSON.stringify(trimmedActivities));
        } catch (error) {
          console.error('Error saving activities:', error);
        }
      }

      // Add new activity
      function addActivity(type, description, metadata = {}) {
        const activities = loadActivities();
        const activity = {
          id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
          type: type,
          title: ACTIVITY_TYPES[type]?.title || 'অজানা কার্যক্রম',
          description: description,
          timestamp: new Date().toISOString(),
          metadata: metadata
        };

        activities.unshift(activity); // Add to beginning
        saveActivities(activities);

        // Update dashboard if currently visible
        if (document.getElementById('dashboard').classList.contains('active')) {
          renderRecentActivities();
        }
      }

      // Format time for display
      function formatActivityTime(timestamp) {
        const now = new Date();
        const activityTime = new Date(timestamp);
        const diffInMinutes = Math.floor((now - activityTime) / (1000 * 60));

        if (diffInMinutes < 1) return 'এখনই';
        if (diffInMinutes < 60) return `${toBengaliNumber(diffInMinutes)} মিনিট আগে`;

        const diffInHours = Math.floor(diffInMinutes / 60);
        if (diffInHours < 24) return `${toBengaliNumber(diffInHours)} ঘন্টা আগে`;

        const diffInDays = Math.floor(diffInHours / 24);
        if (diffInDays < 7) return `${toBengaliNumber(diffInDays)} দিন আগে`;

        // For older activities, show date
        const options = {
          day: 'numeric',
          month: 'long'
        };
        return activityTime.toLocaleDateString('bn-BD', options);
      }

      // Render recent activities

      function renderRecentActivities(loadMore = false) {
        const clearLogBtn = document.getElementById('clear-activity-log-btn');
        const allActivities = loadActivities();
        const container = document.getElementById('recent-activities');
        const noActivitiesDiv = document.getElementById('no-activities');
        const loaderDiv = document.getElementById('activity-loader');
        const loadMoreBtn = document.getElementById('load-more-activities-btn');

        if (!container) return;

        if (!loadMore) {
          // যদি প্রথমবার লোড হয়, কন্টেইনার খালি করুন এবং কাউন্টার রিসেট করুন
          container.innerHTML = '';
          displayedActivitiesCount = 0;
        }

        if (allActivities.length === 0) {
          container.style.display = 'none';
          noActivitiesDiv.style.display = 'block';
          loaderDiv.style.display = 'none';
          if (clearLogBtn) clearLogBtn.style.display = 'none'; // <-- এই লাইনটি যোগ করুন
          return;
        }

        // যদি লগ থাকে, তবে বাটনটি দেখানো হবে
        if (clearLogBtn) clearLogBtn.style.display = 'inline-flex';

        container.style.display = 'grid';
        noActivitiesDiv.style.display = 'none';

        const startIndex = displayedActivitiesCount;
        const endIndex = startIndex + ACTIVITIES_PER_PAGE;
        const activitiesToRender = allActivities.slice(startIndex, endIndex);

        let newActivitiesHtml = activitiesToRender.map(activity => {
          const config = ACTIVITY_TYPES[activity.type] || ACTIVITY_TYPES['data_backup'];
          const timeStr = formatActivityTime(activity.timestamp);

          let metadataHtml = '';
          if (activity.metadata) {
            const tags = [];
            if (activity.metadata.customerName) tags.push(activity.metadata.customerName);
            if (activity.metadata.amount) tags.push(`৳${toBengaliNumber(activity.metadata.amount)}`);
            if (activity.metadata.location) tags.push(activity.metadata.location);
            if (activity.metadata.month !== undefined && activity.metadata.year !== undefined) {
              const monthName = months[activity.metadata.month];
              tags.push(`${monthName} ${toBengaliNumber(activity.metadata.year)}`);
            }

            if (tags.length > 0) {
              metadataHtml = `<div class="activity-metadata">${tags.map(tag =>
                    `<span class="activity-tag">${tag}</span>`
                ).join('')}</div>`;
            }
          }

          return `
            <div class="activity-card ${config.className}">
                <div class="activity-header">
                    <div class="activity-icon">${config.icon}</div>
                    <h3 class="activity-title">${config.title}</h3>
                    <span class="activity-time">${timeStr}</span>
                </div>
                <p class="activity-description">${activity.description}</p>
                ${metadataHtml}
            </div>
        `;
        }).join('');

        container.insertAdjacentHTML('beforeend', newActivitiesHtml);
        displayedActivitiesCount += activitiesToRender.length;

        // "আরো দেখুন" বাটনের অবস্থা নিয়ন্ত্রণ
        if (displayedActivitiesCount < allActivities.length) {
          loaderDiv.style.display = 'block';
        } else {
          loaderDiv.style.display = 'none';
        }
      }

      function saveDb() {
        localStorage.setItem(DATABASE_KEY, JSON.stringify(db));
      }

      function loadDb() {
        const data = localStorage.getItem(DATABASE_KEY);
        if (data) {
          const parsedData = JSON.parse(data);
          db = migrateDb(parsedData);
        } else {
          // Check for older db versions for migration
          const oldDataV40 = localStorage.getItem('abidNetworkDb_v40');
          if (oldDataV40) {
            console.log("Migrating data from v4.0 to v4.1");
            const parsedOldData = JSON.parse(oldDataV40);
            db = migrateDb(parsedOldData);
          } else {
            db.locations = [...defaultLocations];
          }
        }
        saveDb();
      }

      const sidebar = document.getElementById('sidebar');
      const menuToggle = document.getElementById('menu-toggle');
      const overlay = document.getElementById('overlay');
      const pageTitle = document.getElementById('page-title');

      menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('active');
        overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
      });

      overlay.addEventListener('click', () => {
        sidebar.classList.remove('active');
        overlay.style.display = 'none';
      });

// --- এই সম্পূর্ণ ফাংশনটি দিয়ে আপনার পুরনো switchPage ফাংশনটি প্রতিস্থাপন করুন ---

      function switchPage(pageId, isInitialLoad = false, options = {}) {
          if (pageId !== 'dashboard' && notificationInterval) {
              clearInterval(notificationInterval);
              notificationInterval = null;
          }
      
          document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
          const page = document.getElementById(pageId);
          if (page) page.classList.add('active');
      
          document.querySelectorAll('.menu-item').forEach(item => {
              item.classList.remove('active');
              if (item.dataset.page === pageId) {
                  item.classList.add('active');
              }
          });
      
          if (isLiveServer && !isInitialLoad) {
              const path = window.location.pathname.split('/').pop();
              const newUrl = `${path}#${pageId}`;
              history.pushState({ page: pageId }, '', newUrl);
          }
          
          if (!isInitialLoad) localStorage.setItem(LAST_PAGE_KEY, pageId);
      
          sidebar.classList.remove('active');
          overlay.style.display = 'none';
      
          if (pageId === 'billing') {
              initializeBillingForm();
              renderBillingPage();
          } else if (pageId === 'add_customer') {
              initializeCustomerForm();
              if (customerToEditId) {
                  const customer = db.customers.find(c => c.id === customerToEditId);
                  if (customer) {
                      customerIdInput.value = customer.id;
                      customerNameInput.value = customer.name;
                      customerPhoneInput.value = customer.phone;
                      customerHouseInput.value = customer.house;
                      if (defaultBillAmounts.includes(customer.monthlyBill)) {
                          customerBillInput.value = customer.monthlyBill;
                      } else {
                          customerBillInput.value = 'other';
                          customBillAmountInput.value = customer.monthlyBill;
                      }
                      connectionDateInput.value = customer.connectionDate;
                      isFreeUserInput.checked = customer.isFree;
                      customerFormTitle.textContent = 'গ্রাহকের তথ্য আপডেট করুন';
                      customerSubmitBtn.textContent = 'আপডেট করুন';
                      customerCancelBtn.style.display = 'inline-block';
                      customerBillInput.dispatchEvent(new Event('change'));
                      isFreeUserInput.dispatchEvent(new Event('change'));
                      setMacAddress('customerMacContainer', customer.macAddress);
                  }
                  customerToEditId = null;
              }
          } else if (pageId === 'dashboard') {
              renderDashboard();
          } else if (pageId === 'customers') {
              renderCustomerListPage();
          } else if (pageId === 'isp_bill') {
              // ★★★ মূল পরিবর্তন এখানে ★★★
              renderIspBillPage(options); // options অবজেক্টটি পাস করা হচ্ছে
          } else if (pageId === 'reports') {
              renderReportPage();
          } else if (pageId === 'advance') {
              renderAdvancePage();
          } else if (pageId === 'settings') {
              renderSettingsPage();
          } else if (pageId === 'about') {
              renderAboutPage();
          }
      }

      // About page functions
      function renderAboutPage() {
        // About page is static HTML, no dynamic rendering needed
        // Initialize user guide functionality
        initializeAboutPage();
      }

      function initializeAboutPage() {
        const userGuideBtn = document.getElementById('user-guide-btn');
        const userGuideContainer = document.getElementById('user-guide-container');

        if (userGuideBtn && userGuideContainer) {
          // Remove any existing event listeners to prevent duplicates
          userGuideBtn.replaceWith(userGuideBtn.cloneNode(true));
          const newUserGuideBtn = document.getElementById('user-guide-btn');

          newUserGuideBtn.addEventListener('click', function() {
            if (userGuideContainer.style.display === 'none' || userGuideContainer.style.display === '') {
              userGuideContainer.style.display = 'block';
              newUserGuideBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="vertical-align: middle; margin-right: 5px;">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            গাইড লুকান
                        `;
            } else {
              userGuideContainer.style.display = 'none';
              newUserGuideBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="vertical-align: middle; margin-right: 5px;">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                            </svg>
                            সম্পূর্ণ গাইড দেখুন
                        `;
            }
          });
        }
      }

      window.toggleGuideSection = function(sectionId) {
        const content = document.getElementById(sectionId);
        if (!content) return;

        const header = content.previousElementSibling;
        const icon = header ? header.querySelector('.expand-icon') : null;

        if (content.classList.contains('expanded')) {
          content.classList.remove('expanded');
          if (header) header.classList.remove('expanded');
          if (icon) icon.textContent = '▼';
        } else {
          content.classList.add('expanded');
          if (header) header.classList.add('expanded');
          if (icon) icon.textContent = '▲';
        }
      }

      function renderAdvancePage() {
        const routerListContainer = document.getElementById('router-list');
        const routerModal = document.getElementById('routerModal');
        const modalCloseBtn = document.getElementById('routerModalCloseBtn');
        const routerForm = document.getElementById('routerForm');
        const toggleFormBtn = document.getElementById('toggleRouterFormBtn');
        const formContainer = document.getElementById('routerFormContainer');

        function saveAndRenderRouters() {
          saveDb();
          renderRouters();
        }

        function renderRouters() {
          routerListContainer.innerHTML = '';
          const filteredRouters = db.routers;

          if (filteredRouters.length === 0) {
            routerListContainer.innerHTML =
              '<p style="text-align:center; color:#718096;">কোনো রাউটার পাওয়া যায়নি।</p>';
            return;
          }
          filteredRouters.forEach(router => {
            const customerCount = db.customers.filter(c => c.house === router.location).length;
            const item = document.createElement('div');
            item.className = 'router-item';
            item.innerHTML = `
                        <div class="router-item-content" data-router-id="${router.id}">
                            <img src="https://i.ibb.co/Lz0dGqC/router-icon.png" alt="Router Icon">
                            <div class="router-info">
                                <div class="name">${router.name}</div>
                                <div class="model">${router.model}</div>
                                <div class="customer-count">গ্রাহক: ${toBengaliNumber(customerCount)} জন</div>
                            </div>
                        </div>
                        <button class="router-delete-btn" data-router-id="${router.id}">&times;</button>
                    `;
            routerListContainer.appendChild(item);
          });
        }

        // Add feet to meters conversion
        document.getElementById('routerDistanceFeet').addEventListener('input', function() {
          const feet = parseFloat(this.value) || 0;
          const meters = (feet * 0.3048).toFixed(2);
          document.getElementById('routerDistanceMeters').value = meters;
        });

        populateDropdown('routerLocationSelect', db.locations, {
          isBengali: false
        });
        toggleFormBtn.onclick = () => {
          formContainer.classList.toggle('active');
          toggleFormBtn.textContent = formContainer.classList.contains('active') ? 'ফর্ম লুকান' :
            'নতুন রাউটার যোগ করুন';
        };

        // ★★★ নতুন এবং উন্নত কোড (সফলতার বার্তা সহ) ★★★
        routerForm.onsubmit = (e) => {
          e.preventDefault();
          const imageFile = document.getElementById('routerImage').files[0];
          let imageDataUrl = null;

          const processRouter = () => {
            const routerId = document.getElementById('routerId').value;
            const routerData = {
              name: document.getElementById('routerName').value,
              model: document.getElementById('routerModel').value,
              ip: document.getElementById('routerIp').value,
              macAddress: getMacAddress('routerMacContainer'),
              distanceFeet: parseFloat(document.getElementById('routerDistanceFeet').value) || 0,
              distanceMeters: parseFloat(document.getElementById('routerDistanceMeters').value) || 0,
              powerSpec: document.getElementById('routerPowerSpec').value,
              password: document.getElementById('routerPassword').value,
              location: document.getElementById('routerLocationSelect').value,
              image: imageDataUrl
            };

            if (routerId) {
              // রাউটার আপডেট করা হচ্ছে
              const routerIndex = db.routers.findIndex(r => r.id == routerId);
              if (routerIndex > -1) {
                db.routers[routerIndex] = {
                  ...db.routers[routerIndex],
                  ...routerData
                };
                // ★★★ সফলতার বার্তা যোগ করা হয়েছে ★★★
                alert(`রাউটার "${routerData.name}"-এর তথ্য সফলভাবে আপডেট করা হয়েছে।`);
              }
            } else {
              // নতুন রাউটার যোগ করা হচ্ছে
              const newRouter = {
                id: Date.now(),
                ...routerData
              };
              db.routers.push(newRouter);

              addActivity('router_added', `${routerData.name} নামে নতুন রাউটার যোগ করা হয়েছে`, {
                routerName: routerData.name,
                location: routerData.location,
                model: routerData.model,
                ip: routerData.ip
              });
              // ★★★ সফলতার বার্তা যোগ করা হয়েছে ★★★
              alert(`নতুন রাউটার "${routerData.name}" সফলভাবে যোগ করা হয়েছে।`);
            }

            saveAndRenderRouters();
            routerForm.reset();
            document.getElementById('routerId').value = '';
            formContainer.classList.remove('active');
            toggleFormBtn.textContent = 'নতুন রাউটার যোগ করুন';
          };

          if (imageFile) {
            const reader = new FileReader();
            reader.onload = (e) => {
              imageDataUrl = e.target.result;
              processRouter();
            };
            reader.readAsDataURL(imageFile);
          } else {
            const routerId = document.getElementById('routerId').value;
            if (routerId) {
              const existingRouter = db.routers.find(r => r.id == routerId);
              if (existingRouter) {
                imageDataUrl = existingRouter.image;
              }
            }
            processRouter();
          }
        };

        // ★★★ নতুন এবং নিরাপদ কোড (সতর্কবার্তা সহ) ★★★
// এই সম্পূর্ণ ব্লকটি কপি করে পুরনোটির জায়গায় পেস্ট করুন
    routerListContainer.onclick = (e) => {
        // রাউটার মুছে ফেলার বাটন
        if (e.target.classList.contains('router-delete-btn')) {
            const routerId = e.target.dataset.routerId;
            const router = db.routers.find(r => r.id == routerId);
            if (!router) return;
    
            if (confirm(`আপনি কি নিশ্চিতভাবে "${router.name}" রাউটারটি মুছে ফেলতে চান?`)) {
                const routerName = router.name;
                db.routers = db.routers.filter(r => r.id != routerId);
                addActivity('router_deleted', `রাউটার মুছে ফেলা হয়েছে: ${routerName}`, {
                    routerName: routerName,
                    routerId: routerId
                });
                saveAndRenderRouters();
                alert(`রাউটার "${routerName}" সফলভাবে মুছে ফেলা হয়েছে।`);
            }
        }
        // রাউটারের বিস্তারিত দেখার জন্য ক্লিক
        else if (e.target.closest('.router-item-content')) {
            const routerId = e.target.closest('.router-item-content').dataset.routerId;
            const routerData = db.routers.find(r => r.id == routerId);
            if (routerData) {
                // নতুন প্রোফাইল উইন্ডোর জন্য ডেটা সেট করা
                document.getElementById('router-profile-name').textContent = routerData.name;
                document.getElementById('router-profile-model').textContent = routerData.model || 'N/A';
                document.getElementById('router-profile-location').textContent = routerData.location || 'N/A';
                document.getElementById('router-profile-ip').textContent = routerData.ip || 'N/A';
                document.getElementById('router-profile-mac').textContent = routerData.macAddress || 'N/A';
                document.getElementById('router-profile-distance').textContent = `${routerData.distanceMeters || 'N/A'} মিটার`;
                document.getElementById('router-profile-power').textContent = routerData.powerSpec || 'N/A';
                document.getElementById('router-profile-password').textContent = routerData.password || 'N/A';
    
                const accessBtn = document.getElementById('router-profile-access-btn');
                accessBtn.href = `http://${routerData.ip}`;
    
                const editBtn = document.getElementById('router-profile-edit-btn');
                editBtn.onclick = () => {
                    document.getElementById('routerProfileModal').classList.remove('active');
                    overlay.style.display = 'none';
                    // এডিট করার জন্য ফর্ম পূরণ করার পুরনো লজিক
                    document.getElementById('routerId').value = routerData.id;
                    document.getElementById('routerName').value = routerData.name;
                    document.getElementById('routerModel').value = routerData.model;
                    document.getElementById('routerIp').value = routerData.ip;
                    document.getElementById('routerDistanceFeet').value = routerData.distanceFeet || '';
                    document.getElementById('routerDistanceMeters').value = routerData.distanceMeters || '';
                    document.getElementById('routerPowerSpec').value = routerData.powerSpec || '';
                    document.getElementById('routerPassword').value = routerData.password || '';
                    document.getElementById('routerLocationSelect').value = routerData.location;
                    setMacAddress('routerMacContainer', routerData.macAddress || '');
                    formContainer.classList.add('active');
                    toggleFormBtn.textContent = 'ফর্ম লুকান';
                    formContainer.scrollIntoView({ behavior: 'smooth' });
                };
    
                // নতুন মডালটি দেখানো
                document.getElementById('routerProfileModal').classList.add('active');
                overlay.style.display = 'block';
            }
        }
    };
// নতুন রাউটার প্রোফাইল মডাল বন্ধ করার জন্য ইভেন্ট লিসেনার
        const routerProfileModal = document.getElementById('routerProfileModal');
        const routerProfileCloseBtn = document.getElementById('router-profile-close-btn');
        
        routerProfileCloseBtn.onclick = () => {
            routerProfileModal.classList.remove('active');
            overlay.style.display = 'none';
        };

        renderRouters();
      }

      document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          switchPage(item.dataset.page);
        });
      });

      function populateDropdown(elementId, options, config = {}) {
        const {
          defaultValue,
          isBengali = true
        } = config;
        const select = document.getElementById(elementId);
        if (!select) return;
        const currentValue = select.value;
        select.innerHTML = '';
        options.forEach(opt => {
          const option = document.createElement('option');
          if (typeof opt === 'object' && opt.value !== undefined) {
            option.value = opt.value;
            option.textContent = opt.text;
          } else {
            option.value = opt;
            if (opt === 'other') {
              option.textContent = 'অন্যান্য...';
            } else {
              option.textContent = isBengali ? toBengaliNumber(opt) : opt;
            }
          }
          select.appendChild(option);
        });
        if (defaultValue !== undefined) {
          select.value = defaultValue;
        } else if (currentValue) {
          select.value = currentValue;
        }
      }
      // ★★★ নতুন বিল রিমাইন্ডার ফাংশন (renderDashboard এর আগে যোগ করুন) ★★★

// --- checkAndDisplayBillReminder ফাংশনের চূড়ান্ত সংস্করণ (নতুন ফিচার সহ) ---

      function checkAndDisplayBillReminder() {
          if (notificationInterval) {
              clearInterval(notificationInterval);
              notificationInterval = null;
          }
      
          const notificationCard = document.getElementById('bill-reminder-notification');
          const contentWrapper = document.getElementById('bill-reminder-content-wrapper');
          const viewDueBtn = document.getElementById('view-due-bills-btn');
      
          if (!notificationCard || !contentWrapper || !viewDueBtn) return;
      
          const today = new Date();
          const currentMonth = today.getMonth();
          const currentYear = today.getFullYear();
          const allMessages = [];
      
          const overdueBills = db.bills
              .filter(bill => bill.status === 'unpaid' || bill.status === 'partially_paid')
              .map(bill => {
                  const billDate = bill.createdAt ? new Date(bill.createdAt) : new Date(bill.year, bill.month, 1);
                  const ageInDays = Math.floor(Math.abs(today - billDate) / (1000 * 60 * 60 * 24));
                  return { ...bill, billAgeInDays: ageInDays };
              })
              .filter(bill => bill.billAgeInDays >= 10);
      
          db.customers.forEach(customer => {
              const isActive = customer.isActive === undefined ? true : customer.isActive;
              if (!isActive || customer.isFree) return;
              const billExists = db.bills.some(bill => bill.customerId === customer.id && bill.year === currentYear && bill.month === currentMonth);
              if (billExists) return;
              const connectionDate = new Date(customer.connectionDate);
              const connectionAgeInDays = Math.ceil(Math.abs(today - connectionDate) / (1000 * 60 * 60 * 24));
              if (connectionAgeInDays > 40) {
                  allMessages.push({
                      type: 'generate_urgent',
                      text: `সতর্কতাঃ ${customer.name}-এর বিল এখনো তৈরি করা হয়নি!`,
                      color: '#D97706'
                  });
              } else if (connectionAgeInDays > 30) {
                  allMessages.push({
                      type: 'generate_normal',
                      text: `${customer.name}-এর বিল তৈরির সময় হয়েছে।`,
                      color: '#15803D'
                  });
              }
          });
      
          const previousMonth = currentMonth === 0 ? 11 : currentMonth - 1;
          const yearForIspCheck = currentMonth === 0 ? currentYear - 1 : currentYear;
          const isIspBillPaidForPreviousMonth = db.ispPayments.some(p => p.year === yearForIspCheck && p.month === previousMonth);
      
          let lastShownMessageIndex = -1;
      
          if (overdueBills.length > 0) {
    // বকেয়া বিলগুলোকে তাদের বয়স অনুযায়ী (সবচেয়ে পুরনো আগে) সাজানো হচ্ছে
              const sortedOverdueBills = overdueBills.sort((a, b) => b.billAgeInDays - a.billAgeInDays);
          
              sortedOverdueBills.forEach(bill => {
                  const customer = db.customers.find(c => c.id === bill.customerId);
                  if (!customer) return; // যদি গ্রাহক খুঁজে না পাওয়া যায়
          
                  const billAge = bill.billAgeInDays;
                  let messageColor = "";
                  let prefix = "বকেয়া"; // ডিফল্ট প্রিফিক্স
          
                  // আপনার চাহিদা অনুযায়ী সময়কাল এবং রঙের লজিক
                  if (billAge >= 30) {
                      // ৩০ দিন বা তার বেশি হলে (সবচেয়ে জরুরি)
                      messageColor = '#B91C1C'; // গাঢ় লাল
                      prefix = "জরুরি বকেয়া";
                  } else if (billAge >= 20) {
                      // ২০ থেকে ২৯ দিন হলে (সতর্কতা)
                      messageColor = '#B45309'; // হলুদ/কমলা
                      prefix = "পুরনো বকেয়া";
                  } else if (billAge >= 10) {
                      // ১০ থেকে ১৯ দিন হলে (সাধারণ)
                      messageColor = '#166534'; // সবুজ
                      prefix = "বকেয়া";
                  }
          
                  // মাসের নাম (যেহেতু প্রতিটি বিল স্বতন্ত্র, মাসের নাম দেখানো গুরুত্বপূর্ণ)
                  const monthText = ` (${months[bill.month]})`;
          
                  // চূড়ান্ত মেসেজ তৈরি (দিনের সংখ্যা ছাড়া)
                  const messageText = `${prefix}${monthText}: ${customer.name} (৳${toBengaliNumber(bill.remainingDue.toFixed(2))})`;
          
                  // মেসেজটি অ্যারেতে যোগ করা হচ্ছে
                  allMessages.push({
                      type: 'due',
                      text: messageText,
                      color: messageColor
                  });
              });
          }

          if (!isIspBillPaidForPreviousMonth) {
              if (db.ispPayments.length > 0 || today.getDate() >= 8) {
                  if (today.getDate() >= 15) {
                      allMessages.push({
                          type: 'isp_urgent',
                          text: `জরুরি সতর্কতাঃ ${months[previousMonth]} মাসের আইএসপি বিল এখনো পরিশোধ করা হয়নি!`,
                          color: '#DC2626'
                      });
                  } else if (today.getDate() >= 8) {
                      allMessages.push({
                          type: 'isp_warning',
                          text: `সতর্কতাঃ ${months[previousMonth]} মাসের আইএসপি বিল এখনো পরিশোধ করা হয়নি।`,
                          color: '#D97706'
                      });
                  }
              }
          }
      
          if (allMessages.length === 0) {
              notificationCard.style.display = 'none';
              return;
          }
      
          let mainTitle, mainBgColor, mainBorderColor, mainTitleColor, mainTextColor, buttonAction, buttonText;
          let targetMonth, targetYear;
      
          const hasUrgentIsp = allMessages.some(m => m.type === 'isp_urgent');
          const hasWarningIsp = allMessages.some(m => m.type === 'isp_warning');
          const hasDueBills = overdueBills.length > 0;
          const hasUrgentGenerate = allMessages.some(m => m.type === 'generate_urgent');
          const hasNormalGenerate = allMessages.some(m => m.type === 'generate_normal');
      
          if (hasUrgentIsp) {
              mainTitle = 'জরুরি সতর্কতা';
              mainBgColor = 'linear-gradient(135deg, #FEF2F2 0%, #FECACA 100%)';
              mainBorderColor = '#F87171';
              mainTitleColor = '#B91C1C';
              mainTextColor = '#991B1B';
          } else if (hasDueBills) {
              mainTitle = 'মনোযোগ দিনঃ বিল বকেয়া';
              mainBgColor = 'linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%)';
              mainBorderColor = '#FBBF24';
              mainTitleColor = '#B45309';
              mainTextColor = '#78350F';
          } else if (hasUrgentGenerate) {
              mainTitle = 'বিল তৈরিতে বিলম্ব';
              mainBgColor = 'linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 100%)';
              mainBorderColor = '#FB923C';
              mainTitleColor = '#C2410C';
              mainTextColor = '#9A3412';
          } else if (hasWarningIsp) {
              mainTitle = 'আইএসপি বিল রিমাইন্ডার';
              mainBgColor = 'linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 100%)';
              mainBorderColor = '#FB923C';
              mainTitleColor = '#C2410C';
              mainTextColor = '#9A3412';
          } else if (hasNormalGenerate) {
              mainTitle = 'বিল তৈরির রিমাইন্ডার';
              mainBgColor = 'linear-gradient(135deg, #F0FFF4 0%, #C6F6D5 100%)';
              mainBorderColor = '#38A169';
              mainTitleColor = '#166534';
              mainTextColor = '#14532D';
          }
      
          if (hasDueBills) {
              buttonAction = 'unpaid_list';
              buttonText = 'তালিকা দেখুন';
              const oldestDueBill = overdueBills.sort((a, b) => new Date(a.year, a.month) - new Date(b.year, b.month))[0];
              targetMonth = oldestDueBill.month;
              targetYear = oldestDueBill.year;
          } else if (hasUrgentGenerate || hasNormalGenerate) {
              buttonAction = 'billing';
              buttonText = 'বিল তৈরি করুন';
          } else {
              buttonAction = 'isp_bill';
              buttonText = 'আইএসপি বিল দিন';
          }
      
          notificationCard.style.background = mainBgColor;
          notificationCard.style.borderColor = mainBorderColor;
      
          const totalOverdueAmount = overdueBills.reduce((sum, bill) => sum + bill.remainingDue, 0);
          let mainText = '';
          if (hasDueBills) {
              const overdueMonths = [...new Set(overdueBills.map(b => {
                  if (b.month !== currentMonth || b.year !== currentYear) {
                      return months[b.month];
                  }
                  return null;
              }).filter(Boolean))];
              
              let monthInfoText = '';
              if (overdueMonths.length > 0) {
                  monthInfoText = ` (প্রধানত <strong>${overdueMonths.join(', ')}</strong> মাসের)`;
              }
      
              mainText = `<strong>${toBengaliNumber(overdueBills.length)} জন</strong> গ্রাহকের বিল বকেয়া রয়েছে${monthInfoText}। মোট বকেয়াঃ <strong>৳${toBengaliNumber(totalOverdueAmount.toFixed(2))}</strong>`;
          } else if (hasUrgentGenerate || hasNormalGenerate) {
              const totalToGenerate = allMessages.filter(m => m.type.startsWith('generate')).length;
              mainText = `<strong>${toBengaliNumber(totalToGenerate)} জন</strong> গ্রাহকের বিল তৈরি করা প্রয়োজন।`;
          } else if (hasWarningIsp || hasUrgentIsp) {
              mainText = `অনুগ্রহ করে ${months[previousMonth]} মাসের আইএসপি বিল পরিশোধ করুন।`;
          }
      
          contentWrapper.innerHTML = `
              <div id="main-notification-part">
                  <h4 style="margin: 0 0 5px 0; font-size: 14px; font-weight: 600; color: ${mainTitleColor};">${mainTitle}</h4>
                  <p style="margin: 0; color: ${mainTextColor}; font-size: 12px; line-height: 1.4;">${mainText}</p>
              </div>
              <div id="featured-biller-container" style="min-height: 15px; margin-top: 8px;">
                  <span id="dynamic-biller-info" style="font-size: 11px; font-weight: 600; transition: opacity 0.5s ease;"></span>
              </div>
          `;
      
          const updateDynamicInfo = () => {
              if (allMessages.length === 0) return;
              lastShownMessageIndex = (lastShownMessageIndex + 1) % allMessages.length;
              const message = allMessages[lastShownMessageIndex];
              const infoElement = document.getElementById('dynamic-biller-info');
              if (infoElement) {
                  infoElement.style.opacity = '0';
                  setTimeout(() => {
                      infoElement.textContent = message.text;
                      infoElement.style.color = message.color;
                      infoElement.style.opacity = '1';
                  }, 500);
              }
          };
      
          updateDynamicInfo();
          notificationInterval = setInterval(updateDynamicInfo, 5000);
      
          // --- এই নতুন কোডটি দিয়ে আপনার উপরের ব্লকটি প্রতিস্থাপন করুন ---

      viewDueBtn.textContent = buttonText;
      viewDueBtn.onclick = () => {
          if (buttonAction === 'unpaid_list') {
              // এই অংশ অপরিবর্তিত
              switchPage('billing');
              setTimeout(() => {
                  document.getElementById('generateMonth').value = targetMonth;
                  document.getElementById('generateYear').value = targetYear;
                  document.querySelector('#billing .filter-btn[data-filter="unpaid"]').click();
              }, 100);
          } else if (buttonAction === 'isp_bill') {
              // ★★★ মূল পরিবর্তন এখানে ★★★
              // আমরা এখন switchPage ফাংশনে অতিরিক্ত তথ্য (options) পাঠাচ্ছি
              // previousMonth এবং yearForIspCheck ভেরিয়েবল দুটি আপনার checkAndDisplayBillReminder ফাংশনে আগে থেকেই আছে
              switchPage('isp_bill', false, { 
                  month: previousMonth, 
                  year: yearForIspCheck 
              });
          } else {
              // এই অংশ অপরিবর্তিত
              switchPage('billing');
          }
      };
      
          notificationCard.style.display = 'flex';
      }

      function renderDashboard() {
          const today = new Date();
          const currentMonth = today.getMonth();
          const currentYear = today.getFullYear();
      
          const monthBills = db.bills.filter(b => b.month == currentMonth && b.year == currentYear);
          const totalCustomers = db.customers.filter(c => c.isActive !== false).length;
      
          const totalBillAmount = monthBills.reduce((sum, bill) => sum + (bill.totalAmount || 0), 0);
      
          let totalCashInflowThisMonth = 0;
          db.bills.forEach(bill => {
              if (bill.paymentHistory && bill.paymentHistory.length > 0) {
                  bill.paymentHistory.forEach(payment => {
                      const paymentDate = new Date(payment.date);
                      if (paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear) {
                          if (payment.source === 'manual' || payment.source === 'advance_deposit') {
                              totalCashInflowThisMonth += payment.amount;
                          }
                      }
                  });
              }
          });
      
          const totalUnpaid = monthBills.reduce((sum, bill) => sum + (bill.remainingDue || 0), 0);
      
          document.getElementById('db-total-customers').textContent = toBengaliNumber(totalCustomers);
          document.getElementById('db-total-bill').textContent = `৳${toBengaliNumber(totalBillAmount.toFixed(2))}`;
          document.getElementById('db-total-paid').textContent = `৳${toBengaliNumber(totalCashInflowThisMonth.toFixed(2))}`;
          document.getElementById('db-total-unpaid').textContent = `৳${toBengaliNumber(totalUnpaid.toFixed(2))}`;
      
          renderRecentActivities();
          checkAndDisplayBillReminder();
      }

      const customerForm = document.getElementById('customerForm');
      const customerIdInput = document.getElementById('customerId');
      const customerNameInput = document.getElementById('customerName');
      const customerPhoneInput = document.getElementById('customerPhone');
      const customerHouseInput = document.getElementById('customerHouse');
      const customerBillInput = document.getElementById('customerBill');
      const customBillGroup = document.getElementById('customBillGroup');
      const customBillAmountInput = document.getElementById('customBillAmount');
      const connectionDateInput = document.getElementById('connectionDate');
      const isFreeUserInput = document.getElementById('isFreeUser');
      const customerFormTitle = document.getElementById('customer-form-title');
      const customerSubmitBtn = document.getElementById('customer-submit-btn');
      const customerCancelBtn = document.getElementById('customer-cancel-btn');

      function initializeCustomerForm() {
        populateDropdown('customerHouse', db.locations, {
          isBengali: false
        });
        populateDropdown('customerBill', defaultBillAmounts);
        if (!customerIdInput.value) {
          connectionDateInput.valueAsDate = new Date();
        }
      }

      customerBillInput.addEventListener('change', () => {
        customBillGroup.classList.toggle('hidden', customerBillInput.value !== 'other');
      });

      function resetCustomerForm() {
        customerForm.reset();
        customerIdInput.value = '';
        customerFormTitle.textContent = 'নতুন গ্রাহক যোগ করুন';
        customerSubmitBtn.textContent = 'গ্রাহক যোগ করুন';
        connectionDateInput.valueAsDate = new Date();
        customBillGroup.classList.add('hidden');
        customerCancelBtn.style.display = 'none';
      }

      isFreeUserInput.addEventListener('change', () => {
        const billGroup = document.getElementById('customerBill').parentElement;
        billGroup.classList.toggle('hidden', isFreeUserInput.checked);
        if (isFreeUserInput.checked) {
          customerBillInput.required = false;
          customBillGroup.classList.add('hidden');
        } else {
          customerBillInput.required = true;
          customBillGroup.classList.toggle('hidden', customerBillInput.value !== 'other');
        }
      });

      customerForm.addEventListener('submit', (e) => {
          e.preventDefault();
      
          const customerPhone = document.getElementById('customerPhone').value.trim();
      
          if (customerPhone) {
              const bangladeshiPhoneRegex = /^(01[3-9])\d{8}$/;
              if (!bangladeshiPhoneRegex.test(customerPhone)) {
                  alert('ত্রুটি: অনুগ্রহ করে একটি সঠিক বাংলাদেশী মোবাইল নম্বর দিন।\nনম্বরটি অবশ্যই ০১৯, ০১৭, ০১৮, ০১৫, ০১৬, ০১৩, বা ০১৪ দিয়ে শুরু হতে হবে এবং মোট ১১ সংখ্যার হতে হবে।');
                  return;
              }
          }
      
          const customerId = document.getElementById('customerId').value;
          const customerName = document.getElementById('customerName').value.trim();
          const isFree = document.getElementById('isFreeUser').checked;
      
          if (!customerId) {
              const existingCustomer = db.customers.find(c => c.name.toLowerCase() === customerName.toLowerCase());
              if (existingCustomer) {
                  alert('এই নামে ইতিমধ্যে একজন গ্রাহক রয়েছে। দয়া করে অন্য নাম ব্যবহার করুন।');
                  return;
              }
          }
      
          let monthlyBill = 0;
          if (!isFree) {
              const billSelect = document.getElementById('customerBill');
              monthlyBill = billSelect.value === 'other' ?
                  parseFloat(document.getElementById('customBillAmount').value) :
                  parseFloat(billSelect.value);
          }
          const macAddress = getMacAddress('customerMacContainer');
      
          const customerData = {
              id: customerId || Date.now().toString(),
              name: customerName,
              phone: customerPhone,
              house: document.getElementById('customerHouse').value,
              monthlyBill,
              connectionDate: document.getElementById('connectionDate').value,
              isFree,
              macAddress,
              advanceBalance: 0,
              deactivationPending: false
          };
      
          if (customerId) {
              const index = db.customers.findIndex(c => c.id === customerId);
              customerData.advanceBalance = db.customers[index].advanceBalance;
              db.customers[index] = customerData;
              alert('গ্রাহকের তথ্য সফলভাবে আপডেট করা হয়েছে।');
              showBackupReminder();
          } else {
              db.customers.push(customerData);
              alert('নতুন গ্রাহক সফলভাবে যোগ করা হয়েছে।');
              addActivity('customer_added', `${customerName} নামে নতুন গ্রাহক যোগ করা হয়েছে`, {
                  customerName: customerName,
                  location: customerData.house,
                  amount: monthlyBill,
                  isFree: isFree
              });
              showBackupReminder();
          }
          saveDb();
          resetCustomerForm();
          switchPage('customers');
      });

      customerCancelBtn.addEventListener('click', () => {
        resetCustomerForm();
        switchPage('customers');
      });

      // এই সম্পূর্ণ নতুন ফাংশনটি আপনার পুরনো getCustomerStatus ফাংশনের জায়গায় বসবে

      function getCustomerStatus(customer) { // এখানে 'customer' অবজেক্টটিই গ্রহণ করা হচ্ছে
        if (!customer) return {
          text: 'Unknown',
          class: '',
          sortOrder: 99
        };

        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();

        const currentBill = db.bills.find(b =>
          b.customerId === customer.id && // customer.id ব্যবহার করা হচ্ছে
          b.year === currentYear &&
          b.month === currentMonth
        );

        if (customer.isFree) {
          return {
            text: 'ফ্রি',
            class: 'status-free',
            sortOrder: 4
          };
        }

        if (currentBill) {
          // --- যদি চলতি মাসের বিল তৈরি হয়ে থাকে ---
          if (currentBill.status === 'paid') {
            if (customer.advanceBalance > 0) {
              return {
                text: `অ্যাডভান্স: ৳${toBengaliNumber(customer.advanceBalance.toFixed(2))}`,
                class: 'status-advance',
                sortOrder: 3
              };
            }
            return {
              text: 'Paid',
              class: 'status-paid',
              sortOrder: 5
            };
          }

          if (currentBill.status === 'partially_paid') {
            return {
              text: `বকেয়া: ৳${toBengaliNumber(currentBill.remainingDue.toFixed(2))}`,
              class: 'status-unpaid',
              sortOrder: 2
            };
          }

          // যদি স্ট্যাটাস 'unpaid' হয়
          return {
            text: `বকেয়া: ৳${toBengaliNumber(currentBill.remainingDue.toFixed(2))}`,
            class: 'status-unpaid',
            sortOrder: 1
          };

        } else {
          // --- যদি চলতি মাসের বিল তৈরি না হয়ে থাকে ---
          if (customer.advanceBalance > 0) {
            return {
              text: `অ্যাডভান্স: ৳${toBengaliNumber(customer.advanceBalance.toFixed(2))}`,
              class: 'status-advance',
              sortOrder: 3
            };
          }

          // বিল তৈরি হয়নি এবং কোনো অ্যাডভান্সও নেই
          return {
            text: 'Pending',
            class: 'status-pending',
            sortOrder: 6
          };
        }
      }

      function renderCustomerListPage(searchTerm = '', filter = 'all') {
          const container = document.getElementById('customer-list-by-house');
          container.innerHTML = '';
      
          let customersToDisplay = db.customers;
          if (searchTerm) {
              const lowerCaseSearchTerm = searchTerm.toLowerCase();
              customersToDisplay = customersToDisplay.filter(c =>
                  c.name.toLowerCase().includes(lowerCaseSearchTerm) ||
                  (c.phone && c.phone.includes(searchTerm))
              );
          }
      
          document.getElementById('total-customer-count').textContent = toBengaliNumber(customersToDisplay.length);
      
          if (customersToDisplay.length === 0) {
              container.innerHTML =
                  '<p style="text-align:center; color:#718096; margin-top: 20px;">কোনো গ্রাহক পাওয়া যায়নি।</p>';
              return;
          }
      
          const houseGroups = {};
          customersToDisplay.forEach(customer => {
              if (!houseGroups[customer.house]) {
                  houseGroups[customer.house] = [];
              }
              houseGroups[customer.house].push(customer);
          });
      
          const sortedHouses = Object.keys(houseGroups).sort((a, b) => db.locations.indexOf(a) - db.locations.indexOf(
              b));
      
          sortedHouses.forEach(house => {
              let houseCustomers = houseGroups[house];
              if (houseCustomers.length === 0) return;
      
              houseCustomers = houseCustomers.map(customer => ({
                      ...customer,
                      statusInfo: getCustomerStatus(customer)
                  }))
                  .sort((a, b) => a.statusInfo.sortOrder - b.statusInfo.sortOrder);
      
              const card = document.createElement('div');
              card.className = 'card';
              card.innerHTML =
                  `<h2>${house} (${toBengaliNumber(houseCustomers.length)} জন)</h2><div class="table-container"><table class="data-table"><thead><tr><th>নাম</th><th>মাসিক বিল</th><th>স্ট্যাটাস</th><th>একশন</th></tr></thead><tbody></tbody></table></div>`;
              const tableBody = card.querySelector('tbody');
      
              houseCustomers.forEach(customer => {
                  const row = document.createElement('tr');
      
                  let actionButtons;
                  if (customer.isActive === false) {
                      row.style.backgroundColor = '#FFF1F2';
                      row.style.color = '#881337';
                      actionButtons =
                          `<button class="btn action-btn" style="background-color: #28a745;" onclick="reactivateCustomer('${customer.id}')">সক্রিয় করুন</button>`;
                  } else {
                      actionButtons = `
                          <button class="btn action-btn" style="background-color: #3182CE;" onclick="editCustomer('${customer.id}')">Edit</button>
                          <button class="btn btn-delete action-btn" onclick="deleteCustomer('${customer.id}')">Del</button>
                      `;
                  }
      
                  row.innerHTML = `
                      <td><a href="#" class="customer-name-link" onclick="openCustomerProfile(event, '${customer.id}')">${customer.name}</a></td>
                      <td>৳${toBengaliNumber(customer.monthlyBill.toFixed(2))}</td>
                      <td class="${customer.statusInfo.class}">${customer.statusInfo.text}</td>
                      <td>${actionButtons}</td>
                  `;
                  tableBody.appendChild(row);
              });
              container.appendChild(card);
          });
          const lastScrollPosition = sessionStorage.getItem('lastScrollPosition');
          if (lastScrollPosition) {
              setTimeout(() => {
                  window.scrollTo(0, parseInt(lastScrollPosition, 10));
                  sessionStorage.removeItem('lastScrollPosition');
              }, 100);
          }
      }

      document.getElementById('customer-search-input').addEventListener('input', (e) => renderCustomerListPage(e
        .target.value));

      window.editCustomer = (id) => {
          sessionStorage.setItem('lastScrollPosition', window.scrollY);
          
          customerToEditId = id;
          switchPage('add_customer');
      };

      window.deleteCustomer = (id) => {
        if (confirm('আপনি কি নিশ্চিতভাবে এই গ্রাহককে মুছে ফেলতে চান? এই গ্রাহকের সকল বিলের তথ্যও মুছে যাবে।')) {
          const customer = db.customers.find(c => c.id === id);
          const customerName = customer ? customer.name : 'অজানা গ্রাহক';

          db.customers = db.customers.filter(c => c.id !== id);
          db.bills = db.bills.filter(b => b.customerId !== id);

          // Add activity log for customer deleted
          addActivity('customer_deleted', `গ্রাহক মুছে ফেলা হয়েছে: ${customerName}`, {
            customerName: customerName,
            customerId: id
          });

          saveDb();
          renderCustomerListPage(document.getElementById('customer-search-input').value);
          renderDashboard();
        }
      };
      const generateBillsBtn = document.getElementById('generateBillsBtn');
      const deleteMonthBillsBtn = document.getElementById('delete-month-bills-btn');
      const billingListContainer = document.getElementById('billing-list-by-house');

      const adjustmentModal = document.getElementById('adjustmentModal');
      const adjustmentModalClose = document.getElementById('adjustment-modal-close');
      const adjustmentForm = document.getElementById('adjustmentForm');
      const adjustmentList = document.getElementById('adjustment-list');
      const adjustmentFormTitle = document.getElementById('adjustment-form-title');
      const adjustmentSubmitBtn = document.getElementById('adjustment-submit-btn');
      const adjustmentCancelBtn = document.getElementById('adjustment-cancel-btn');

      const ispEditModal = document.getElementById('ispEditModal');
      const ispEditModalClose = document.getElementById('isp-edit-modal-close');
      const ispEditForm = document.getElementById('ispEditForm');

      function initializeBillingForm() {
        const monthOptions = months.map((m, i) => ({
          value: i,
          text: m
        }));
        populateDropdown('generateYear', years, {
          defaultValue: new Date().getFullYear()
        });
        populateDropdown('generateMonth', monthOptions, {
          defaultValue: new Date().getMonth()
        });

        const customerOptions = [{
          value: 'all',
          text: 'সকল গ্রাহক'
        }].concat(
          db.customers.sort((a, b) => a.name.localeCompare(b.name)).map(c => ({
            value: c.id,
            text: `${c.name} (${c.house.split('ঃ')[0]})`
          }))
        );
        populateDropdown('generateForCustomer', customerOptions, {
          defaultValue: 'all'
        });
      }

      function renderBillingPage() {
          const year = parseInt(document.getElementById('generateYear').value);
          const month = parseInt(document.getElementById('generateMonth').value);
          const searchTerm = document.getElementById('billing-search-input').value;
          const activeFilterBtn = document.querySelector('#billing .filter-btn.active');
          const filterType = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
      
          const today = new Date();
          const isReadOnly = !(year === today.getFullYear() && month === today.getMonth());
      
          document.getElementById('generateBillsBtn').disabled = isReadOnly;
          document.getElementById('delete-month-bills-btn').disabled = isReadOnly;
          document.getElementById('generateForCustomer').disabled = isReadOnly;
      
          renderBillingTable(year, month, searchTerm, filterType);
      }

      // এই নতুন কোডটি আপনার পুরনো renderBillingTable ফাংশনের জায়গায় বসবে

      function renderBillingTable(year, month, searchTerm = '', filter = 'all') {
          const isChronicDefaulter = (customerId) => {
              const LATE_DAYS_THRESHOLD = 15;
              const LATE_COUNT_THRESHOLD = 3;
              const HISTORY_MONTHS = 6;
              const sixMonthsAgo = new Date();
              sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - HISTORY_MONTHS);
              const recentBills = db.bills.filter(bill =>
                  bill.customerId === customerId &&
                  new Date(bill.year, bill.month) >= sixMonthsAgo
              );
              const latePayments = recentBills.filter(bill => {
                  if (!bill.createdAt) return false;
                  const paymentDate = (bill.paymentHistory && bill.paymentHistory.length > 0) ?
                  new Date(bill.paymentHistory.find(p => p.source === 'manual')?.date || bill.createdAt) :
                  new Date();
                  const creationDate = new Date(bill.createdAt);
                  const diffTime = paymentDate - creationDate;
                  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                  return diffDays > LATE_DAYS_THRESHOLD;
              });
              return latePayments.length >= LATE_COUNT_THRESHOLD;
          };
      
          billingListContainer.innerHTML = '';
          let monthBills = db.bills.filter(b => b.year == year && b.month == month);
      
          if (searchTerm) {
              monthBills = monthBills.filter(bill => {
                  const customer = db.customers.find(c => c.id === bill.customerId);
                  return customer && customer.name.toLowerCase().includes(searchTerm.toLowerCase());
              });
          }
      
          if (filter === 'unpaid') {
              monthBills = monthBills.filter(b => b.status === 'unpaid' || b.status === 'partially_paid');
          }
      
          const statusPriority = { 'unpaid': 1, 'partially_paid': 2, 'paid': 3 };
          monthBills.sort((a, b) => (statusPriority[a.status] || 99) - (statusPriority[b.status] || 99));
      
          const today = new Date();
          const isReadOnly = !(parseInt(year) === today.getFullYear() && parseInt(month) === today.getMonth());
      
          db.locations.forEach(house => {
              const houseBills = monthBills.filter(bill => {
                  const customer = db.customers.find(c => c.id === bill.customerId);
                  return customer && customer.house === house;
              });
      
              if (houseBills.length === 0) return;
      
              const unpaidCount = houseBills.filter(b => b.status !== 'paid').length;
              const unpaidText = unpaidCount > 0 ? `<span class="unpaid-count">(${toBengaliNumber(unpaidCount)} জন বিল দেয়নি)</span>` : '';
      
              const card = document.createElement('div');
              card.className = 'card';
              card.innerHTML = `<h2>${house} ${unpaidText}</h2><div class="table-container"><table class="data-table"><thead><tr><th>গ্রাহক</th><th>মাসিক বিল</th><th>বকেয়া</th><th>এডভ্যান্স</th><th>মোট বিল</th><th>স্ট্যাটাস</th><th>একশন</th></tr></thead><tbody></tbody></table></div>`;
              const tableBody = card.querySelector('tbody');
      
              houseBills.forEach(bill => {
                  const customer = db.customers.find(c => c.id === bill.customerId);
                  if (!customer) return;
      
                  const isDefaulter = isChronicDefaulter(customer.id);
                  const defaulterIcon = isDefaulter ? '<span title="এই গ্রাহক প্রায়ই দেরিতে বিল পরিশোধ করেন"> 🚩</span>' : '';
                  const dueFromAdjustments = (bill.adjustments || []).filter(a => a.type === 'due').reduce((sum, a) => sum + a.amount, 0);
                  const finalTotalAmount = bill.monthlyAmount + bill.dueAmount + dueFromAdjustments;
      
                  let dueForDisplay = 0;
                  let statusText, statusClass;
      
                  if (bill.status === 'paid') {
                      statusText = 'Paid';
                      statusClass = 'status-paid';
                      dueForDisplay = 0;
                  } else if (bill.status === 'partially_paid') {
                      statusText = 'Partially Paid';
                      statusClass = 'status-partially-paid';
                      dueForDisplay = bill.remainingDue;
                  } else {
                      statusText = 'Unpaid';
                      statusClass = 'status-unpaid';
                      dueForDisplay = bill.dueAmount + dueFromAdjustments;
                  }
      
                  // --- ★★★ মূল পরিবর্তন এখানে ★★★ ---
                  // বাটনগুলোকে নিষ্ক্রিয় করার জন্য disabled অ্যাট্রিবিউট যোগ করা হচ্ছে
                  // --- এই নতুন কোডটি দিয়ে প্রতিস্থাপন করুন ---
                  const deleteDisabledAttribute = isReadOnly ? 'disabled' : '';
                  
                  const actionButtonsHtml = `
                      <button class="btn btn-submit action-btn payment-action-btn" data-bill-id="${bill.id}" data-readonly="${isReadOnly}">পেমেন্ট</button>
                      <button class="btn btn-submit action-btn" onclick="openAdjustmentModal('${bill.id}', ${isReadOnly})">Adj</button>
                      <button class="btn btn-delete action-btn" onclick="deleteBill('${bill.id}')" ${deleteDisabledAttribute}>Del</button>
                  `;

                  const row = document.createElement('tr');
                  row.innerHTML = `
                      <td><a href="#" class="customer-name-link" onclick="openCustomerProfile(event, '${customer.id}')">${customer.name}</a>${defaulterIcon}</td>
                      <td>৳${toBengaliNumber(bill.monthlyAmount.toFixed(2))}</td>
                      <td>৳${toBengaliNumber(dueForDisplay.toFixed(2))}</td>
                      <td>৳${toBengaliNumber((customer.advanceBalance || 0).toFixed(2))}</td>
                      <td><strong>৳${toBengaliNumber(finalTotalAmount.toFixed(2))}</strong></td>
                      <td class="${statusClass}">${statusText}</td>
                      <td>${actionButtonsHtml}</td>
                  `;
                  tableBody.appendChild(row);
              });
              billingListContainer.appendChild(card);
          });
      // --- এই নতুন কোডটি দিয়ে উপরের ব্লকটি প্রতিস্থাপন করুন ---

        document.querySelectorAll('.payment-action-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                const billId = event.target.getAttribute('data-bill-id');
                // ★★★ মূল পরিবর্তন: isReadOnly স্ট্যাটাসটি বাটন থেকে পড়া হচ্ছে ★★★
                const isReadOnly = event.target.getAttribute('data-readonly') === 'true';
                openPaymentModal(billId, isReadOnly);
            });
        });
      }

      // --- আপনার পুরনো সম্পূর্ণ createBillForCustomer ফাংশনটি মুছে, এই নতুন কোডটি পেস্ট করুন ---

      function createBillForCustomer(customer, year, month) {
        if (customer.isFree) return;

        // --- উপরের পুরনো কোডটি সরিয়ে এই নতুন এবং সঠিক কোডটি বসান ---

                // ★★★ নতুন এবং নির্ভুল বকেয়া খোঁজার চূড়ান্ত লজিক ★★★
        const allCustomerBills = db.bills
            .filter(b => b.customerId === customer.id)
            .sort((a, b) => new Date(a.year, a.month) - new Date(a.year, a.month));

        let dueFromPrevious = 0;
        if (allCustomerBills.length > 0) {
            const lastBill = allCustomerBills[allCustomerBills.length - 1];
            
            // সর্বশেষ বিলের সকল উপাদান (ডিসকাউন্ট, অ্যাডজাস্টমেন্ট সহ) বিবেচনা করে নির্ভুল বকেয়া হিসাব করা হচ্ছে
            const dueFromAdjustments = (lastBill.adjustments || []).filter(a => a.type === 'due').reduce((sum, a) => sum + a.amount, 0);
            const totalAmountOfLastBill = lastBill.monthlyAmount + (lastBill.dueAmount || 0) + dueFromAdjustments;
            const finalRemainingDue = totalAmountOfLastBill - (lastBill.paidAmount || 0) - (lastBill.discount || 0);

            if (finalRemainingDue > 0) {
                dueFromPrevious = finalRemainingDue;
            }
        }
        // ★★★ নতুন লজিকের শেষ ★★★

// ★★★ নতুন এবং উন্নত বকেয়া খোঁজার লজিক শেষ ★★★

        let monthlyAmount = customer.monthlyBill;
        let totalAmount = monthlyAmount + dueFromPrevious;
        let status = 'unpaid';
        let advanceUsed = 0;
        let paidAmount = 0;
        let remainingDue = totalAmount;
        let paymentHistoryForBill = []; // ★ নতুন: এই বিলের জন্য পেমেন্ট ইতিহাস

        // অ্যাডভান্স ব্যালেন্স ব্যবহারের নতুন এবং উন্নত লজিক
        if (customer.advanceBalance > 0) {
          const amountToUseFromAdvance = Math.min(customer.advanceBalance, totalAmount);

          advanceUsed = amountToUseFromAdvance;
          customer.advanceBalance -= amountToUseFromAdvance;
          paidAmount = amountToUseFromAdvance;
          remainingDue = totalAmount - amountToUseFromAdvance;

          // ★★★ মূল পরিবর্তন: অ্যাডভান্স ব্যবহারের জন্য ইতিহাসে এন্ট্রি যোগ ★★★
          paymentHistoryForBill.push({
            id: Date.now() + Math.random(),
            amount: amountToUseFromAdvance,
            date: new Date().toISOString(),
            source: 'advance', // উৎস: অ্যাডভান্স
            balanceAfter: remainingDue
          });

          status = remainingDue <= 0 ? 'paid' : 'partially_paid';
        }

        db.bills.push({
          id: Date.now().toString() + customer.id,
          customerId: customer.id,
          year: parseInt(year),
          month: parseInt(month),
          createdAt: new Date().toISOString(),
          monthlyAmount: monthlyAmount,
          dueAmount: dueFromPrevious,
          totalAmount: totalAmount,
          status: status,
          paidAmount: paidAmount,
          remainingDue: remainingDue,
          adjustments: [],
          advanceUsed: advanceUsed,
          isPaid: status === 'paid',
          paymentHistory: paymentHistoryForBill,
          discount: 0
        });
      }

      generateBillsBtn.addEventListener('click', () => {
          const year = parseInt(document.getElementById('generateYear').value);
          const month = parseInt(document.getElementById('generateMonth').value);
          const customerId = document.getElementById('generateForCustomer').value;
      
          if (db.customers.length === 0) {
              alert('এই মুহূর্তে সিস্টেমে কোন গ্রাহক নেই তাই বিল তৈরি করা যাচ্ছে না');
              return;
          }
      
          if (customerId === 'all') {
              // সকল গ্রাহকের জন্য বিল তৈরির লজিক (এটি অপরিবর্তিত থাকবে)
              const existingBilledCustomerIds = new Set(db.bills.filter(b => b.year === year && b.month === month).map(b => b.customerId));
              const customersToBill = db.customers.filter(customer => {
                  const isActive = customer.isActive === undefined ? true : customer.isActive;
                  if (!isActive || customer.isFree || existingBilledCustomerIds.has(customer.id)) {
                      return false;
                  }
                  const connectionDate = new Date(customer.connectionDate);
                  const today = new Date();
                  const diffTime = Math.abs(today - connectionDate);
                  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                  return diffDays > 30;
              });
      
              if (customersToBill.length === 0) {
                  alert('এই মুহূর্তে বিল তৈরির জন্য যোগ্য কোনো গ্রাহক পাওয়া যায়নি। (যাদের সংযোগের বয়স ৩০ দিনের বেশি এবং বিল তৈরি হয়নি)');
                  return;
              }
      
              customersToBill.forEach(customer => createBillForCustomer(customer, year, month));
              alert(`${toBengaliNumber(customersToBill.length)} জন যোগ্য গ্রাহকের জন্য বিল সফলভাবে তৈরি করা হয়েছে।`);
              addActivity('bill_created', `${toBengaliNumber(customersToBill.length)} জন গ্রাহকের জন্য বিল তৈরি করা হয়েছে`, {
                  month: month,
                  year: year,
                  customerCount: customersToBill.length
              });
              showBackupReminder();
      
          } else {
              // --- নির্দিষ্ট গ্রাহকের জন্য বিল তৈরির সংশোধিত লজিক ---
              const customer = db.customers.find(c => c.id === customerId);
              if (customer) {
                  // ★★★ সমাধান: প্রথমেই চেক করা হচ্ছে গ্রাহক ফ্রি কি না ★★★
                  if (customer.isFree) {
                      alert(`এটি একজন ফ্রি ইউজার। "${customer.name}"-এর জন্য কোনো বিল তৈরি করা হয়নি।`);
                      return; // ফাংশন থেকে বের হয়ে যাওয়া হচ্ছে
                  }
      
                  const isActive = customer.isActive === undefined ? true : customer.isActive;
                  if (!isActive) {
                      alert(`${customer.name}-এর সংযোগটি নিষ্ক্রিয় আছে। নিষ্ক্রিয় গ্রাহকের জন্য বিল তৈরি করা যাবে না।`);
                      return;
                  }
      
                  const connectionDate = new Date(customer.connectionDate);
                  const today = new Date();
                  const diffTime = Math.abs(today - connectionDate);
                  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
                  if (diffDays <= 30) {
                      if (diffDays < 25) {
                          alert(`বিল তৈরি করা সম্ভব নয়। ${customer.name}-এর সংযোগের বয়স এখনো ২৫ দিন পূর্ণ হয়নি।`);
                          return;
                      }
                      const proceed = confirm(`সতর্কবার্তা: ${customer.name}-এর সংযোগের বয়স এখনো ৩০ দিন পূর্ণ হয়নি (বর্তমান বয়স ${toBengaliNumber(diffDays)} দিন)। \n\nআপনি কি বিলটি তৈরি করতে চান?`);
                      if (!proceed) {
                          return;
                      }
                  }
      
                  const existingBillIndex = db.bills.findIndex(b => b.customerId === customer.id && b.year === year && b.month === month);
                  if (existingBillIndex > -1) {
                      if (!confirm(`${customer.name}-এর বিল এই মাসের জন্য ইতিমধ্যে তৈরি করা আছে। আপনি কি এটি মুছে আবার তৈরি করতে চান?`)) return;
                      db.bills.splice(existingBillIndex, 1);
                  }
      
                  createBillForCustomer(customer, year, month);
                  alert(`${customer.name}-এর জন্য বিল সফলভাবে তৈরি করা হয়েছে।`); // এখন এই বার্তাটি শুধুমাত্র বিল তৈরি হলেই দেখাবে
      
                  addActivity('bill_created', `${customer.name}-এর জন্য বিল তৈরি করা হয়েছে`, {
                      customerName: customer.name,
                      month: month,
                      year: year,
                      amount: customer.monthlyBill
                  });
                  showBackupReminder();
              }
          }
      
          saveDb();
          renderBillingPage();
      });

      deleteMonthBillsBtn.addEventListener('click', () => {
        const year = parseInt(document.getElementById('generateYear').value);
        const month = parseInt(document.getElementById('generateMonth').value);
        const monthName = months[month];
        if (confirm(
            `সতর্কতা! আপনি কি নিশ্চিতভাবে ${monthName}, ${toBengaliNumber(year)}-এর সকল বিল মুছে ফেলতে চান? এই কাজটি ফেরানো যাবে না।`
            )) {
          const deletedBills = db.bills.filter(b => b.year === year && b.month === month);
          const deletedCount = deletedBills.length;

          db.bills = db.bills.filter(b => b.year !== year || b.month !== month);

          // Add activity log for month bills deleted
          addActivity('month_bills_deleted',
            `মাসিক সব বিল মুছে ফেলা হয়েছে: ${monthName} ${year} (${deletedCount} টি বিল)`, {
              month: month,
              year: year,
              deletedCount: deletedCount
            });

          saveDb();
          alert(`${monthName}, ${toBengaliNumber(year)}-এর সকল বিল সফলভাবে মুছে ফেলা হয়েছে।`);
          renderBillingPage();
          renderDashboard();
        }
      });

      window.toggleBillStatus = (billId) => {
        const bill = db.bills.find(b => b.id === billId);
        if (bill) {
          bill.isPaid = !bill.isPaid;
          saveDb();
          renderBillingPage();
          renderDashboard();
        }
      };

// --- এই সম্পূর্ণ ফাংশনটি দিয়ে আপনার পুরনো renderAdjustments ফাংশনটি প্রতিস্থাপন করুন ---

      function renderAdjustments(billId, isReadOnly = false) {
          const bill = db.bills.find(b => b.id === billId);
          adjustmentList.innerHTML = '';
          if (!bill || !bill.adjustments || bill.adjustments.length === 0) {
              adjustmentList.innerHTML = '<li>কোনো অ্যাডজাস্টমেন্ট পাওয়া যায়নি।</li>';
              return;
          }
      
          // ★★★ এখানে পরিবর্তন শুরু ★★★
          const disabledAttribute = isReadOnly ? 'disabled' : '';
          // ★★★ এখানে পরিবর্তন শেষ ★★★
      
          bill.adjustments.forEach(adj => {
              const li = document.createElement('li');
              const typeText = adj.type === 'due' ? 'বকেয়া' : 'অ্যাডভান্স';
              li.innerHTML = `
                  <span class="adjustment-info">${typeText}: ৳${toBengaliNumber(adj.amount)} (${adj.notes || 'N/A'})</span>
                  <div class="adjustment-actions">
                      <button class="btn action-btn" style="background-color: #3182CE;" onclick="editAdjustment('${bill.id}', '${adj.id}')" ${disabledAttribute}>Edit</button>
                      <button class="btn btn-delete action-btn" onclick="deleteAdjustment('${bill.id}', '${adj.id}')" ${disabledAttribute}>Del</button>
                  </div>
              `;
              adjustmentList.appendChild(li);
          });
      }

// --- এই সম্পূর্ণ ফাংশনটি দিয়ে আপনার পুরনো openAdjustmentModal ফাংশনটি প্রতিস্থাপন করুন ---

      window.openAdjustmentModal = (billId, isReadOnly = false) => {
          const bill = db.bills.find(b => b.id === billId);
          const customer = db.customers.find(c => c.id === bill.customerId);
          if (bill && customer) {
              document.getElementById('adjustmentBillId').value = bill.id;
              document.getElementById('modal-customer-name-adj').textContent = customer.name;
              
              resetAdjustmentForm();
              renderAdjustments(bill.id, isReadOnly); // isReadOnly পাস করা হচ্ছে
      
              // ★★★ এখানে পরিবর্তন শুরু ★★★
              const amountInput = document.getElementById('adjustmentAmount');
              const typeSelect = document.getElementById('adjustmentType');
              const notesInput = document.getElementById('adjustmentNotes');
              const submitBtn = document.getElementById('adjustment-submit-btn');
              const noteTags = document.querySelectorAll('.note-tag');
      
              // রিড-অনলি মোডের জন্য লজিক যোগ করা হয়েছে
              if (isReadOnly) {
                  amountInput.disabled = true;
                  typeSelect.disabled = true;
                  notesInput.disabled = true;
                  submitBtn.disabled = true;
                  noteTags.forEach(tag => tag.style.pointerEvents = 'none'); // ট্যাগ ক্লিক করা বন্ধ করা
                  amountInput.placeholder = "শুধুমাত্র দেখার জন্য";
              } else {
                  amountInput.disabled = false;
                  typeSelect.disabled = false;
                  notesInput.disabled = false;
                  submitBtn.disabled = false;
                  noteTags.forEach(tag => tag.style.pointerEvents = 'auto'); // ট্যাগ ক্লিক করা চালু করা
                  amountInput.placeholder = "টাকার পরিমাণ লিখুন";
              }
              // ★★★ এখানে পরিবর্তন শেষ ★★★
      
              adjustmentModal.classList.add('active');
              overlay.style.display = 'block';
          }
      };

      function closeAdjustmentModal() {
        adjustmentModal.classList.remove('active');
        overlay.style.display = 'none';
      }
      adjustmentModalClose.addEventListener('click', closeAdjustmentModal);

      function resetAdjustmentForm() {
        adjustmentForm.reset();
        document.getElementById('adjustmentId').value = '';
        adjustmentFormTitle.textContent = 'নতুন অ্যাডজাস্টমেন্ট যোগ করুন';
        adjustmentSubmitBtn.textContent = 'সংরক্ষণ করুন';
        adjustmentCancelBtn.style.display = 'none';
      }
      adjustmentCancelBtn.addEventListener('click', resetAdjustmentForm);

      window.editAdjustment = (billId, adjId) => {
        const bill = db.bills.find(b => b.id === billId);
        const adj = bill.adjustments.find(a => a.id === adjId);
        if (adj) {
          document.getElementById('adjustmentId').value = adj.id;
          document.getElementById('adjustmentAmount').value = adj.amount;
          document.getElementById('adjustmentType').value = adj.type;
          document.getElementById('adjustmentNotes').value = adj.notes;
          adjustmentFormTitle.textContent = 'অ্যাডজাস্টমেন্ট এডিট করুন';
          adjustmentSubmitBtn.textContent = 'আপডেট করুন';
          adjustmentCancelBtn.style.display = 'inline-block';
        }
      };

      window.deleteAdjustment = (billId, adjId) => {
        if (confirm('আপনি কি নিশ্চিতভাবে এই অ্যাডজাস্টমেন্টটি মুছে ফেলতে চান?')) {
          const bill = db.bills.find(b => b.id === billId);
          const adj = bill.adjustments.find(a => a.id === adjId);
          const customer = db.customers.find(c => c.id === bill.customerId);

          if (adj.type === 'advance') {
            customer.advanceBalance -= adj.amount;
          }

          bill.adjustments = bill.adjustments.filter(a => a.id !== adjId);

          // Add activity log for adjustment deleted
          const typeText = adj.type === 'due' ? 'বকেয়া' : 'অ্যাডভান্স';
          addActivity('adjustment_deleted',
            `অ্যাডজাস্টমেন্ট মুছে ফেলা হয়েছে: ${customer.name} - ${typeText} ৳${adj.amount}`, {
              customerName: customer.name,
              adjustmentType: adj.type,
              amount: adj.amount,
              notes: adj.notes
            });

          recalculateBillTotal(billId);
          saveDb();
          renderAdjustments(billId);
          renderBillingPage();
        }
      };

      // এই নতুন কোডটি আপনার পুরনো adjustmentForm.addEventListener এর জায়গায় বসবে

      adjustmentForm.addEventListener('submit', e => {
        e.preventDefault();
        const billId = document.getElementById('adjustmentBillId').value;
        const adjId = document.getElementById('adjustmentId').value;
        const amount = parseFloat(document.getElementById('adjustmentAmount').value);
        const type = document.getElementById('adjustmentType').value;
        const notes = document.getElementById('adjustmentNotes').value;
        const bill = db.bills.find(b => b.id === billId);
        const customer = db.customers.find(c => c.id === bill.customerId);

        if (!bill || !customer || isNaN(amount) || amount <= 0) {
          alert("অনুগ্রহ করে সঠিক তথ্য দিন।");
          return;
        }

        if (adjId) {
          const adjIndex = bill.adjustments.findIndex(a => a.id === adjId);
          if (adjIndex > -1) {
            const oldAdj = bill.adjustments[adjIndex];
            if (oldAdj.type === 'advance') {
              customer.advanceBalance -= oldAdj.amount;
            }
            bill.adjustments[adjIndex] = {
              ...oldAdj,
              amount,
              type,
              notes
            };
          }
        } else {
          if (!bill.adjustments) {
            bill.adjustments = [];
          }
          bill.adjustments.push({
            id: Date.now().toString() + Math.random(),
            amount,
            type,
            notes
          });
        }

        if (type === 'advance') {
          customer.advanceBalance = (customer.advanceBalance || 0) + amount;
          addActivity('advance_deposit', `${customer.name}-এর অ্যাকাউন্টে অ্যাডভান্স জমা হয়েছে`, {
            customerName: customer.name,
            amount: amount,
            notes: notes
          });
        } else {
          addActivity('due_adjustment', `${customer.name}-এর বকেয়া সমন্বয় করা হয়েছে`, {
            customerName: customer.name,
            amount: amount,
            notes: notes
          });
        }

        recalculateBillTotal(billId);
        saveDb();
        renderAdjustments(billId);
        renderBillingPage();
        renderCustomerListPage();
        resetAdjustmentForm();
        alert("সমন্বয় সফলভাবে সম্পন্ন হয়েছে!");
      });

      document.querySelectorAll('.note-tag').forEach(tag => {
        tag.addEventListener('click', () => {
          document.getElementById('adjustmentNotes').value = tag.dataset.note;
        });
      });

      window.deleteBill = (billId) => {
        if (confirm('আপনি কি নিশ্চিতভাবে এই বিলটি মুছে ফেলতে চান?')) {
          const billIndex = db.bills.findIndex(b => b.id === billId);
          if (billIndex > -1) {
            const bill = db.bills[billIndex];
            const customer = db.customers.find(c => c.id === bill.customerId);
            const customerName = customer ? customer.name : 'অজানা গ্রাহক';
            const monthName = ['জানুয়ারি', 'ফেব্রুয়ারি', 'মার্চ', 'এপ্রিল', 'মে', 'জুন', 'জুলাই', 'আগস্ট',
              'সেপ্টেম্বর', 'অক্টোবর', 'নভেম্বর', 'ডিসেম্বর'
            ][bill.month];

            db.bills.splice(billIndex, 1);

            // Add activity log for bill deleted
            addActivity('bill_deleted', `বিল মুছে ফেলা হয়েছে: ${customerName} (${monthName} ${bill.year})`, {
              customerName: customerName,
              month: bill.month,
              year: bill.year,
              amount: bill.totalAmount
            });

            saveDb();
            renderBillingPage();
            renderDashboard();
          }
        }
      };

      // --- START: Payment Modal Functions ---
      /**
       * পেমেন্ট মোডালটি খোলে এবং প্রয়োজনীয় তথ্য দিয়ে এটি পূরণ করে।
       * @param {string} billId - যে বিলের জন্য পেমেন্ট করা হবে তার আইডি।
       */
// --- এই সম্পূর্ণ ফাংশনটি দিয়ে আপনার পুরনো openPaymentModal ফাংশনটি প্রতিস্থাপন করুন ---

      function openPaymentModal(billId, isReadOnly = false) {
          const bill = db.bills.find(b => b.id === billId);
          if (!bill) {
              alert('ত্রুটি: বিল খুঁজে পাওয়া যায়নি!');
              return;
          }
      
          const customer = db.customers.find(c => c.id === bill.customerId);
          if (!customer) {
              alert('ত্রুটি: গ্রাহক খুঁজে পাওয়া যায়নি!');
              return;
          }
      
          currentPaymentBillId = billId;
      
          const totalBill = bill.totalAmount || 0;
          const discount = bill.discount || 0;
          const paidAmount = bill.paidAmount || 0;
          const finalBill = totalBill - discount;
          const dueAmount = Math.max(0, finalBill - paidAmount);
          const advanceAmount = customer.advanceBalance || 0;
      
          document.getElementById('payment-customer-name').textContent = customer.name;
          document.getElementById('payment-bill-month').textContent = `${months[bill.month]}, ${toBengaliNumber(bill.year)}`;
          document.getElementById('payment-bill-amount').innerHTML = `৳${toBengaliNumber(finalBill.toFixed(2))} <span class="discount-text">(ছাড়: ৳${toBengaliNumber(discount.toFixed(2))})</span>`;
          document.getElementById('payment-due-amount').textContent = `৳${toBengaliNumber(dueAmount.toFixed(2))}`;
          document.getElementById('payment-advance-amount').textContent = `৳${toBengaliNumber(advanceAmount.toFixed(2))}`;
          
          // ★★★ এখানে পরিবর্তন শুরু ★★★
          const paymentAmountInput = document.getElementById('payment-amount-input');
          const discountAmountInput = document.getElementById('discount-amount-input');
          const applyDiscountBtn = document.getElementById('apply-discount-btn');
          const submitPaymentBtn = document.getElementById('submit-payment-btn');
      
          // রিড-অনলি মোডের জন্য লজিক যোগ করা হয়েছে
          if (isReadOnly) {
              paymentAmountInput.disabled = true;
              discountAmountInput.disabled = true;
              applyDiscountBtn.disabled = true;
              submitPaymentBtn.disabled = true;
              paymentAmountInput.placeholder = "শুধুমাত্র দেখার জন্য";
              discountAmountInput.placeholder = "শুধুমাত্র দেখার জন্য";
          } else {
              paymentAmountInput.disabled = false;
              discountAmountInput.disabled = false;
              applyDiscountBtn.disabled = false;
              submitPaymentBtn.disabled = false;
              paymentAmountInput.placeholder = "পরিমাণ";
              discountAmountInput.placeholder = "পরিমাণ";
          }
          paymentAmountInput.value = '';
          discountAmountInput.value = '';
          // ★★★ এখানে পরিবর্তন শেষ ★★★
      
          displayPaymentHistory(billId);
      
          document.getElementById('paymentModal').classList.add('active');
          document.getElementById('overlay').style.display = 'block';
      
          // শুধুমাত্র লেখার যোগ্য মোডেই ফোকাস করা হবে
          if (!isReadOnly) {
              setTimeout(() => {
                  paymentAmountInput.focus();
              }, 300);
          }
      }
 
      function closePaymentModal() {
        const paymentModal = document.getElementById('paymentModal');
        const overlay = document.getElementById('overlay');

        if (paymentModal) {
          paymentModal.classList.remove('active');
        }
        if (overlay) {
          overlay.style.display = 'none';
        }

        currentPaymentBillId = null; // বিল আইডি রিসেট করা

        // মোডাল বন্ধ করার সময় ডিসকাউন্ট বক্স রিসেট করা
        const discountContent = document.getElementById('discount-section-content');
        const toggleDiscountBtn = document.getElementById('toggle-discount-section-btn');
        const discountInput = document.getElementById('discount-amount-input');

        if (discountContent) {
          discountContent.classList.remove('active'); // লুকানোর জন্য ক্লাস রিমুভ
        }
        if (toggleDiscountBtn) {
          // বাটনটিকে তার আসল অবস্থায় ফিরিয়ে আনা
          toggleDiscountBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="currentColor" style="vertical-align: middle; margin-right: 5px;"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            বিশেষ ছাড় দিন
        `;
        }
        if (discountInput) {
          discountInput.value = '';
        }
      }

      /**
       * পেমেন্ট ইতিহাস প্রদর্শন করে।
       * @param {string} billId - বিলের আইডি।
       */
      // --- আপনার পুরনো সম্পূর্ণ displayPaymentHistory ফাংশনটি মুছে, এই নতুন এবং চূড়ান্ত কোডটি পেস্ট করুন ---

      function displayPaymentHistory(billId) {
        const bill = db.bills.find(b => b.id === billId);
        const historyContainer = document.getElementById('payment-history-list');

        if (!bill || !bill.paymentHistory || !bill.paymentHistory.length) {
          historyContainer.innerHTML = '<div class="payment-history-empty">কোনো পেমেন্ট ইতিহাস পাওয়া যায়নি</div>';
          return;
        }

        // CSS স্টাইল (চূড়ান্ত সংস্করণ)
        const styles = `
        .payment-history-item-final-v3 { background: #FFFFFF; border: 1px solid #E2E8F0; border-left: 4px solid var(--secondary-color); border-radius: 6px; padding: 8px 12px; margin-bottom: 6px; }
        .ph-source-final-v3 { font-size: 11px; font-weight: 600; color: var(--primary-color); margin-bottom: 3px; display: flex; align-items: center; gap: 5px; }
        .ph-amount-final-v3 { font-size: 18px; font-weight: 700; color: var(--paid-color); margin-bottom: 4px; }
        .ph-date-final-v3 { font-size: 10px; color: #718096; display: flex; align-items: center; gap: 5px; }
        .ph-status-line-final-v3 { margin-top: 5px; font-size: 11px; display: flex; flex-direction: column; gap: 4px; }
        .ph-status-line-final-v3 .due { font-style: italic; color: #718096; }
        .ph-status-line-final-v3 .final-payment { font-weight: 600; color: var(--paid-color); }
        .ph-status-line-final-v3 .new-advance, .ph-status-line-final-v3 .total-advance { font-weight: 600; color: var(--advance-color); }
    `;
        if (!document.getElementById('payment-history-styles-final-v3')) {
          const styleSheet = document.createElement("style");
          styleSheet.id = 'payment-history-styles-final-v3';
          styleSheet.innerText = styles;
          document.head.appendChild(styleSheet);
        }

        const sortedHistory = bill.paymentHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

        let historyHTML = sortedHistory.map(payment => {
          const paymentDate = new Date(payment.date);
          const formattedDate = paymentDate.toLocaleDateString('bn-BD', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });

          let sourceText;
          if (payment.source === 'manual') sourceText = '👤 ম্যানুয়াল পেমেন্ট';
          else if (payment.source === 'advance') sourceText = '💳 অ্যাডভান্স থেকে সমন্বয়';
          else if (payment.source === 'advance_deposit') sourceText = '✨ সরাসরি অ্যাডভান্স জমা';
          else sourceText = 'অজানা উৎস';

          let statusLinesHTML = '';

          // ★★★ আপনার নতুন ফিচারের চূড়ান্ত প্রদর্শন যুক্তি ★★★
          if (payment.isFinalPayment) {
            statusLinesHTML +=
              `<div class="final-payment">✅ বিলটি এই পেমেন্টের মাধ্যমে সম্পূর্ণ পরিশোধিত হয়েছে।</div>`;
            if (payment.newAdvance > 0) {
              statusLinesHTML +=
                `<div class="new-advance">✨ এবং ৳${toBengaliNumber(payment.newAdvance.toFixed(2))} নতুন অ্যাডভান্স হিসেবে জমা হয়েছে।</div>`;
            }
          } else if (payment.source === 'advance_deposit') {
            const totalAdvance = Math.abs(payment.balanceAfter);
            if (payment.isFirstAdvance) {
              statusLinesHTML +=
                `<div class="new-advance">✨ নতুন অ্যাডভান্স জমা হয়েছে: ৳${toBengaliNumber(totalAdvance.toFixed(2))}</div>`;
            } else {
              statusLinesHTML +=
                `<div class="total-advance">📈 মোট অ্যাডভান্স এখন: ৳${toBengaliNumber(totalAdvance.toFixed(2))}</div>`;
            }
          } else if (payment.balanceAfter > 0) {
            statusLinesHTML +=
              `<div class="due">📉 পেমেন্টের পর বকেয়া: ৳${toBengaliNumber(payment.balanceAfter.toFixed(2))}</div>`;
          }

          return `
            <div class="payment-history-item-final-v3">
                <div class="ph-source-final-v3">${sourceText}</div>
                <div class="ph-amount-final-v3">৳${toBengaliNumber(payment.amount.toFixed(2))}</div>
                <div class="ph-date-final-v3">🗓️ ${formattedDate}</div>
                <div class="ph-status-line-final-v3">${statusLinesHTML}</div>
            </div>
        `;
        }).join('');

        historyContainer.innerHTML = historyHTML;
      }

      // --- END: Payment Modal Functions ---

      document.getElementById('generateYear').addEventListener('change', renderBillingPage);
      document.getElementById('generateMonth').addEventListener('change', renderBillingPage);
      document.getElementById('billing-search-input').addEventListener('input', renderBillingPage);
      document.querySelectorAll('#billing .filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelector('#billing .filter-btn.active').classList.remove('active');
          btn.classList.add('active');
          renderBillingPage();
        });
      });

      const ispBillForm = document.getElementById('ispBillForm');
      const ispHistoryTableBody = document.querySelector('#ispHistoryTable tbody');

      function initializeIspForm(options = {}) {
          const monthOptions = months.map((m, i) => ({ value: i, text: m }));
          
          // ★★★ মূল পরিবর্তন এখানে ★★★
          // options থেকে মাস ও বছর নেওয়ার চেষ্টা করা হচ্ছে, না পেলে বর্তমান মাস/বছর ব্যবহার করা হচ্ছে
          const defaultYear = options.year !== undefined ? options.year : new Date().getFullYear();
          const defaultMonth = options.month !== undefined ? options.month : new Date().getMonth();
      
          populateDropdown('ispYear', years, { defaultValue: defaultYear });
          populateDropdown('ispMonth', monthOptions, { defaultValue: defaultMonth });
          document.getElementById('ispPayDate').valueAsDate = new Date();
      }

      function renderIspHistoryTable() {
        ispHistoryTableBody.innerHTML = '';
        db.ispPayments.sort((a, b) => new Date(b.payDate) - new Date(a.payDate)).forEach(p => {
          const row = document.createElement('tr');
          const payDate = new Date(p.payDate);
          const formattedDate =
            `${toBengaliNumber(payDate.getDate())} ${months[payDate.getMonth()]} ${toBengaliNumber(payDate.getFullYear())}`;
          row.innerHTML = `
                    <td>${months[p.month]} ${toBengaliNumber(p.year)}</td>
                    <td>৳${toBengaliNumber(p.amount)}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <button class="btn action-btn" style="background-color: #3182CE;" onclick="openIspEditModal('${p.id}')">Edit</button>
                        <button class="btn btn-delete action-btn" onclick="window.deleteIspPayment('${p.id}')">Del</button>
                    </td>
                `;
          ispHistoryTableBody.appendChild(row);
        });
      }

      window.openIspEditModal = (id) => {
        const payment = db.ispPayments.find(p => p.id === id);
        if (payment) {
          document.getElementById("ispEditId").value = payment.id;
          document.getElementById("ispEditAmount").value = payment.amount;
          document.getElementById("ispEditPayDate").value = payment.payDate;
          populateDropdown("ispEditMonth", months.map((m, i) => ({
            value: i,
            text: m
          })), {
            defaultValue: payment.month
          });
          populateDropdown("ispEditYear", years, {
            defaultValue: payment.year
          });
          ispEditModal.classList.add("active");
          overlay.style.display = "block";
        }
      };
      ispEditModalClose.addEventListener('click', () => {
        ispEditModal.classList.remove('active');
        overlay.style.display = 'none';
      });
      ispEditForm.addEventListener("submit", e => {
        e.preventDefault();
        const id = document.getElementById("ispEditId").value;
        const payment = db.ispPayments.find(p => p.id === id);
        if (payment) {
          payment.amount = parseFloat(document.getElementById("ispEditAmount").value);
          payment.payDate = document.getElementById("ispEditPayDate").value;
          payment.month = parseInt(document.getElementById("ispEditMonth").value);
          payment.year = parseInt(document.getElementById("ispEditYear").value);
          saveDb();
          renderIspHistoryTable();
          ispEditModal.classList.remove("active");
          overlay.style.display = "none";
        }
      });

      window.deleteIspPayment = (id) => {
        if (confirm('আপনি কি নিশ্চিতভাবে এই বিলের ইতিহাসটি মুছে ফেলতে চান?')) {
          const payment = db.ispPayments.find(p => p.id === id);
          const monthName = ['জানুয়ারি', 'ফেব্রুয়ারি', 'মার্চ', 'এপ্রিল', 'মে', 'জুন', 'জুলাই', 'আগস্ট',
            'সেপ্টেম্বর', 'অক্টোবর', 'নভেম্বর', 'ডিসেম্বর'
          ][payment.month];

          db.ispPayments = db.ispPayments.filter(p => p.id !== id);

          // Add activity log for ISP payment deleted
          addActivity('isp_payment_deleted',
            `আইএসপি বিল মুছে ফেলা হয়েছে: ${monthName} ${payment.year} - ৳${payment.amount}`, {
              month: payment.month,
              year: payment.year,
              amount: payment.amount
            });

          saveDb();
          renderIspHistoryTable();
        }
      };

      document.getElementById('delete-all-isp-history-btn').addEventListener('click', () => {
        if (confirm('সতর্কতা! আপনি কি নিশ্চিতভাবে সকল আইএসপি বিলের ইতিহাস মুছে ফেলতে চান?')) {
          const deletedCount = db.ispPayments.length;
          db.ispPayments = [];

          // Add activity log for all ISP history deleted
          addActivity('all_isp_history_deleted',
            `সকল আইএসপি বিল ইতিহাস মুছে ফেলা হয়েছে (${deletedCount} টি রেকর্ড)`, {
              deletedCount: deletedCount
            });

          saveDb();
          renderIspHistoryTable();
        }
      });

      function renderIspBillPage(options = {}) {
          initializeIspForm(options); // options পাস করা হচ্ছে
          renderIspHistoryTable();
      }

      ispBillForm.addEventListener("submit", e => {
        e.preventDefault();
        const year = parseInt(document.getElementById("ispYear").value);
        const month = parseInt(document.getElementById("ispMonth").value);
        const amount = parseFloat(document.getElementById("ispAmount").value);
        const payDate = document.getElementById("ispPayDate").value;

        const existingPaymentIndex = db.ispPayments.findIndex(p => p.year === year && p.month === month);

        if (existingPaymentIndex > -1) {
          alert(
            `এই মাসের (${months[month]}, ${toBengaliNumber(year)}) জন্য আইএসপি বিল ইতিমধ্যে পরিশোধ করা হয়েছে। একই মাসে দ্বিতীয়বার পেমেন্ট করা যাবে না। তবে আপনি Edit বাটন দিয়ে এডিট করতে পারেন।`
            );
          return;
        } else {
          // Add new payment
          const payment = {
            id: Date.now().toString(),
            year: year,
            month: month,
            amount: amount,
            payDate: payDate
          };
          db.ispPayments.push(payment);
          alert("আইএসপি বিল সফলভাবে পরিশোধ করা হয়েছে।");

          // Add activity log for ISP payment
          addActivity('isp_payment', `আইএসপি বিল পরিশোধ করা হয়েছে`, {
            month: month,
            year: year,
            amount: amount
          });
        }
        saveDb();
        renderIspHistoryTable();
        ispBillForm.reset();
        initializeIspForm();
      });

      function initializeReportFilters() {
        const monthOptions = months.map((m, i) => ({
          value: i,
          text: m
        }));
        populateDropdown('reportYear', years, {
          defaultValue: new Date().getFullYear()
        });
        populateDropdown('reportMonth', monthOptions, {
          defaultValue: new Date().getMonth()
        });
      }

      function generateReport() {
          const year = parseInt(document.getElementById('reportYear').value);
          const month = parseInt(document.getElementById('reportMonth').value);
      
          let totalCashRevenue = 0;
          db.bills.forEach(bill => {
              if (bill.paymentHistory && bill.paymentHistory.length > 0) {
                  bill.paymentHistory.forEach(payment => {
                      const paymentDate = new Date(payment.date);
                      if (paymentDate.getMonth() === month && paymentDate.getFullYear() === year) {
                          if (payment.source === 'manual' || payment.source === 'advance_deposit') {
                              totalCashRevenue += payment.amount;
                          }
                      }
                  });
              }
          });
      
          const filteredBills = db.bills.filter(b => b.year == year && b.month == month);
          const totalDues = filteredBills.reduce((sum, b) => sum + (b.remainingDue || 0), 0);
          const totalDiscount = filteredBills.reduce((sum, bill) => sum + (bill.discount || 0), 0);
      
          let totalNewAdvance = 0;
          db.bills.forEach(bill => {
              if (bill.paymentHistory && bill.paymentHistory.length > 0) {
                  bill.paymentHistory.forEach(payment => {
                      const paymentDate = new Date(payment.date);
                      if (paymentDate.getMonth() === month && paymentDate.getFullYear() === year) {
                          if (payment.source === 'advance_deposit') {
                              totalNewAdvance += payment.amount;
                          } else if (payment.isFinalPayment && payment.newAdvance > 0) {
                              totalNewAdvance += payment.newAdvance;
                          }
                      }
                  });
              }
          });
      
          const expenseMonth = month === 0 ? 11 : month - 1;
          const expenseYear = month === 0 ? year - 1 : year;
          const ispPaid = db.ispPayments.find(p => p.year == expenseYear && p.month == expenseMonth)?.amount || 0;
      
          const netIncome = totalCashRevenue - ispPaid;
      
          document.getElementById('total-revenue').textContent = `৳${toBengaliNumber(totalCashRevenue.toFixed(2))}`;
          document.getElementById('total-dues').textContent = `৳${toBengaliNumber(totalDues.toFixed(2))}`;
          document.getElementById('isp-paid-amount').textContent = `৳${toBengaliNumber(ispPaid.toFixed(2))}`;
          document.getElementById('net-income').textContent = `৳${toBengaliNumber(netIncome.toFixed(2))}`;
      
          const totalDiscountCard = document.getElementById('total-discount-card');
          const totalAdvanceCard = document.getElementById('total-advance-card');
      
          if (totalDiscountCard) {
              if (totalDiscount > 0) {
                  document.getElementById('total-discount').textContent = `৳${toBengaliNumber(totalDiscount.toFixed(2))}`;
                  totalDiscountCard.style.display = 'block';
              } else {
                  totalDiscountCard.style.display = 'none';
              }
          }
      
          if (totalAdvanceCard) {
              if (totalNewAdvance > 0) {
                  document.getElementById('total-advance').textContent = `৳${toBengaliNumber(totalNewAdvance.toFixed(2))}`;
                  totalAdvanceCard.style.display = 'block';
              } else {
                  totalAdvanceCard.style.display = 'none';
              }
          }
      
          const houseContainer = document.getElementById('house-reports-container');
          houseContainer.innerHTML = '';
          const houseRevenues = {};
      
          db.bills.forEach(bill => {
              const customer = db.customers.find(c => c.id === bill.customerId);
              if (!customer) return;
      
              if (!houseRevenues[customer.house]) {
                  houseRevenues[customer.house] = 0;
              }
      
              if (bill.paymentHistory && bill.paymentHistory.length > 0) {
                  bill.paymentHistory.forEach(payment => {
                      const paymentDate = new Date(payment.date);
                      if (paymentDate.getMonth() === month && paymentDate.getFullYear() === year) {
                          if (payment.source === 'manual' || payment.source === 'advance_deposit') {
                              houseRevenues[customer.house] += payment.amount;
                          }
                      }
                  });
              }
          });
      
          db.locations.forEach(houseName => {
              const houseRevenue = houseRevenues[houseName] || 0;
              if (houseRevenue > 0) {
                  const houseCard = document.createElement('div');
                  houseCard.className = 'summary-item';
                  houseCard.innerHTML = `<h3>${houseName}</h3><p>আয়: ৳${toBengaliNumber(houseRevenue.toFixed(2))}</p>`;
                  houseContainer.appendChild(houseCard);
              }
          });
      }
      
      function generatePdfReport() {
          const year = parseInt(document.getElementById('reportYear').value);
          const month = parseInt(document.getElementById('reportMonth').value);
      
          let totalCashRevenue = 0;
          db.bills.forEach(bill => {
              if (bill.paymentHistory && bill.paymentHistory.length > 0) {
                  bill.paymentHistory.forEach(payment => {
                      const paymentDate = new Date(payment.date);
                      if (paymentDate.getMonth() === month && paymentDate.getFullYear() === year) {
                          if (payment.source === 'manual' || payment.source === 'advance_deposit') {
                              totalCashRevenue += payment.amount;
                          }
                      }
                  });
              }
          });
      
          const filteredBills = db.bills.filter(b => b.year == year && b.month == month);
          const totalDues = filteredBills.reduce((sum, b) => sum + (b.remainingDue || 0), 0);
          const totalDiscount = filteredBills.reduce((sum, bill) => sum + (bill.discount || 0), 0);
      
          let totalNewAdvance = 0;
          db.bills.forEach(bill => {
              if (bill.paymentHistory && bill.paymentHistory.length > 0) {
                  bill.paymentHistory.forEach(payment => {
                      const paymentDate = new Date(payment.date);
                      if (paymentDate.getMonth() === month && paymentDate.getFullYear() === year) {
                          if (payment.source === 'advance_deposit') {
                              totalNewAdvance += payment.amount;
                          } else if (payment.isFinalPayment && payment.newAdvance > 0) {
                              totalNewAdvance += payment.newAdvance;
                          }
                      }
                  });
              }
          });
      
          const expenseMonth = month === 0 ? 11 : month - 1;
          const expenseYear = month === 0 ? year - 1 : year;
          const ispPaid = db.ispPayments.find(p => p.year == expenseYear && p.month == expenseMonth)?.amount || 0;
      
          const netIncome = totalCashRevenue - ispPaid;
      
          const companyName = document.getElementById('header-company-name').textContent || 'Abid Network';
          const companyLogo = document.getElementById('header-company-logo').src;
      
          let dynamicCardsHtml = '';
          if (totalDiscount > 0) {
              dynamicCardsHtml += `
                  <div class="summary-card" style="border-color: #F59E0B; color: #D97706;">
                      <span class="icon">🏷️</span>
                      <div class="info"><h3>মোট ছাড়</h3><p>৳${toBengaliNumber(totalDiscount.toFixed(2))}</p></div>
                  </div>
              `;
          }
          if (totalNewAdvance > 0) {
              dynamicCardsHtml += `
                  <div class="summary-card" style="border-color: #10B981; color: #059669;">
                      <span class="icon">✨</span>
                      <div class="info"><h3>নতুন অগ্রিম</h3><p>৳${toBengaliNumber(totalNewAdvance.toFixed(2))}</p></div>
                  </div>
              `;
          }
      
          const houseRevenues = {};
          db.bills.forEach(bill => {
              const customer = db.customers.find(c => c.id === bill.customerId);
              if (!customer) return;
              if (!houseRevenues[customer.house]) {
                  houseRevenues[customer.house] = 0;
              }
              if (bill.paymentHistory && bill.paymentHistory.length > 0) {
                  bill.paymentHistory.forEach(payment => {
                      const paymentDate = new Date(payment.date);
                      if (paymentDate.getMonth() === month && paymentDate.getFullYear() === year) {
                          if (payment.source === 'manual' || payment.source === 'advance_deposit') {
                              houseRevenues[customer.house] += payment.amount;
                          }
                      }
                  });
              }
          });
      
          const houseReportsHtml = db.locations.map(houseName => {
              const houseRevenue = houseRevenues[houseName] || 0;
              if (houseRevenue === 0) return '';
              return `
                  <tr>
                      <td>${houseName}</td>
                      <td>৳${toBengaliNumber(houseRevenue.toFixed(2))}</td>
                  </tr>
              `;
          }).join('');
      
          const pdfContent = `
              <!DOCTYPE html>
              <html lang="bn">
              <head>
                  <meta charset="UTF-8">
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <title>মাসিক রিপোর্ট - ${companyName}</title>
                  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
                  <style>
                      :root {
                          --primary-color: #4A5568; --secondary-color: #5A67D8; --text-color: #2D3748;
                          --border-color: #E2E8F0; --bg-light: #F7FAFC;
                      }
                      body { font-family: 'Noto Sans Bengali', sans-serif; background-color: #eef2f7; color: var(--text-color); margin: 0; padding: 20px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                      .pdf-container { max-width: 800px; margin: 0 auto; background: white; border: 1px solid var(--border-color); box-shadow: 0 0 20px rgba(0,0,0,0.07); border-radius: 8px; overflow: hidden; }
                      .pdf-header { padding: 20px 30px; display: flex; align-items: center; gap: 15px; background-color: var(--bg-light); border-bottom: 1px solid var(--border-color); }
                      .pdf-header .company-logo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
                      .pdf-header .company-name { font-size: 24px; font-weight: 700; color: var(--text-color); margin: 0; }
                      .pdf-content { padding: 25px 30px; }
                      .report-title-bar { display: flex; justify-content: space-between; align-items: baseline; border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; margin-bottom: 20px; }
                      .report-title-bar h2 { font-size: 18px; font-weight: 600; color: var(--primary-color); margin: 0; }
                      .report-title-bar .report-period { font-size: 15px; font-weight: 500; color: var(--secondary-color); }
                      .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px; }
                      .summary-card { display: flex; align-items: center; gap: 15px; background-color: var(--bg-light); padding: 15px; border-radius: 6px; border-left: 4px solid; }
                      .summary-card .icon { font-size: 24px; line-height: 1; }
                      .summary-card .info h3 { font-size: 13px; font-weight: 500; color: #718096; margin: 0 0 4px 0; }
                      .summary-card .info p { font-size: 18px; font-weight: 700; margin: 0; }
                      .summary-card.revenue { border-color: #38A169; color: #38A169; }
                      .summary-card.dues { border-color: #DD6B20; color: #DD6B20; }
                      .summary-card.isp { border-color: #E53E3E; color: #E53E3E; }
                      .summary-card.net { border-color: #3182CE; color: #3182CE; }
                      table { width: 100%; border-collapse: collapse; }
                      th, td { border: 1px solid var(--border-color); padding: 10px 12px; font-size: 13px; text-align: left; }
                      th { background-color: var(--bg-light); font-weight: 600; }
                      td:last-child { text-align: right; font-weight: 600; }
                      .pdf-footer { text-align: center; padding: 15px; font-size: 11px; color: #A0AEC0; background-color: var(--bg-light); border-top: 1px solid var(--border-color); }
                      @media (max-width: 600px) {
                          body { padding: 10px; }
                          .pdf-container { width: 100%; box-sizing: border-box; }
                          .pdf-header, .pdf-content { padding: 15px; }
                          .pdf-header .company-name { font-size: 18px; }
                          .report-title-bar { flex-direction: column; align-items: flex-start; gap: 5px; }
                          .summary-grid { gap: 10px; }
                          .summary-card { padding: 10px; gap: 10px; }
                          .summary-card .icon { font-size: 20px; }
                          .summary-card .info h3 { font-size: 11px; }
                          .summary-card .info p { font-size: 15px; }
                          th, td { padding: 8px; font-size: 12px; }
                      }
                      @media print {
                          body { padding: 0; margin: 0; background-color: white; }
                          .pdf-container { box-shadow: none; border: none; width: 100%; max-width: 100%; border-radius: 0; }
                          .summary-grid { grid-template-columns: repeat(2, 1fr) !important; }
                          @page { size: A4; margin: 15mm; }
                      }
                  </style>
              </head>
              <body>
                  <div class="pdf-container">
                      <header class="pdf-header">
                          <img src="${companyLogo}" alt="লোগো" class="company-logo">
                          <h1 class="company-name">${companyName}</h1>
                      </header>
                      <main class="pdf-content">
                          <div class="report-title-bar">
                              <h2>মাসিক আর্থিক রিপোর্ট</h2>
                              <div class="report-period">${months[month]}, ${toBengaliNumber(year)}</div>
                          </div>
                          <div class="summary-grid">
                              <div class="summary-card revenue"><span class="icon">💰</span><div class="info"><h3>মোট আয়</h3><p>৳${toBengaliNumber(totalCashRevenue.toFixed(2))}</p></div></div>
                              <div class="summary-card dues"><span class="icon">⚠️</span><div class="info"><h3>মোট বকেয়া</h3><p>৳${toBengaliNumber(totalDues.toFixed(2))}</p></div></div>
                              ${dynamicCardsHtml} 
                              <div class="summary-card isp"><span class="icon">💸</span><div class="info"><h3>আইএসপি খরচ</h3><p>(−) ৳${toBengaliNumber(ispPaid.toFixed(2))}</p></div></div>
                              <div class="summary-card net"><span class="icon">📈</span><div class="info"><h3>নিট আয়</h3><p>৳${toBengaliNumber(netIncome.toFixed(2))}</p></div></div>
                          </div>
                          <div class="house-table-container">
                              <h2>বাড়ি ভিত্তিক আয়ের বিস্তারিত</h2>
                              <table>
                                  <thead><tr><th>বাড়ির নাম</th><th>আয়ের পরিমাণ</th></tr></thead>
                                  <tbody>${houseReportsHtml}</tbody>
                              </table>
                          </div>
                      </main>
                      <footer class="pdf-footer">
                          রিপোর্টটি স্বয়ংক্রিয়ভাবে তৈরি করা হয়েছে। জেনারেট করার সময়: ${toBengaliNumber(new Date().toLocaleString('bn-BD'))}
                      </footer>
                  </div>
              </body>
              </html>
          `;
      
          const printWindow = window.open('', '_blank');
          printWindow.document.write(pdfContent);
          printWindow.document.close();
          printWindow.onload = () => {
              setTimeout(() => {
                  printWindow.print();
              }, 500);
          };
      }

      function renderReportPage() {
        initializeReportFilters();
        generateReport();
        populateCustomerBillingHistoryDropdown();
      }
      document.getElementById('reportYear').addEventListener('change', generateReport);
      document.getElementById('reportMonth').addEventListener('change', generateReport);
      document.getElementById('printReportPdfBtn').addEventListener('click', generatePdfReport);

      function populateCustomerBillingHistoryDropdown() {
        const customerOptions = [{
          value: '',
          text: 'একটি গ্রাহক নির্বাচন করুন'
        }].concat(
          db.customers.sort((a, b) => a.name.localeCompare(b.name)).map(c => ({
            value: c.id,
            text: `${c.name} (${c.house.split('ঃ')[0]})`
          }))
        );
        populateDropdown('customerBillingHistorySelect', customerOptions, {
          isBengali: false
        });
      }

      document.getElementById('downloadCustomerBillingHistoryBtn').addEventListener('click', () => {
        const customerId = document.getElementById('customerBillingHistorySelect').value;
        if (customerId) {
          generateCustomerBillingHistoryPdf(customerId);
        } else {
          alert('দয়া করে একটি গ্রাহক নির্বাচন করুন।');
        }
      });

      function generateCustomerBillingHistoryPdf(customerId) {
          const customer = db.customers.find(c => c.id === customerId);
          if (!customer) {
              alert('গ্রাহক খুঁজে পাওয়া যায়নি।');
              return;
          }
      
          // ধাপ ১: সরাসরি ওয়েবপেজ থেকে নাম ও লোগো সংগ্রহ করা (স্মার্ট লজিক)
          const companyName = document.getElementById('header-company-name').textContent || 'Abid Network';
          const companyLogo = document.getElementById('header-company-logo').src;
      
          const customerBills = db.bills
              .filter(b => b.customerId === customerId)
              .sort((a, b) => new Date(b.year, b.month) - new Date(a.year, a.month));
      
          const billingHistoryHtml = customerBills.map(bill => {
              let statusClass, statusText;
              if (bill.status === 'paid') {
                  statusClass = 'status-paid';
                  statusText = 'পরিশোধিত';
              } else if (bill.status === 'partially_paid') {
                  statusClass = 'status-partial';
                  statusText = 'আংশিক';
              } else {
                  statusClass = 'status-unpaid';
                  statusText = 'বকেয়া';
              }
      
              // ধাপ ২: টেবিলের প্রতিটি সারির জন্য নির্ভুল ডেটা তৈরি করা
              return `
                  <tr>
                      <td>${months[bill.month]}, ${toBengaliNumber(bill.year)}</td>
                      <td>৳${toBengaliNumber(bill.totalAmount.toFixed(2))}</td>
                      <td>৳${toBengaliNumber((bill.discount || 0).toFixed(2))}</td>
                      <td>৳${toBengaliNumber(bill.paidAmount.toFixed(2))}</td>
                      <td>৳${toBengaliNumber(bill.remainingDue.toFixed(2))}</td>
                      <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                  </tr>
              `;
          }).join('');
      
          // ধাপ ৩: সম্পূর্ণ পিডিএফ-এর জন্য HTML কন্টেন্ট তৈরি করা
          const pdfContent = `
              <!DOCTYPE html>
              <html lang="bn">
              <head>
                  <meta charset="UTF-8">
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <title>${customer.name} - বিলিং ইতিহাস</title>
                  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
                  <style>
                      :root {
                          --primary-color: #4A5568; --secondary-color: #5A67D8; --text-color: #2D3748;
                          --border-color: #E2E8F0; --bg-light: #F7FAFC; --paid-color: #38A169;
                          --unpaid-color: #DD6B20; --partial-color: #D69E2E;
                      }
                      body {
                          font-family: 'Noto Sans Bengali', sans-serif; background-color: #eef2f7;
                          color: var(--text-color); margin: 0; padding: 20px;
                          -webkit-print-color-adjust: exact; print-color-adjust: exact;
                      }
                      .pdf-container {
                          max-width: 800px; margin: 0 auto; background: white;
                          border: 1px solid var(--border-color); box-shadow: 0 0 20px rgba(0,0,0,0.07);
                          border-radius: 8px; overflow: hidden;
                      }
                      .pdf-header {
                          padding: 20px 30px; display: flex; align-items: center; gap: 15px;
                          background-color: var(--bg-light); border-bottom: 1px solid var(--border-color);
                      }
                      .pdf-header .company-logo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
                      .pdf-header .company-name { font-size: 24px; font-weight: 700; color: var(--text-color); margin: 0; }
                      .pdf-content { padding: 25px 30px; }
                      .customer-info-card {
                          background-color: var(--bg-light); border: 1px solid var(--border-color);
                          border-left: 5px solid var(--secondary-color); border-radius: 8px;
                          padding: 20px; margin-bottom: 25px;
                      }
                      .customer-info-card .customer-name { font-size: 22px; font-weight: 700; color: var(--primary-color); margin: 0 0 10px 0; }
                      .customer-info-card .info-grid {
                          display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                          gap: 8px; font-size: 13px;
                      }
                      .customer-info-card .info-item { color: #718096; }
                      .customer-info-card .info-item strong { color: var(--text-color); font-weight: 600; }
                      .history-table-container h2 { font-size: 16px; font-weight: 600; color: var(--primary-color); margin-bottom: 10px; }
                      .table-wrapper { overflow-x: auto; }
                      table { width: 100%; border-collapse: collapse; }
                      th, td {
                          border: 1px solid var(--border-color); padding: 10px 12px;
                          font-size: 13px; text-align: left; vertical-align: middle; white-space: nowrap;
                      }
                      th { background-color: var(--bg-light); font-weight: 600; }
                      .status-badge {
                          display: inline-block; padding: 3px 10px; border-radius: 15px;
                          font-size: 11px; font-weight: 600; color: white; text-align: center;
                      }
                      .status-paid { background-color: var(--paid-color); }
                      .status-unpaid { background-color: var(--unpaid-color); }
                      .status-partial { background-color: var(--partial-color); }
                      .pdf-footer {
                          text-align: center; padding: 15px; font-size: 11px;
                          color: #A0AEC0; background-color: var(--bg-light); border-top: 1px solid var(--border-color);
                      }
                      @media (max-width: 600px) {
                          body { padding: 10px; }
                          .pdf-header, .pdf-content { padding: 15px; }
                          .pdf-header .company-name { font-size: 20px; }
                          .customer-info-card .customer-name { font-size: 18px; }
                          .customer-info-card .info-grid { grid-template-columns: 1fr; }
                          th, td { padding: 8px; font-size: 12px; }
                      }
                      @media print {
                          body { padding: 0; margin: 0; background-color: white; }
                          .pdf-container { box-shadow: none; border: none; width: 100%; max-width: 100%; border-radius: 0; }
                          .table-wrapper { overflow-x: visible; }
                          @page { size: A4; margin: 15mm; }
                      }
                  </style>
              </head>
              <body>
                  <div class="pdf-container">
                      <header class="pdf-header">
                          <img src="${companyLogo}" alt="লোগো" class="company-logo">
                          <h1 class="company-name">${companyName}</h1>
                      </header>
                      <main class="pdf-content">
                          <div class="customer-info-card">
                              <h2 class="customer-name">${customer.name}</h2>
                              <div class="info-grid">
                                  <div class="info-item">ফোনঃ <strong>${customer.phone || 'N/A'}</strong></div>
                                  <div class="info-item">বাড়িঃ <strong>${customer.house}</strong></div>
                                  <div class="info-item">মাসিক বিলঃ <strong>৳${toBengaliNumber(customer.monthlyBill.toFixed(2))}</strong></div>
                                  <div class="info-item">সংযোগের তারিখঃ <strong>${toBengaliNumber(new Date(customer.connectionDate).toLocaleDateString('bn-BD'))}</strong></div>
                              </div>
                          </div>
                          <div class="history-table-container">
                              <h2>বিলিং এবং পেমেন্টের ইতিহাস</h2>
                              <div class="table-wrapper">
                                  <table>
                                      <thead>
                                          <tr>
                                              <th>মাস/বছর</th>
                                              <th>মোট বিল</th>
                                              <th>ছাড়</th>
                                              <th>পরিশোধিত</th>
                                              <th>বকেয়া</th>
                                              <th>স্ট্যাটাস</th>
                                          </tr>
                                      </thead>
                                      <tbody>${billingHistoryHtml}</tbody>
                                  </table>
                              </div>
                          </div>
                      </main>
                      <footer class="pdf-footer">
                          রিপোর্টটি স্বয়ংক্রিয়ভাবে তৈরি করা হয়েছে। জেনারেট করার সময়ঃ ${toBengaliNumber(new Date().toLocaleString('bn-BD'))}
                      </footer>
                  </div>
              </body>
              </html>
          `;
      
          // ধাপ ৪: পিডিএফ প্রিন্টের জন্য নতুন উইন্ডো খোলা
          const printWindow = window.open('', '_blank');
          printWindow.document.write(pdfContent);
          printWindow.document.close();
          printWindow.onload = () => {
              setTimeout(() => {
                  printWindow.print();
              }, 500);
          };
      }

      function renderSettingsPage() {
        // Website customization functionality
        const websiteNameInput = document.getElementById('websiteName');
        const websiteLogoInput = document.getElementById('websiteLogo');
        const updateNameBtn = document.getElementById('updateWebsiteNameBtn');
        const updateLogoBtn = document.getElementById('updateWebsiteLogoBtn');

        // Load current website name
        const currentName = localStorage.getItem('websiteName') || 'Abid Network';
        websiteNameInput.value = currentName;

        // Update website name
        updateNameBtn.addEventListener('click', () => {
          const newName = websiteNameInput.value.trim();
          if (newName) {
            localStorage.setItem('websiteName', newName);

            // Update header title
            const headerTitle = document.querySelector('.header-title span');
            if (headerTitle) {
              headerTitle.textContent = newName;
            }

            // Update sidebar title
            const sidebarTitle = document.querySelector('.sidebar-header span');
            if (sidebarTitle) {
              sidebarTitle.textContent = newName;
            }

            // Update page title
            document.title = newName;

            alert('ওয়েবসাইটের নাম সফলভাবে আপডেট করা হয়েছে।');
          } else {
            alert('দয়া করে একটি বৈধ নাম লিখুন।');
          }
        });

        // Update website logo
        updateLogoBtn.addEventListener('click', () => {
          const logoFile = websiteLogoInput.files[0];
          if (logoFile) {
            const reader = new FileReader();
            reader.onload = (e) => {
              const logoDataUrl = e.target.result;
              localStorage.setItem('websiteLogo', logoDataUrl);

              // Update header logo
              const headerLogo = document.querySelector('.header-title img');
              if (headerLogo) {
                headerLogo.src = logoDataUrl;
              }

              // Update sidebar logo
              const sidebarLogo = document.querySelector('.sidebar-header img');
              if (sidebarLogo) {
                sidebarLogo.src = logoDataUrl;
              }

              alert('ওয়েবসাইটের লোগো সফলভাবে আপডেট করা হয়েছে।');
            };
            reader.readAsDataURL(logoFile);
          } else {
            alert('দয়া করে একটি ছবি নির্বাচন করুন।');
          }
        });

        const locationList = document.getElementById('locationList');
        const locationForm = document.getElementById('locationForm');
        const locationEditModal = document.getElementById('locationEditModal');
        const locationEditForm = document.getElementById('locationEditForm');
        const locationEditModalClose = document.getElementById('location-edit-modal-close');

        function renderLocations() {
          locationList.innerHTML = '';
          db.locations.forEach(loc => {
            const li = document.createElement('li');
            li.innerHTML = `
                        <span class="location-name">${loc}</span>
                        <div class="actions">
                            <button class="btn action-btn" style="background-color: #3182CE;" onclick="openLocationEditModal('${loc}')">Edit</button>
                            <button class="btn btn-delete action-btn" onclick="deleteLocation('${loc}')">Del</button>
                        </div>
                    `;
            locationList.appendChild(li);
          });
        }

        locationForm.addEventListener('submit', e => {
          e.preventDefault();
          const newLocationInput = document.getElementById('newLocationName');
          const newLocation = newLocationInput.value.trim();
          if (newLocation && !db.locations.includes(newLocation)) {
            db.locations.push(newLocation);

            // Add activity log for location added
            addActivity('location_added', `নতুন বাড়ি যোগ করা হয়েছে: ${newLocation}`, {
              locationName: newLocation
            });

            saveDb();
            renderLocations();
            newLocationInput.value = '';
          } else {
            alert('এই লোকেশনটি ইতিমধ্যে বিদ্যমান অথবা নামটি খালি।');
          }
        });

        window.openLocationEditModal = (oldName) => {
          document.getElementById('locationEditOldName').value = oldName;
          document.getElementById('locationEditNewName').value = oldName;
          locationEditModal.classList.add('active');
          overlay.style.display = 'block';
        };

        locationEditForm.addEventListener('submit', e => {
          e.preventDefault();
          const oldName = document.getElementById('locationEditOldName').value;
          const newName = document.getElementById('locationEditNewName').value.trim();
          if (newName && oldName !== newName && !db.locations.includes(newName)) {
            db.customers.forEach(c => {
              if (c.house === oldName) c.house = newName;
            });
            db.routers.forEach(r => {
              if (r.location === oldName) r.location = newName;
            });
            const index = db.locations.indexOf(oldName);
            if (index > -1) db.locations[index] = newName;
            saveDb();
            renderLocations();
            locationEditModal.classList.remove('active');
            overlay.style.display = 'none';
          } else {
            alert('নতুন নাম খালি, একই অথবা ইতিমধ্যে বিদ্যমান।');
          }
        });

        locationEditModalClose.addEventListener('click', () => {
          locationEditModal.classList.remove('active');
          overlay.style.display = 'none';
        });

        window.deleteLocation = (locName) => {
          if (defaultLocations.includes(locName)) {
            alert('ডিফল্ট লোকেশন মুছে ফেলা যাবে না।');
            return;
          }
          if (confirm(
              `আপনি কি নিশ্চিতভাবে "${locName}" লোকেশনটি মুছে ফেলতে চান? এই লোকেশনের সকল গ্রাহক এবং রাউটারের তথ্যও প্রভাবিত হতে পারে।`
              )) {
            db.locations = db.locations.filter(l => l !== locName);

            // Add activity log for location deleted
            addActivity('location_deleted', `বাড়ি মুছে ফেলা হয়েছে: ${locName}`, {
              locationName: locName
            });

            saveDb();
            renderLocations();
          }
        };

        renderLocations();
      }

      const exportBtn = document.getElementById('export-data-btn');
      const importBtn = document.getElementById('import-data-btn');
      const importInput = document.getElementById('import-file-input');
      const resetBtn = document.getElementById('reset-app-btn');

// --- পুরনো exportBtn.addEventListener(...) ব্লকটি মুছে এই চূড়ান্ত এবং উন্নত কোডটি বসান ---

      exportBtn.addEventListener('click', () => {
    const backupModal = document.getElementById('selectiveBackupModal');
    const overlay = document.getElementById('overlay');
    const optionsContainer = backupModal.querySelector('.backup-options-container');

    const dataKeyToName = {
        customers: 'গ্রাহক তালিকা ও প্রোফাইল',
        bills: 'বিলের সম্পূর্ণ ইতিহাস',
        routers: 'রাউটারের তথ্য',
        ispPayments: 'আইএসপি বিলের রেকর্ড',
        locations: 'বাড়ির তালিকা',
        activities: 'সাম্প্রতিক কার্যক্রমের লগ'
    };
    
    const unitNames = {
        customers: 'টি গ্রাহকের প্রোফাইল',
        bills: 'টি বিলের ইতিহাস',
        routers: 'টি রাউটারের তথ্য',
        ispPayments: 'টি আইএসপি বিলের রেকর্ড',
        locations: 'টি বাড়ির তালিকা',
        activities: 'টি কার্যক্রমের লগ'
    };

    const dataCounts = {
        customers: db.customers.length,
        bills: db.bills.length,
        routers: db.routers.length,
        ispPayments: db.ispPayments.length,
        locations: db.locations.length,
        activities: (localStorage.getItem(ACTIVITY_STORAGE_KEY) ? JSON.parse(localStorage.getItem(ACTIVITY_STORAGE_KEY)).length : 0)
    };

    document.querySelectorAll('.backup-option[data-option-for]').forEach(el => el.remove());

    Object.keys(dataKeyToName).forEach(key => {
        const count = dataCounts[key] || 0;
        if (count > 0) {
            const bengaliCount = toBengaliNumber(count);
            const optionElement = document.createElement('label');
            optionElement.className = 'backup-option';
            optionElement.dataset.optionFor = key;
            optionElement.innerHTML = `
                <input type="checkbox" data-key="${key}" checked>
                <span class="option-label">${dataKeyToName[key]}</span>
                <span class="option-count">${bengaliCount} ${unitNames[key]} আছে</span>
            `;
            optionsContainer.appendChild(optionElement);
        }
    });

    backupModal.classList.add('active');
    overlay.style.display = 'block';

    const createBackupBtn = document.getElementById('createBackupBtn');
    const closeModalBtn = document.getElementById('backupModalCloseBtn');
    const selectAllCheckbox = document.getElementById('backup-select-all');
    const activeCheckboxes = document.querySelectorAll('.backup-option input[data-key]:not(:disabled)');

    selectAllCheckbox.checked = true;
    selectAllCheckbox.onchange = () => {
        activeCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
    };

    activeCheckboxes.forEach(checkbox => {
        checkbox.onchange = () => {
            if (!checkbox.checked) {
                selectAllCheckbox.checked = false;
            }
        };
    });

    createBackupBtn.onclick = () => {
        const selectedKeys = [];
        document.querySelectorAll('.backup-option input[data-key]:checked').forEach(checkbox => {
            selectedKeys.push(checkbox.dataset.key);
        });

        if (selectedKeys.length === 0) {
            alert('অনুগ্রহ করে কমপক্ষে একটি অপশন নির্বাচন করুন।');
            return;
        }
        
        backupModal.classList.remove('active');
        
        // ★★★ নতুন প্রগ্রেস বার লজিক শুরু ★★★
        const progressModal = document.getElementById('exportProgressModal');
        const progressBar = document.getElementById('export-progress-bar');
        const progressStatusText = document.getElementById('export-progress-status');
        
        progressModal.classList.add('active');
        overlay.style.display = 'block';

        let progress = 0;
        const totalSteps = selectedKeys.length + 1; // +১ ফাইল তৈরির জন্য
        const stepIncrement = 100 / totalSteps;
        const keyToNameMap = { customers: 'গ্রাহক', bills: 'বিল', routers: 'রাউটার', ispPayments: 'আইএসপি বিল', locations: 'বাড়ি', activities: 'কার্যক্রম' };

        const processNextKey = (index = 0) => {
            if (index >= selectedKeys.length) {
                // সব ডেটা প্রস্তুত, এখন ফাইল তৈরি এবং ডাউনলোড
                progressBar.style.width = '100%';
                progressStatusText.textContent = 'ফাইল তৈরি করা হচ্ছে...';
                
                setTimeout(() => {
                    const dataToBackup = {};
                    selectedKeys.forEach(key => {
                        if (key === 'activities') {
                            dataToBackup[key] = loadActivities();
                        } else {
                            dataToBackup[key] = db[key];
                        }
                    });

                    const dataStr = JSON.stringify(dataToBackup, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const fileName = `abid_network_selective_backup_${new Date().toISOString().split('T')[0]}.json`;
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    // আপনার পুরনো লগ এবং তারিখ আপডেটের লজিক
                    const totalOptionsAvailable = document.querySelectorAll('.backup-option input[data-key]').length;
                    if (selectedKeys.length === totalOptionsAvailable) {
                        addActivity('data_backup', 'সিস্টেমের সকল ডেটা ব্যাকআপ নেওয়া হয়েছে।', { fileName });
                    } else {
                        selectedKeys.forEach(key => {
                            const count = dataToBackup[key].length;
                            const bengaliCount = toBengaliNumber(count);
                            const logDescription = `${bengaliCount} ${unitNames[key]} ব্যাকআপ করা হয়েছে।`;
                            addActivity('data_backup', logDescription, { fileName, exported: key });
                        });
                    }
                    const now = new Date();
                    const bengaliDate = now.toLocaleDateString('bn-BD', { year: 'numeric', month: 'long', day: 'numeric' });
                    localStorage.setItem('lastExportDate', bengaliDate);
                    updateLastExportDate();
                    hideBackupReminder();

                    // প্রক্রিয়া সফলভাবে শেষ
                    progressStatusText.textContent = '✓ ব্যাকআপ সফল হয়েছে!';
                    setTimeout(() => {
                        progressModal.classList.remove('active');
                        overlay.style.display = 'none';
                    }, 1500); // ১.৫ সেকেন্ড পর মডাল স্বয়ংক্রিয়ভাবে বন্ধ হবে

                }, 500); // ফাইল তৈরির জন্য ৫০০ms বিলম্ব
                return;
            }

            const key = selectedKeys[index];
            progress += stepIncrement;
            progressBar.style.width = `${progress}%`;
            progressStatusText.textContent = `${keyToNameMap[key]} প্রস্তুত করা হচ্ছে...`;

            setTimeout(() => processNextKey(index + 1), 300); // প্রতিটি ধাপের মধ্যে ৩০০ms বিলম্ব
        };

        progressStatusText.textContent = 'প্রক্রিয়া শুরু হচ্ছে...';
        setTimeout(processNextKey, 400); // প্রাথমিক বিলম্ব
        // ★★★ নতুন প্রগ্রেস বার লজিক শেষ ★★★
    };

    closeModalBtn.onclick = () => {
        backupModal.classList.remove('active');
        overlay.style.display = 'none';
    };
});

      importBtn.addEventListener('click', () => importInput.click());

// --- পুরনো importInput.addEventListener(...) ব্লকটি মুছে এই চূড়ান্ত এবং উন্নত কোডটি বসান ---

      importInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            const dataRoot = importedData.db ? importedData.db : importedData;
            if (importedData.activities) {
                dataRoot.activities = importedData.activities;
            }

            const dataKeyToName = {
                customers: 'গ্রাহক তালিকা',
                bills: 'বিলের ইতিহাস',
                routers: 'রাউটারের তথ্য',
                ispPayments: 'আইএসপি বিলের রেকর্ড',
                locations: 'বাড়ির তালিকা',
                activities: 'সাম্প্রতিক কার্যক্রমের লগ'
            };
            
            const unitNames = {
                customers: 'টি গ্রাহকের প্রোফাইল',
                bills: 'টি বিলের ইতিহাস',
                routers: 'টি রাউটারের তথ্য',
                ispPayments: 'টি আইএসপি বিলের রেকর্ড',
                locations: 'টি বাড়ির তালিকা',
                activities: 'টি কার্যক্রমের লগ'
            };

            const availableDataKeys = Object.keys(dataRoot).filter(key => 
                dataKeyToName[key] && Array.isArray(dataRoot[key]) && dataRoot[key].length > 0
            );

            if (availableDataKeys.length === 0) {
                alert('ফাইলটির ফরম্যাট বোঝা যাচ্ছে না বা এতে কোনো ডেটা পাওয়া যায়নি।');
                event.target.value = '';
                return;
            }

            const importModal = document.getElementById('selectiveImportModal');
            const overlay = document.getElementById('overlay');
            const optionsContainer = document.getElementById('import-options-container');
            
            document.getElementById('import-file-info').textContent = `আপনি "${file.name}" ফাইলটি আপলোড করেছেন। এতে নিম্নলিখিত ডেটা পাওয়া গেছে:`;
            optionsContainer.innerHTML = '';

            availableDataKeys.forEach(key => {
                const count = dataRoot[key].length;
                const bengaliCount = toBengaliNumber(count);
                
                const label = document.createElement('label');
                label.className = 'backup-option';
                label.innerHTML = `
                    <input type="checkbox" data-key="${key}" checked>
                    <span class="option-label">${dataKeyToName[key]}</span>
                    <span class="option-count">${bengaliCount} ${unitNames[key]} পাওয়া গেছে</span>
                `;
                optionsContainer.appendChild(label);
            });

            importModal.classList.add('active');
            overlay.style.display = 'block';

            const confirmImportBtn = document.getElementById('confirmImportBtn');
            const closeModalBtn = document.getElementById('importModalCloseBtn');

            confirmImportBtn.onclick = () => {
                const selectedKeys = [];
                optionsContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    selectedKeys.push(checkbox.dataset.key);
                });

                if (selectedKeys.length === 0) {
                    alert('অনুগ্রহ করে ইমপোর্ট করার জন্য কমপক্ষে একটি অপশন নির্বাচন করুন।');
                    return;
                }

                // ★★★ নতুন লজিক শুরু ★★★
                // ধাপ ১: পুরনো মডাল লুকানো এবং প্রগ্রেস মডাল দেখানো
                importModal.classList.remove('active');
                
                const progressModal = document.getElementById('progressModal');
                const progressBar = document.getElementById('progressBar');
                const progressStatusText = document.getElementById('progress-status-text');
                
                progressModal.classList.add('active');
                
                let currentIndex = 0;
                const importMethod = document.querySelector('input[name="import-method"]:checked').value;

                function processNextKey() {
                    if (currentIndex < selectedKeys.length) {
                        const key = selectedKeys[currentIndex];
                        
                        // প্রগ্রেস বার এবং টেক্সট আপডেট
                        progressStatusText.textContent = `${dataKeyToName[key]} ইমপোর্ট করা হচ্ছে...`;
                        const progressPercentage = ((currentIndex + 1) / selectedKeys.length) * 100;
                        progressBar.style.width = `${progressPercentage}%`;

                        // আসল ডেটা ইমপোর্টের কাজ
                        if (importMethod === 'replace') {
                            if (dataRoot[key]) {
                                if (key === 'activities') saveActivities(dataRoot[key]);
                                else db[key] = dataRoot[key];
                            }
                        } else if (importMethod === 'merge') {
                            if (dataRoot[key]) {
                                if (key === 'activities') {
                                    const currentActivities = loadActivities();
                                    const newActivities = dataRoot[key];
                                    const merged = [...newActivities, ...currentActivities];
                                    const uniqueActivities = Array.from(new Map(merged.map(item => [item.id, item])).values());
                                    saveActivities(uniqueActivities);
                                } else {
                                    const currentData = db[key] || [];
                                    const newData = dataRoot[key];
                                    const merged = [...currentData, ...newData];
                                    const uniqueData = Array.from(new Map(merged.map(item => [item.id || item, item])).values());
                                    db[key] = uniqueData;
                                }
                            }
                        }
                        
                        currentIndex++;
                        // পরবর্তী আইটেমের জন্য একটি ছোট বিলম্ব
                        setTimeout(processNextKey, 300);
                    } else {
                        // ইমপোর্ট শেষ হলে
                        saveDb();
                        
                        // লগ তৈরি করার লজিক
                        if (selectedKeys.length === availableDataKeys.length) {
                            addActivity('data_import', 'ব্যাকআপ ফাইল থেকে সকল ডেটা পুনরুদ্ধার করা হয়েছে।', { fileName: file.name, method: importMethod });
                        } else {
                            selectedKeys.forEach(key => {
                                const count = dataRoot[key].length;
                                const bengaliCount = toBengaliNumber(count);
                                const logDescription = `${bengaliCount} ${unitNames[key]} পুনরুদ্ধার করা হয়েছে।`;
                                addActivity('data_import', logDescription, { fileName: file.name, method: importMethod, imported: key });
                            });
                        }

                        // প্রগ্রেস মডাল লুকিয়ে সফল মডাল দেখানো
                        progressModal.classList.remove('active');
                        const successModal = document.getElementById('successModal');
                        successModal.classList.add('active');

                        document.getElementById('ok-btn').onclick = () => {
                    localStorage.setItem('forceRedirectToDashboard', 'true'); // ★★★ নতুন লাইন: ফ্ল্যাগ সেট করা হলো
                          location.reload();
                      };
                    }
                }
                
                // ইমপোর্ট প্রক্রিয়া শুরু করা
                processNextKey();
                // ★★★ নতুন লজিক শেষ ★★★
            };

            closeModalBtn.onclick = () => {
                importModal.classList.remove('active');
                overlay.style.display = 'none';
                event.target.value = '';
            };

        } catch (err) {
            console.error("Import failed:", err);
            alert('ভুল ফাইল ফরম্যাট বা ফাইলটি পড়তে সমস্যা হয়েছে।');
        }
    };
    reader.readAsText(file);
});

      resetBtn.addEventListener('click', () => {
        if (confirm(
            'সতর্কতা! আপনি কি নিশ্চিতভাবে অ্যাপের সকল ডেটা মুছে ফেলতে চান? এই কাজটি ফেরানো যাবে না। ডিফল্ট লোকেশনগুলো পুনরুদ্ধার করা হবে।'
            )) {

          // প্রধান ডেটাবেস মুছে ফেলা
          localStorage.removeItem(DATABASE_KEY);
          localStorage.removeItem('abidNetworkDb_v40'); // পুরনো ভার্সনও মুছে ফেলা
          localStorage.removeItem(LAST_PAGE_KEY);

          // নতুন দুটি লাইন এখানে যোগ করা হয়েছে

          localStorage.removeItem(ACTIVITY_STORAGE_KEY); // সাম্প্রতিক কার্যক্রম মুছে ফেলবে
          localStorage.removeItem('lastExportDate'); // শেষ ব্যাকআপের তারিখ মুছে ফেলবে

          alert('অ্যাপ সফলভাবে রিসেট করা হয়েছে।');
          location.reload();
        }
      });
      const loadMoreBtn = document.getElementById('load-more-activities-btn');
      if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', () => {
          renderRecentActivities(true);
        });
      }

      function setFooterYear() {
        const yearSpan = document.getElementById('footer-year');
        if (yearSpan) {
          yearSpan.textContent = toBengaliNumber(new Date().getFullYear());
        }
      }

      // Customer Profile Modal Logic (UPDATED for v4.1)
      const customerProfileModal = document.getElementById('customerProfileModal');
      const customerProfileModalClose = document.getElementById('customer-profile-modal-close');

      // এই নতুন এবং চূড়ান্ত কোডটি আপনার পুরনো getCustomerFinancialStatus ফাংশনের জায়গায় বসবে

      function getCustomerFinancialStatus(customerId) {
        const customer = db.customers.find(c => c.id === customerId);
        if (customer.isFree) {
            return {
                icon: '⭐',
                text: 'ফ্রি গ্রাহক',
                color: '#319795'
            };
        }
        if (!customer) return null;

        const isActive = customer.isActive === undefined ? true : customer.isActive;
        if (!isActive) {
          let inactiveText = 'নিষ্ক্রিয়';
          if (customer.advanceBalance > 0) {
            inactiveText += ` (অ্যাডভান্স: ৳${toBengaliNumber(customer.advanceBalance.toFixed(2))})`;
          }
          return {
            icon: '⚠️',
            text: inactiveText,
            color: '#E53E3E'
          };
        }

        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();

        const currentBill = db.bills.find(b =>
          b.customerId === customerId &&
          b.year === currentYear &&
          b.month === currentMonth
        );

        if (currentBill) {
          if (currentBill.status === 'paid') {
            if (customer.advanceBalance > 0) {
              return {
                icon: '✨',
                text: `অ্যাডভান্স: ৳${toBengaliNumber(customer.advanceBalance.toFixed(2))}`,
                color: '#3182CE'
              };
            }
            return {
              icon: '✅',
              text: 'পরিশোধিত',
              color: '#38A169'
            };
          }

          const dueFromAdjustments = (currentBill.adjustments || [])
            .filter(adj => adj.type === 'due')
            .reduce((sum, adj) => sum + adj.amount, 0);

          const totalPreviousDue = (currentBill.dueAmount || 0) + dueFromAdjustments;

          if (totalPreviousDue > 0 && currentBill.paidAmount === 0) {
            return {
              icon: '❗',
              text: `পূর্বের বকেয়া: ৳${toBengaliNumber(totalPreviousDue.toFixed(2))}`,
              color: '#DD6B20'
            };
          }

          if (currentBill.paidAmount > 0 && currentBill.remainingDue > 0) {
            return {
              icon: '⏳',
              text: `বর্তমান বকেয়া: ৳${toBengaliNumber(currentBill.remainingDue.toFixed(2))}`,
              color: '#DD6B20'
            };
          }

          return {
            icon: '📄',
            text: 'বিল প্রস্তুত',
            color: '#4A5568'
          };

        } else {
          if (customer.advanceBalance > 0) {
            return {
              icon: '✨',
              text: `অ্যাডভান্স: ৳${toBengaliNumber(customer.advanceBalance.toFixed(2))}`,
              color: '#3182CE'
            };
          }
          return {
            icon: '🗓️',
            text: 'বিল তৈরি হয়নি',
            color: '#718096'
          };
        }
      }

      window.openCustomerProfile = (event, customerId) => {
          event.preventDefault();
      
          const customer = db.customers.find(c => c.id === customerId);
          if (!customer) return;
      
          document.getElementById("profile-customer-name").textContent = customer.name;
          document.getElementById("profile-house").textContent = customer.house;
          document.getElementById("profile-bill").textContent = customer.isFree ? 'প্রযোজ্য নয়' : `৳${toBengaliNumber(customer.monthlyBill.toFixed(2))}`;
          document.getElementById("profile-connection-date").textContent = toBengaliNumber(new Date(customer.connectionDate).toLocaleDateString('bn-BD'));
          document.getElementById("profile-mac").textContent = customer.macAddress || 'N/A';
      
          const phoneIconLink = document.getElementById('profile-icon-phone-link');
          const phoneSpan = document.getElementById('profile-phone');
      
          if (customer.phone && customer.phone.trim() !== '') {
              phoneSpan.textContent = toBengaliNumber(customer.phone);
              phoneIconLink.href = `tel:${customer.phone}`;
              phoneIconLink.style.cursor = 'pointer';
          } else {
              phoneSpan.textContent = 'N/A';
              phoneIconLink.href = '#';
              phoneIconLink.style.cursor = 'default';
          }
      
          const financialStatus = getCustomerFinancialStatus(customerId);
          const statusContainer = document.getElementById('profile-status-container');
          const statusIcon = document.getElementById('profile-status-icon');
          const statusText = document.getElementById('profile-status-text');
      
          if (financialStatus) {
              statusIcon.textContent = financialStatus.icon;
              statusText.textContent = financialStatus.text;
              statusText.style.color = financialStatus.color;
              statusContainer.style.display = 'flex';
          } else {
              statusContainer.style.display = 'none';
          }
      
          const billingHistoryContainer = document.getElementById('profile-billing-history');
          billingHistoryContainer.innerHTML = '';
          const customerBills = db.bills.filter(b => b.customerId === customerId)
              .sort((a, b) => new Date(b.year, b.month) - new Date(a.year, a.month));
      
          if (customerBills.length === 0) {
              billingHistoryContainer.innerHTML =
                  '<li style="text-align: center; padding: 10px; font-size: 12px; color: #6c757d;">কোনো বিলের ইতিহাস পাওয়া যায়নি।</li>';
          } else {
              customerBills.forEach(bill => {
                  const li = document.createElement('li');
                  let statusClass, statusText, dueText = '';
                  const totalBillAmount = bill.monthlyAmount + (bill.dueAmount || 0) +
                      ((bill.adjustments || []).filter(a => a.type === 'due').reduce((sum, a) => sum + a.amount, 0));
      
                  if (bill.status === 'paid') {
                      statusClass = 'status-paid';
                      statusText = 'পরিশোধিত';
                  } else if (bill.status === 'partially_paid') {
                      statusClass = 'status-partially-paid';
                      statusText = 'আংশিক';
                      if (bill.remainingDue > 0) {
                          dueText =
                              `<span class="due">বকেয়া: ৳${toBengaliNumber(bill.remainingDue.toFixed(2))}</span>`;
                      }
                  } else {
                      statusClass = 'status-unpaid';
                      statusText = 'বকেয়া';
                  }
      
                  li.className = `billing-history-item ${statusClass}`;
                  li.innerHTML = `
                      <div class="item-info">
                          <span class="month">${months[bill.month]}, ${toBengaliNumber(bill.year)}</span>
                          <span class="details">মোট বিল: ৳${toBengaliNumber(totalBillAmount.toFixed(2))}</span>
                      </div>
                      <div class="item-status">
                          <span class="status">${statusText}</span>
                          ${dueText}
                      </div>
                  `;
                  billingHistoryContainer.appendChild(li);
              });
          }
      
          const actionButtonContainer = document.getElementById('profile-action-buttons');
          const isActive = customer.isActive === undefined ? true : customer.isActive;
      
          if (isActive) {
              actionButtonContainer.innerHTML =
                  `<button class="simple-status-btn btn-is-active" onclick="deactivateCustomer('${customer.id}')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg><span>সক্রিয়</span></button>`;
          } else {
              actionButtonContainer.innerHTML =
                  `<button class="simple-status-btn btn-is-inactive" onclick="reactivateCustomer('${customer.id}')"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/></svg><span>নিষ্ক্রিয়</span></button>`;
          }
      
          const customerProfileModal = document.getElementById('customerProfileModal');
          customerProfileModal.classList.add('active');
          document.getElementById('overlay').style.display = 'block';
      };

      window.deactivateCustomer = function(customerId) {
          const customer = db.customers.find(c => c.id === customerId);
          if (!customer) return;
      
          const currentMonth = new Date().getMonth();
          const currentYear = new Date().getFullYear();
      
          const currentBill = db.bills.find(b =>
              b.customerId === customerId &&
              b.year === currentYear &&
              b.month === currentMonth
          );
      
          if (currentBill && currentBill.status !== 'paid') {
              if (confirm(
                  `এই গ্রাহকের চলতি মাসের বিল (${months[currentMonth]}) তৈরি করা আছে।\n\nআপনি কি চান যে বিলটি পরিশোধ হওয়ার সাথে সাথে গ্রাহক স্বয়ংক্রিয়ভাবে নিষ্ক্রিয় হয়ে যাক?`
              )) {
                  customer.deactivationPending = true;
                  saveDb();
                  
                  // ★★★ নতুন লগ এখানে যোগ করা হয়েছে ★★★
                  addActivity('customer_deactivation_pending', `${customer.name}-এর সংযোগ বিল পরিশোধের পর নিষ্ক্রিয় হবে`, {
                      customerName: customer.name,
                      status: 'Deactivation Pending'
                  });
      
                  alert(
                      `অনুরোধটি গ্রহণ করা হয়েছে।\n${customer.name}-এর বিল পরিশোধ হওয়ার পর সংযোগটি স্বয়ংক্রিয়ভাবে নিষ্ক্রিয় হয়ে যাবে।`
                  );
                  closeCustomerProfile();
                  renderCustomerListPage();
              }
          } else {
              if (confirm(`আপনি কি নিশ্চিতভাবে ${customer.name}-এর সংযোগ নিষ্ক্রিয় করতে চান?`)) {
                  customer.isActive = false;
                  customer.deactivationPending = false;
                  saveDb();
      
                  // ★★★ নতুন লগ এখানে যোগ করা হয়েছে ★★★
                  addActivity('customer_status_change', `${customer.name}-এর সংযোগ নিষ্ক্রিয় করা হয়েছে`, {
                      customerName: customer.name,
                      newStatus: 'Inactive'
                  });
      
                  alert(`${customer.name}-এর সংযোগ সফলভাবে নিষ্ক্রিয় করা হয়েছে।`);
                  closeCustomerProfile();
                  renderCustomerListPage();
              }
          }
      }

      window.reactivateCustomer = function(customerId) {
          const customer = db.customers.find(c => c.id === customerId);
          if (customer) {
              customer.isActive = true;
              saveDb();
              
              // ★★★ নতুন লগ এখানে যোগ করা হয়েছে ★★★
              addActivity('customer_status_change', `${customer.name}-এর সংযোগ পুনরায় সক্রিয় করা হয়েছে`, {
                  customerName: customer.name,
                  newStatus: 'Active'
              });
      
              alert(`${customer.name}-এর সংযোগ সফলভাবে পুনরায় সক্রিয় করা হয়েছে।`);
              closeCustomerProfile();
              renderCustomerListPage();
          }
      }

      function closeCustomerProfile() {
        const customerProfileModal = document.getElementById('customerProfileModal');
        const overlay = document.getElementById('overlay');
        if (customerProfileModal) {
          customerProfileModal.classList.remove('active');
        }
        if (overlay) {
          overlay.style.display = 'none';
        }
      }

      customerProfileModalClose.addEventListener('click', () => {
        customerProfileModal.classList.remove('active');
        overlay.style.display = 'none';
      });

      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          sidebar.classList.remove('active');
          customerProfileModal.classList.remove('active');
          ispEditModal.classList.remove('active');
          adjustmentModal.classList.remove('active');
          locationEditModal.classList.remove('active');
          overlay.style.display = 'none';
        }
      });

      loadDb();
      setFooterYear();

// Load saved website customizations
    const savedName = localStorage.getItem('websiteName');
    const savedLogo = localStorage.getItem('websiteLogo');

        if (savedName) {
            document.getElementById("header-company-name").textContent = savedName;
            document.getElementById("sidebar-company-name").textContent = savedName;
            document.title = savedName;
        }
        
        // শুধু তখনই লোগো পরিবর্তন করো, যখন localStorage-এ কোনো ডেটা থাকে
        if (savedLogo) {
            const headerLogoImg = document.getElementById("header-company-logo");
            headerLogoImg.src = savedLogo;
            headerLogoImg.style.display = "inline-block"; // Make sure it's visible
            const sidebarLogoImg = document.getElementById("sidebar-company-logo");
            sidebarLogoImg.src = savedLogo;
            sidebarLogoImg.style.display = "inline-block"; // Make sure it's visible
        }
// else ব্লকটি মুছে ফেলা হয়েছে, তাই localStorage-এ লোগো না থাকলে কিছুই হবে না

    // ★★★ নতুন এবং চূড়ান্ত সমাধান শুরু ★★★
        const forceRedirect = localStorage.getItem('forceRedirectToDashboard');
        
        if (forceRedirect === 'true') {
            localStorage.removeItem('forceRedirectToDashboard'); // ফ্ল্যাগটি ব্যবহার করে মুছে ফেলা হলো
            switchPage('dashboard', true); // জোর করে ড্যাশবোর্ডে পাঠানো হলো
        } else {
            const initialPage = window.location.hash.substring(1) || localStorage.getItem(LAST_PAGE_KEY) || 'dashboard';
switchPage(initialPage, true);
 // স্বাভাবিক আচরণ
        }
// ★★★ নতুন এবং চূড়ান্ত সমাধান শেষ ★★★

      // --- এই ফাংশনটি খুঁজে বের করে প্রতিস্থাপন করুন ---

      function submitPayment() {
        const receivedAmountInput = document.getElementById('payment-amount-input');
        const receivedAmount = parseFloat(receivedAmountInput.value);

        if (isNaN(receivedAmount) || receivedAmount <= 0) {
          alert('অনুগ্রহ করে একটি বৈধ টাকার পরিমাণ লিখুন!');
          return;
        }

        if (!currentPaymentBillId) {
          alert('ত্রুটি: বিল আইডি পাওয়া যায়নি!');
          return;
        }

        const paymentResult = logPayment(currentPaymentBillId, receivedAmount);

        if (paymentResult.success) {
          alert(paymentResult.message); // ★★★ একটিমাত্র সমন্বিত বার্তা দেখানো হচ্ছে ★★★
        } else {
          alert(`একটি ত্রুটি ঘটেছে: ${paymentResult.message}`);
        }

        closePaymentModal();
        renderBillingPage();
        renderDashboard();
      }

      /**
       * পেমেন্ট মোডাল এবং ওভারলে বন্ধ করে।
       */

      // --- আপনার পুরনো সম্পূর্ণ recalculateBillTotal ফাংশনটি মুছে, এই নতুন কোডটি পেস্ট করুন ---

      function recalculateBillTotal(billId) {
        const bill = db.bills.find(b => b.id === billId);
        if (!bill) return;

        const customer = db.customers.find(c => c.id === bill.customerId);
        if (!customer) return;

        const dueFromAdjustments = (bill.adjustments || []).filter(a => a.type === 'due').reduce((sum, a) => sum + a
          .amount, 0);
        const grossTotalBill = bill.monthlyAmount + bill.dueAmount + dueFromAdjustments;
        const discount = bill.discount || 0;
        const netTotalBill = grossTotalBill - discount;

        bill.paidAmount = (bill.paymentHistory || []).reduce((sum, p) => sum + p.amount, 0);

        let remainingDue = netTotalBill - bill.paidAmount;

        if (remainingDue > 0 && (customer.advanceBalance || 0) > 0) {
          const amountToUseFromAdvance = Math.min(remainingDue, customer.advanceBalance);

          customer.advanceBalance -= amountToUseFromAdvance;
          bill.paidAmount += amountToUseFromAdvance;
          bill.advanceUsed = (bill.advanceUsed || 0) + amountToUseFromAdvance;

          if (!bill.paymentHistory) {
            bill.paymentHistory = [];
          }
          bill.paymentHistory.push({
            id: Date.now() + Math.random(),
            amount: amountToUseFromAdvance,
            date: new Date().toISOString(),
            source: 'advance',
            balanceAfter: remainingDue - amountToUseFromAdvance
          });

          remainingDue -= amountToUseFromAdvance;
        }

        if (remainingDue < 0) {
          const newAdvance = Math.abs(remainingDue);
          customer.advanceBalance = (customer.advanceBalance || 0) + newAdvance;
          remainingDue = 0;
        }

        bill.totalAmount = grossTotalBill;
        bill.remainingDue = remainingDue;

        if (bill.remainingDue <= 0) {
          bill.status = 'paid';
          bill.isPaid = true;
        } else if (bill.paidAmount > 0) {
          bill.status = 'partially_paid';
          bill.isPaid = false;
        } else {
          bill.status = 'unpaid';
          bill.isPaid = false;
        }
      }

      // ★★★ ডিসকাউন্ট বাটনের জন্য নতুন ইভেন্ট লিসেনার ★★★
      // ★★★ apply-discount-btn এর পুরনো কোডটি এই নতুন কোড দিয়ে প্রতিস্থাপন করুন ★★★

      const applyDiscountBtn = document.getElementById('apply-discount-btn');
      if (applyDiscountBtn) {
        applyDiscountBtn.addEventListener('click', () => {
          const discountAmountInput = document.getElementById('discount-amount-input');
          const discountAmount = parseFloat(discountAmountInput.value);

          if (isNaN(discountAmount) || discountAmount <= 0) { // এখন ০ টাকা ছাড় দেওয়া যাবে না
            alert('অনুগ্রহ করে একটি বৈধ ছাড়ের পরিমাণ লিখুন!');
            return;
          }

          if (!currentPaymentBillId) {
            alert('ত্রুটি: বিল আইডি পাওয়া যায়নি!');
            return;
          }

          const bill = db.bills.find(b => b.id === currentPaymentBillId);
          if (!bill) {
            alert('ত্রুটি: বিল খুঁজে পাওয়া যায়নি!');
            return;
          }

          const customer = db.customers.find(c => c.id === bill.customerId);
          if (!customer) return;

          const totalBill = bill.totalAmount || 0;
          const paidAmount = bill.paidAmount || 0;
          const maxDiscount = totalBill - paidAmount;

          if (discountAmount > maxDiscount) {
            alert(`আপনি সর্বোচ্চ ৳${toBengaliNumber(maxDiscount.toFixed(2))} পর্যন্ত ছাড় দিতে পারবেন।`);
            return;
          }

          bill.discount = (bill.discount || 0) + discountAmount;
          recalculateBillTotal(bill.id);
          saveDb();

          alert(`৳${toBengaliNumber(discountAmount.toFixed(2))} ছাড় সফলভাবে প্রয়োগ করা হয়েছে।`);

          // ★★★ নতুন এবং গুরুত্বপূর্ণ অংশ: ছাড়ের জন্য লগ তৈরি ★★★
          addActivity('discount_applied',
            `${customer.name}-কে ৳${toBengaliNumber(discountAmount.toFixed(2))} বিশেষ ছাড় দেওয়া হয়েছে`, {
              customerName: customer.name,
              amount: discountAmount,
              month: bill.month,
              year: bill.year
            });
          // ★★★ নতুন অংশের শেষ ★★★

          // মোডাল রিফ্রেশ করে নতুন হিসাব দেখানোর জন্য
          openPaymentModal(bill.id);
          discountAmountInput.value = ''; // ইনপুট বক্স খালি করা
        });
      }

//--- এই সম্পূর্ণ ফাংশনটি আপনার পুরনো logPayment ফাংশনের জায়গায় বসান ---

function logPayment(billId, receivedAmount) {
    const initialBill = db.bills.find(b => b.id === billId);
    if (!initialBill) return { success: false, message: 'বিল খুঁজে পাওয়া যায়নি।' };

    const customer = db.customers.find(c => c.id === initialBill.customerId);
    if (!customer) return { success: false, message: 'গ্রাহক খুঁজে পাওয়া যায়নি.' };

    // ★★★ নতুন এবং চূড়ান্তভাবে পরীক্ষিত FIFO লজিক (Chain Reaction Bug Fix) ★★★
    let remainingAmountToDistribute = receivedAmount;
    let finalMessage = `৳${toBengaliNumber(receivedAmount)} পেমেন্ট সফলভাবে জমা হয়েছে।`;

    // ধাপ ১: গ্রাহকের সকল বিল খুঁজে বের করা এবং সবচেয়ে পুরনো বিল আগে রাখা
    const allCustomerBills = db.bills
        .filter(b => b.customerId === customer.id)
        .sort((a, b) => new Date(a.year, a.month) - new Date(a.year, a.month));

    // ধাপ ২: প্রাপ্ত টাকা দিয়ে পুরনো বিলগুলো একটির পর একটি পরিশোধ করা (পুনর্গঠিত)
    let previousDue = 0;
    for (const billToPay of allCustomerBills) {
        // ★★★ মূল সমাধান: প্রতিটি বিলের কাজ শুরু করার আগে তার dueAmount আপডেট করা হচ্ছে ★★★
        billToPay.dueAmount = previousDue;
        const dueFromAdjustments = (billToPay.adjustments || []).filter(a => a.type === 'due').reduce((sum, a) => sum + a.amount, 0);
        billToPay.totalAmount = billToPay.monthlyAmount + billToPay.dueAmount + dueFromAdjustments;
        billToPay.remainingDue = billToPay.totalAmount - (billToPay.paidAmount || 0) - (billToPay.discount || 0);

        // শুধুমাত্র অপরিশোধিত বিলগুলোই পেমেন্ট গ্রহণ করবে
        if (billToPay.status === 'paid') {
            previousDue = billToPay.remainingDue < 0.01 ? 0 : billToPay.remainingDue;
            continue;
        }
        if (remainingAmountToDistribute < 0.01) {
            previousDue = billToPay.remainingDue < 0.01 ? 0 : billToPay.remainingDue;
            continue;
        }

        const dueOnThisBill = billToPay.remainingDue;
        const amountToPayForThisBill = Math.min(remainingAmountToDistribute, dueOnThisBill);

        billToPay.paidAmount = (billToPay.paidAmount || 0) + amountToPayForThisBill;
        billToPay.remainingDue -= amountToPayForThisBill;

        const isFinalPayment = billToPay.remainingDue < 0.01;

        if (!billToPay.paymentHistory) billToPay.paymentHistory = [];
        billToPay.paymentHistory.push({
            id: Date.now() + Math.random(),
            amount: amountToPayForThisBill,
            date: new Date().toISOString(),
            source: 'manual',
            balanceAfter: isFinalPayment ? 0 : billToPay.remainingDue,
            isFinalPayment: isFinalPayment,
            newAdvance: 0
        });

        if (isFinalPayment) {
            billToPay.remainingDue = 0;
            billToPay.status = 'paid';
            billToPay.isPaid = true;
            addActivity('bill_status_paid', `${customer.name}-এর ${months[billToPay.month]} মাসের বিল পরিশোধিত হয়েছে`, {
                customerName: customer.name, amount: amountToPayForThisBill, month: billToPay.month, year: billToPay.year
            });
        } else {
            billToPay.status = 'partially_paid';
            addActivity('payment_history', `${customer.name}-এর ${months[billToPay.month]} মাসের বিল আংশিক পরিশোধিত`, {
                customerName: customer.name, amount: amountToPayForThisBill, remainingDue: billToPay.remainingDue, month: billToPay.month, year: billToPay.year
            });
        }

        remainingAmountToDistribute -= amountToPayForThisBill;
        previousDue = billToPay.remainingDue < 0.01 ? 0 : billToPay.remainingDue;
    }

    // ধাপ ৩: সকল বকেয়া পরিশোধের পর যদি টাকা অবশিষ্ট থাকে, তবে তা অ্যাডভান্স হিসেবে জমা হবে
    if (remainingAmountToDistribute > 0) {
        customer.advanceBalance = (customer.advanceBalance || 0) + remainingAmountToDistribute;
        finalMessage += ` অতিরিক্ত ৳${toBengaliNumber(remainingAmountToDistribute.toFixed(2))} অ্যাডভান্স হিসেবে জমা হয়েছে।`;
        
        const lastPaidBill = allCustomerBills.filter(b => b.status === 'paid').slice(-1)[0];
        if (lastPaidBill) {
            const lastPaymentInHistory = lastPaidBill.paymentHistory.slice(-1)[0];
            if (lastPaymentInHistory) {
                lastPaymentInHistory.newAdvance = remainingAmountToDistribute;
            }
        }
        
        addActivity('deposit_advance', `${customer.name}-এর অ্যাকাউন্টে অতিরিক্ত ৳${toBengaliNumber(remainingAmountToDistribute.toFixed(2))} অ্যাডভান্স জমা হয়েছে`, {
            customerName: customer.name, amount: remainingAmountToDistribute, source: 'Overpayment'
        });
    }

    // ধাপ ৪: গ্রাহকের নিষ্ক্রিয় হওয়ার লজিক (এখন সঠিক ডেটার উপর কাজ করবে)
    let wasDeactivated = false;
    const hasRemainingDues = db.bills.some(b => b.customerId === customer.id && b.status !== 'paid');
    if (!hasRemainingDues && customer.deactivationPending === true) {
        customer.isActive = false;
        customer.deactivationPending = false;
        wasDeactivated = true;
        finalMessage = `পেমেন্ট সফল এবং গ্রাহক "${customer.name}"-কে নিষ্ক্রিয় করা হয়েছে।`;
        addActivity('customer_deactivated_auto', `বিল পরিশোধের পর ${customer.name} স্বয়ংক্রিয়ভাবে নিষ্ক্রিয় হয়েছে।`, { customerName: customer.name });
    }

    saveDb();

    return {
        success: true,
        message: finalMessage,
        deactivated: wasDeactivated
    };
}

      // পেমেন্ট মোডালের বাটনগুলোর জন্য ইভেন্ট লিসেনার যোগ করা
      const submitPaymentBtn = document.getElementById('submit-payment-btn');
      const closeModalBtn = document.querySelector('.payment-modal-close');
      const cancelModalBtn = document.querySelector('.payment-btn-cancel');

      if (submitPaymentBtn) {
        submitPaymentBtn.addEventListener('click', submitPayment);
      }
      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closePaymentModal);
      }
      if (cancelModalBtn) {
        cancelModalBtn.addEventListener('click', closePaymentModal);
      }
      const clearActivityLogBtn = document.getElementById('clear-activity-log-btn');

      if (clearActivityLogBtn) {
        clearActivityLogBtn.addEventListener('click', () => {
          if (confirm(
              'আপনি কি নিশ্চিতভাবে সকল সাম্প্রতিক কার্যক্রমের লগ মুছে ফেলতে চান? এই কাজটি ফেরানো যাবে না।')) {

            const ACTIVITY_STORAGE_KEY = 'abidNetworkActivities_v1';
            localStorage.removeItem(ACTIVITY_STORAGE_KEY);

            const activitiesContainer = document.getElementById('recent-activities');
            const noActivitiesDiv = document.getElementById('no-activities');
            const loadMoreBtnContainer = document.getElementById('activity-loader');

            if (activitiesContainer) {
              activitiesContainer.innerHTML = '';
              activitiesContainer.style.display = 'none';
            }
            if (noActivitiesDiv) {
              noActivitiesDiv.style.display = 'block';
            }
            if (loadMoreBtnContainer) {
              loadMoreBtnContainer.style.display = 'none';
            }
            renderRecentActivities();

            alert('সকল কার্যক্রমের লগ সফলভাবে মুছে ফেলা হয়েছে।');
          }
        });
      }

      // Initialize version management
      initializeVersionManagement();

      function setupMacInput(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = '';
        container.style.position = 'relative';

        const realInput = document.createElement('input');
        realInput.type = 'text';
        realInput.maxLength = 17;
        realInput.placeholder = 'XX:XX:XX:XX:XX:XX';

        // ★★★ মূল পরিবর্তন: আমরা একটি নির্দিষ্ট আইডি যোগ করছি ★★★
        realInput.id = containerId + '-real-input'; // যেমন: 'customerMacContainer-real-input'

        realInput.style.width = '100%';
        realInput.style.border = '1px solid #ccc';
        realInput.style.padding = '8px';
        realInput.style.letterSpacing = '3px';
        realInput.style.fontFamily = 'monospace';
        realInput.style.fontSize = '16px';
        realInput.style.boxSizing = 'border-box';

        container.appendChild(realInput);

        const formatMacAddress = (e) => {
          let value = realInput.value;
          let cleanValue = value.replace(/[^a-fA-F0-9]/g, '').toUpperCase();
          let formattedValue = '';
          for (let i = 0; i < cleanValue.length; i++) {
            if (i > 0 && i % 2 === 0) {
              formattedValue += ':';
            }
            formattedValue += cleanValue[i];
          }
          realInput.value = formattedValue;
        };

        realInput.addEventListener('input', formatMacAddress);

        realInput.addEventListener('paste', (e) => {
          setTimeout(() => {
            formatMacAddress(e);
          }, 0);
        });
      }

      const macStyle = document.createElement('style');
      macStyle.textContent = `
        .mac-input-container { display: flex; align-items: center; gap: 5px; }
        .mac-input-box {
            width: 15%; height: 32px; text-align: center;
            font-family: 'Courier New', monospace; font-size: 14px;
            font-weight: 600; text-transform: uppercase;
            border: 1px solid #CBD5E0; border-radius: 5px; padding: 0;
        }
        .mac-input-box:focus {
            border-color: var(--secondary-color); outline: none;
            box-shadow: 0 0 5px rgba(90, 103, 216, 0.3);
        }
        .mac-separator { font-size: 16px; font-weight: bold; color: #A0AEC0; }
  `;
      document.head.appendChild(macStyle);

    });

    function getMacAddress(containerId) {
      const realInput = document.getElementById(containerId + '-real-input');
      if (realInput && realInput.value.length === 17) {
        return realInput.value.toUpperCase();
      }
      return '';
    }

    function setMacAddress(containerId, mac) {
      const realInput = document.getElementById(containerId + '-real-input');
      if (realInput) {
        realInput.value = mac || '';
      }
    }

    // Version Management System
    function initializeVersionManagement() {
      updateSystemVersion();
      updateLastUpdateDate();
    }

    function updateSystemVersion() {
      const currentVersion = "v4.3.0";
      const versionElement = document.getElementById('system-version');
      if (versionElement) {
        versionElement.textContent = currentVersion;
      }
    }

    function updateLastUpdateDate() {
      const lastUpdateString = "০৯ আগষ্ট ২০২৫";
      const dateElement = document.getElementById('last-update-date');
      if (dateElement) {
        dateElement.textContent = lastUpdateString;
      }
    }

    function showChangeLog() {
      const changeLogModal = document.getElementById("changeLogModal");
      const overlay = document.getElementById("overlay");
      if (!changeLogModal) {
        createChangeLogModal();
      }
      document.getElementById("changeLogModal").classList.add("active");
      overlay.style.display = "block";
    }

    function createChangeLogModal() {
      const modalHTML = `
        <div class="modal" id="changeLogModal">
            <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2 style="color: var(--secondary-color); display: flex; align-items: center; gap: 10px;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                            <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                        </svg>
                        Change Log
                    </h2>
                    <button class="modal-close" id="changeLogModalCloseBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="changelog-content">
                        <div class="version-block">
                            <h3 style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px;">v4.2.0 - ২৪ জুলাই ২০২৫</h3>
                            <div class="change-category">
                                <h4 style="color: #28a745;">✨ নতুন ফিচার</h4>
                                <ul>
                                    <li>স্বয়ংক্রিয় ভার্সন আপডেট সিস্টেম যোগ করা হয়েছে</li>
                                    <li>শেষ আপডেটের তারিখ স্বয়ংক্রিয়ভাবে প্রদর্শন</li>
                                    <li>Change Log বাটন এবং পপআপ উইন্ডো যোগ করা হয়েছে</li>
                                    <li>আপডেট ইতিহাস ট্র্যাকিং সিস্টেম</li>
                                </ul>
                            </div>
                            <div class="change-category">
                                <h4 style="color: #17a2b8;">🔧 উন্নতি</h4>
                                <ul>
                                    <li>About পেইজের UI/UX উন্নত করা হয়েছে</li>
                                    <li>ভার্সন তথ্য প্রদর্শনী আরও আকর্ষণীয় করা হয়েছে</li>
                                    <li>Change Log এর জন্য সুন্দর ডিজাইন যোগ করা হয়েছে</li>
                                </ul>
                            </div>
                        </div>

                        <div class="version-block">
                            <h3 style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px;">v4.1.0 - জানুয়ারি ২০২৫</h3>
                            <div class="change-category">
                                <h4 style="color: #28a745;">✨ নতুন ফিচার</h4>
                                <ul>
                                    <li>About পেইজ যোগ করা হয়েছে</li>
                                    <li>সিস্টেম তথ্য প্রদর্শনী</li>
                                    <li>যোগাযোগের তথ্য সেকশন</li>
                                    <li>ডেভলপমেন্ট টিমের তথ্য</li>
                                </ul>
                            </div>
                            <div class="change-category">
                                <h4 style="color: #17a2b8;">🔧 উন্নতি</h4>
                                <ul>
                                    <li>নেভিগেশন মেনুতে About লিংক যোগ</li>
                                    <li>রেসপন্সিভ ডিজাইন উন্নত করা</li>
                                </ul>
                            </div>
                        </div>

                        <div class="version-block">
                            <h3 style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 5px;">v4.0.0 - ডিসেম্বর ২০২৪</h3>
                            <div class="change-category">
                                <h4 style="color: #28a745;">✨ নতুন ফিচার</h4>
                                <ul>
                                    <li>রাউটার ম্যানেজমেন্ট সিস্টেম</li>
                                    <li>উন্নত বিল ব্যবস্থাপনা</li>
                                    <li>গ্রাহক প্রোফাইল সিস্টেম</li>
                                    <li>রিপোর্ট জেনারেশন</li>
                                </ul>
                            </div>
                            <div class="change-category">
                                <h4 style="color: #ffc107;">🐛 বাগ ফিক্স</h4>
                                <ul>
                                    <li>ডেটা সেভ করার সমস্যা সমাধান</li>
                                    <li>মোবাইল রেসপন্সিভনেস উন্নত করা</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;

      document.body.insertAdjacentHTML("beforeend", modalHTML);

      // Add event listener for close button
      document.getElementById("changeLogModalCloseBtn").addEventListener("click", closeChangeLogModal);

      // Add CSS for changelog
      const style = document.createElement("style");
      style.textContent = `
            .changelog-content {
                font-family: 'Noto Sans Bengali', sans-serif;
            }
            .version-block {
                margin-bottom: 30px;
                padding: 20px;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                background: #fafafa;
            }
            .version-block h3 {
                margin-top: 0;
                margin-bottom: 15px;
            }
            .change-category {
                margin-bottom: 15px;
            }
            .change-category h4 {
                margin-bottom: 8px;
                font-size: 16px;
            }
            .change-category ul {
                margin: 0;
                padding-left: 20px;
            }
            .change-category li {
                margin-bottom: 5px;
                line-height: 1.5;
            }
        `;
      document.head.appendChild(style);
    }

    function closeChangeLogModal() {
      document.getElementById("changeLogModal").classList.remove("active");
      document.getElementById("overlay").style.display = "none";
    }

    // Backup reminder functions
    function showBackupReminder() {
      const notification = document.getElementById('backup-reminder-notification');
      if (notification) {
        notification.style.display = 'block';
      }

      // Also show on dashboard
      const dashboardNotification = document.getElementById('dashboard-backup-reminder-notification');
      if (dashboardNotification) {
        dashboardNotification.style.display = 'block';
      }
    }

    function hideBackupReminder() {
      const notification = document.getElementById('backup-reminder-notification');
      if (notification) {
        notification.style.display = 'none';
      }
    }

    function hideDashboardBackupReminder() {
      const dashboardNotification = document.getElementById('dashboard-backup-reminder-notification');
      if (dashboardNotification) {
        dashboardNotification.style.display = 'none';
      }

      // Also hide the settings page notification
      const settingsNotification = document.getElementById('backup-reminder-notification');
      if (settingsNotification) {
        settingsNotification.style.display = 'none';
      }
    }

    function updateLastExportDate() {
      const lastExportDate = localStorage.getItem('lastExportDate') || 'কখনো নেওয়া হয়নি';
      const dateElement = document.getElementById('last-export-date');
      if (dateElement) {
        dateElement.textContent = lastExportDate;
      }
    }

  </script>
<!-- FINAL & COMPLETE PAYMENT MODAL HTML (REPLACE YOURS WITH THIS) -->

<div id="paymentModal" class="payment-modal">
    <div class="action-window">
        <button class="payment-modal-close">&times;</button>
        
        <div class="window-header">
            <h2>পেমেন্ট জমা করুন</h2>
        </div>

        <div class="window-body">
            <!-- Bill Info Box -->
            <div class="bill-info-box">
                <div class="info-row"><span>গ্রাহক:</span> <span id="payment-customer-name"></span></div>
                <div class="info-row"><span>মাস:</span> <span id="payment-bill-month"></span></div>
                <div class="info-row"><span>বিলের পরিমাণ:</span> <span id="payment-bill-amount"></span></div>
                <div class="info-row"><span>বকেয়া:</span> <span id="payment-due-amount"></span></div>
                <div class="info-row"><span>এডভান্স:</span> <span id="payment-advance-amount"></span></div>
            </div>
            
            <!-- CORRECTED: Payment Amount Field -->
            <div class="form-group">
                <div class="form-group-inline">
                    <label for="payment-amount-input">🪙 প্রাপ্ত টাকার পরিমাণ (৳):</label>
                    <input type="number" id="payment-amount-input" placeholder="পরিমাণ">
                </div>
            </div>

            <!-- Payment History Section -->
            <div class="form-group">
                <label>🕒 পেমেন্ট ইতিহাস</label>
                <div class="history-section" id="payment-history-list">
                    <!-- JS will populate this -->
                </div>
            </div>
            
            <!-- CORRECTED & ADDED: Discount Field -->
            <div class="form-group">
                <div class="form-group-inline">
                    <label for="discount-amount-input">🏷️ বিশেষ ছাড় (৳):</label>
                    <input type="number" id="discount-amount-input" placeholder="পরিমাণ">
                    <button id="apply-discount-btn" class="btn">প্রয়োগ</button>
                </div>
            </div>
        </div>

        <div class="window-actions">
            <button class="action-btn-modal payment-btn-cancel">বাতিল</button>
            <button id="submit-payment-btn" class="action-btn-modal btn-submit-modal">জমা দিন</button>
        </div>
    </div>
</div>
<!-- Selective Backup Modal (নতুন HTML কোড) -->
<div class="modal" id="selectiveBackupModal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>ব্যাকআপ অপশন বেছে নিন</h2>
            <button class="modal-close" id="backupModalCloseBtn">&times;</button>
        </div>
        <div class="modal-body">
            <p style="font-size: 14px; margin-top: 0; color: #666;">আপনি কোন কোন তথ্য ব্যাকআপ করতে চান, তা নিচে থেকে বেছে নিন।</p>
            <div class="backup-options-container">
                <label class="backup-option">
                    <input type="checkbox" id="backup-select-all">
                    <span class="option-label"><strong>সবকিছু নির্বাচন করুন</strong></span>
                </label>
                <hr>
                <label class="backup-option" data-option-for="customers"></label>
                <label class="backup-option" data-option-for="bills"></label>
                <label class="backup-option" data-option-for="routers"></label>
                <label class="backup-option" data-option-for="ispPayments"></label>
                <label class="backup-option" data-option-for="locations"></label>
                <label class="backup-option" data-option-for="activities"></label>
            </div>
            <div style="text-align: right; margin-top: 25px;">
                <button id="createBackupBtn" class="btn btn-submit">ব্যাকআপ তৈরি করুন</button>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="selectiveImportModal">
    <div class="modal-content" style="max-width: 550px;">
        <div class="modal-header">
            <h2>ইমপোর্ট অপশন বেছে নিন</h2>
            <button class="modal-close" id="importModalCloseBtn">&times;</button>
        </div>
        <div class="modal-body">
            <p id="import-file-info" style="font-size: 14px; margin-top: 0; color: #666;"></p>
            <div id="import-options-container" class="backup-options-container">
            </div>
            <div class="import-method-container" style="margin-top: 20px;">
                <strong style="display: block; margin-bottom: 10px; font-size: 14px;">ইমপোর্টের ধরণ:</strong>
                <label class="backup-option">
                    <input type="radio" name="import-method" value="replace" checked>
                    <span class="option-label">পুরনো ডেটা মুছে নতুন ডেটা যোগ করুন (Replace)</span>
                </label>
                <p style="font-size: 12px; color: #888; margin-left: 30px; margin-top: 0;">(সুপারিশকৃত: এটি আপনার বর্তমান ডেটা মুছে ফাইলের ডেটা দিয়ে প্রতিস্থাপন করবে।)</p>
                
                <label class="backup-option">
                    <input type="radio" name="import-method" value="merge">
                    <span class="option-label">বর্তমান ডেটার সাথে নতুন ডেটা যোগ করুন (Merge)</span>
                </label>
                <p style="font-size: 12px; color: #888; margin-left: 30px; margin-top: 0;">(ফাইলের নতুন ডেটাগুলো আপনার বর্তমান ডেটার সাথে যুক্ত হবে।)</p>
            </div>

            <div class="import-warning" style="background-color: #fffbe6; border: 1px solid #ffe58f; border-radius: 6px; padding: 12px; margin-top: 20px; font-size: 13px; color: #8a6d3b;">
                <strong>সতর্কতা:</strong> ইমপোর্ট করার পর আপনার বর্তমান ডেটা পরিবর্তন হয়ে যাবে। এই কাজটি ফেরানো যাবে না।
            </div>
            <div style="text-align: right; margin-top: 25px;">
                <button id="confirmImportBtn" class="btn btn-submit" style="background-color: #2B6CB0;">ডেটা ইমপোর্ট করুন</button>
            </div>
        </div>
    </div>
</div>
<!-- প্রগ্রেস মডাল -->
<div class="modal" id="progressModal">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
        <h2 style="font-size: 18px; margin-top: 0;">ডাটা ইমপোর্ট করা হচ্ছে...</h2>
        <p style="font-size: 14px; color: #6B7280;">অনুগ্রহ করে অপেক্ষা করুন...</p>
        <div style="width: 100%; background-color: #E2E8F0; border-radius: 20px; margin: 15px 0; overflow: hidden;">
            <div id="progressBar" style="width: 0%; height: 10px; background-color: #5A67D8; border-radius: 20px; transition: width 0.3s ease;"></div>
        </div>
        <div id="progress-status-text" style="font-size: 13px; font-weight: 500; color: #4A5568; height: 20px;"></div>
    </div>
</div>

<!-- সফল মডাল -->
<div class="modal" id="successModal">
    <div class="modal-content" style="max-width: 380px; text-align: center;">
        <div style="font-size: 48px; color: #38A169;">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg>
        </div>
        <h2 style="font-size: 18px; margin-top: 10px;">সফল হয়েছে!</h2>
        <p style="font-size: 14px; margin: 10px 0 20px 0;">আপনার ডেটা সফলভাবে ইমপোর্ট করা হয়েছে।</p>
        <button class="btn btn-submit" id="ok-btn" style="background-color: #38A169;">ওকে</button>
    </div>
</div>
<!-- ★★★ নতুন: শুধু এক্সপোর্ট প্রগ্রেস মডাল ★★★ -->
<div class="modal" id="exportProgressModal">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
        <h2 style="font-size: 18px; margin-top: 0;">ব্যাকআপ প্রস্তুত করা হচ্ছে...</h2>
        <p style="font-size: 14px; color: #6B7280;">প্রক্রিয়া শুরু হচ্ছে...</p>
        <div style="width: 100%; background-color: #E2E8F0; border-radius: 20px; margin: 15px 0; overflow: hidden;">
            <div id="export-progress-bar" style="width: 0%; height: 10px; background-color: #22c55e; border-radius: 20px; transition: width 0.3s ease;"></div>
        </div>
        <div id="export-progress-status" style="font-size: 13px; font-weight: 500; color: #4A5568; height: 20px;"></div>
    </div>
</div>

</body>

</html>
